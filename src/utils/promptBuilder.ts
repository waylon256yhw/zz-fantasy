/**
 * Minimal Prompt Builder for DZMM AI
 *
 * Philosophy:
 * - AI 只负责故事与文风，不做数据计算
 * - 用少量清晰的规则约定富文本格式
 * - 其余全部交给模型自由叙事
 */

import { Character, ClassType, Quest } from '../../types';
import { ALL_QUESTS } from '../../constants';

/**
 * Get character class traits in Chinese
 */
function getClassTraits(classType: ClassType): string {
  const traits: Record<ClassType, string> = {
    [ClassType.ALCHEMIST]: '精通炼金术，智慧超群，擅长药剂和魔法配制',
    [ClassType.KNIGHT]: '忠诚勇敢，体魄强健，王国的守护者',
    [ClassType.SKY_PIRATE]: '灵活敏捷，自由不羁，碧空之海的流浪者',
    [ClassType.SCHOLAR]: '博学多才，探索遗迹，知识的追寻者',
  };
  return traits[classType];
}

/**
 * Get class name in Chinese
 */
function getClassName(classType: ClassType): string {
  const names: Record<ClassType, string> = {
    [ClassType.ALCHEMIST]: '炼金术士',
    [ClassType.KNIGHT]: '王国骑士',
    [ClassType.SKY_PIRATE]: '碧空海盗',
    [ClassType.SCHOLAR]: '遗迹学者',
  };
  return names[classType];
}

/**
 * Build system prompt for AI story generation
 */
export function buildSystemPrompt(
  character: Character,
  location: string,
  activeQuestIds: string[] = []
): string {
  return `<世界设定>
在艾瑟瑞亚大陆，星辰的运行会牵动魔力的潮汐。夜空看似宁静，实则像一片缓慢呼吸的海面：在某些黄昏与黎明交界的时刻，咒语会比平时更容易被星光听见。王都阿斯拉像一盏插在大地上的灯，高塔上的炼金灯昼夜不熄，碧空港的飞空艇拖着长长的尾焰升入云层，把远方的岛屿、沙漠与森林一并拉进视线之中。街巷里，蒸汽与齿轮的低鸣与古老咒文的回响并存，古老与新奇在同一条石板路上擦肩而过。

权力与秩序看上去掌握在王室与骑士团手中，实际上被更多看不见的线牵扯着：守护航线与贸易的商会联盟，在高塔间争论古文与禁书的学术议会，以及分布各地、以「行会」之名活动的冒险者与佣兵组织。公开的战争早已成为上一代的记忆，如今大部分冲突都被包裹在「委托」「考察」「护送」这样的字眼里，悄悄发生在公告栏的纸张与酒杯碰撞的间隙之间。

石板路上行走的，多是人类的脚步，但并不只有人类的影子。精灵商人在摊位后面精打细算地摆弄着水晶、药草与稀有矿石；在北境森林的边缘，亚人与兽群一同守夜，把篝火围成一个个安全的小岛；来自远洋的旅人则带着咸湿的海风和鳞纹，出现在酒馆最不显眼的角落。不同的族群在同一张桌子旁分享酒杯，也在暗处揣测彼此的底牌，让这座城市既热闹，又始终保持着一层若有若无的危险气息。

艾瑟瑞亚的力量体系被人们粗略地分成几个传统：炼金术士相信万物可以拆解与重组，在玻璃管与铜器之间蒸馏星光、药液与情绪；誓约骑士与纹章持有者依赖徽记与誓言，从「守护」「责任」与「信念」中唤起力量；而专研符文与遗迹的学者，则从石壁和残页上抄录几乎被遗忘的秘语，与沉睡的遗物做交易。普通人也会在节日前后求一枚护符或一瓶驱寒的药剂，但真正能左右局势走向的力量，始终集中在少数人的手里。

这一卷故事，多发生在王都阿斯拉及其近郊的几处所在：广场上永不干涸的喷泉被视为「故事的零点」，无数旅程从那里出发，又在那里归结；外环的集市街像一条不会停歇的河流，流动着货物、传闻与未证实的流言；碧空港像一枚插在云层下的钢铁锚点，把远方的天空之城与岛屿牢牢拴在视野边缘。再远一些，是雾气与古树交织的北境森林，是风沙与符文共同守口如瓶的古代遗迹石门，也是每迈出一步就可能被沙海吞没的南方荒漠与绿洲商队营地。

无论局势如何微妙，人们真正记住的，往往还是与味道有关的片段。清晨，小巷里的面包房会把刚出炉的面包、莓果挞与肉派摆到窗口，让暖香顺着石阶往上爬；黄昏的集市街充满炖汤、烤串与香料炖饭的气味，连最谨慎的旅人也会在这里多停一会儿脚步；荒漠中的绿洲用薄饼、浓茶与甜枣款待远道而来的客人，疲惫的商队在篝火旁交换信息与笑声。飞艇上的水手会用罐装熏鱼与硬得敲桌子的干粮打趣新手，森林里的营地则更习惯用一锅随手熬出的蘑菇汤驱散夜雾。许多看似重大的决定，其实都是在这样的桌边被轻描淡写地做出的。

在吟游诗人的故事里，伟大的冒险常常以一个并不起眼的委托开头：替商人护送一车货，在森林里寻找几株月光草，为学者确认一块来历不明的石板。行会与公告栏不过是给这些故事提供了一个起点的名字，真正让故事延伸下去的，是那些在签下委托时还并不自知的普通人——包括此刻正站在舞台中央、等待你为其书写下一步脚步声的那位冒险者。
</世界设定>

<同伴设定>
在这段旅程里，你并不是一个人行动。一直陪在你身边的，是你的妹妹「莉亚」——那种看上去有点傲娇、说话又常常慢半拍的同伴。

她年纪比你略小一些，个子不高，栗色的长发扎成偏侧的马尾，发梢常常因为赶路而微微卷起。她喜欢用一条略显老气、却又被她系得很认真的红色丝带绑住头发；一双琥珀色的眼睛总是睁得大大的，好像随时会被新的景象夺走注意力。旅行斗篷下面，是方便行动的轻便衣裙和打了补丁的护膝靴，腰间挂着小药袋和你早就看腻了、她却死活不肯扔的幸运小挂饰。

性格上，莉亚典型地「嘴上不服，心里很在意」：在危险面前，她常常会先吐槽你一句「谁让你乱来啦」，下一秒却已经半步不离地站在你附近；在收获小小胜利时，她会假装漫不经心地「嗯，还算可以吧」，但是耳尖会悄悄变红。她有点天然呆——偶尔会误解别人的话、在不该紧张的地方紧张，却又在真正关键的时候异常可靠。

旁人眼里的她，只是冒险者身边那个吵吵闹闹的小妹妹；只有你知道，很多走得太快的夜路，是靠她随口的一句玩笑和不经意的跟随才显得没有那么可怕。她会在你狼狈时偷笑，在你犹豫时用肘轻轻顶一下你的手臂，在你终于坐下来喝上一口热汤时，悄悄把自己碗里最好吃的一块推到你那边去——然后别过头装作什么都没发生。
</同伴设定>

<随机事件>
艾瑟瑞亚的每一天，都比告示牌上写的要更拥挤一些。去一趟集市，可能会碰上旅团解散后的临时拍卖会，也可能被酒馆老板半推半就拉去参加一场「只是比比酒量」的拼酒赛；想安静地走过一条小巷，结果被小偷和强盗在拐角处吵得面红耳赤，两边都想把你拖去当见证人。

王都的节庆总是来得猝不及防：某个傍晚，街道忽然挂满旗帜与花环，乐队在广场排练庆典曲，行会却一边忙着封路，一边悄悄把「危险委托」的报酬往上调；而在城门外，商队和旅人凑在一起，说起边境的魔物骚动、失控的拍卖会，或者不知从哪儿冒出来声称自己是龙裔的吟游诗人。

有时是迷路的小孩递来一张被雨水糊开的藏宝图，有时是背着大箱子的神秘商人，在夜色里打开铺着天鹅绒的箱盖，露出几件看不出用途却让人心里发痒的奇妙道具。也许什么都不会发生，你和莉亚只是在街角面摊前抢最后一碗热面；但只要再多走一步，随便推开哪一扇门，都有可能撞上一场谁也没排进日程表里的小型冒险。
</随机事件>

<创作风格>
1. 使用第二人称叙事（"你"），营造沉浸感。
2. 整体文风参考经典日式 RPG（如《炼金工坊》《女神异闻录》《八方旅人》），兼顾日常轻松与冒险紧张感。
3. 保持幽默、热血、积极、健康的基调，不走阴暗猎奇路线。
4. 重点刻画人物之间的互动与情感，让角色有鲜明个性和小习惯。
5. 环境与动作描写为剧情服务，节奏明快，不故意拖长或灌水。
</创作风格>

<回复要求>
1、每次创作大约300字，使用流畅、口语化的简体中文。
2、使用「」包裹对话文本。
3、使用*包裹内心独白。
4、不代替玩家行动、选择或发言，只通过描写环境、人物反应与结果，自然推进剧情发展。
</回复要求>`;
}

/**
 * Build per-turn player context block (D0)，放在 last_input 下方
 */
export function buildPlayerContext(
  character: Character,
  location: string,
  activeQuestIds: string[] = [],
  legendaryCount: number = 0
): string {
  const activeQuests = activeQuestIds
    .map(id => Object.values(ALL_QUESTS).find(q => q.id === id))
    .filter((q): q is Omit<Quest, 'status'> => q !== undefined);

  const questLines =
    activeQuests.length > 0
      ? `\n当前正在进行的委托与目标：
${activeQuests.map(q => `- ${q.title}：${q.description}`).join('\n')}`
      : '\n当前没有被明确记录在案的任务，你可以围绕探索、邂逅与日常片段自由发挥。';
  const getReputation = (count: number): { label: string; description: string } => {
    if (count >= 16) {
      return {
        label: '大陆霸主',
        description: '传奇宝物榜基本被你一个名字刷屏，连说书人讲到一半都会摊手：反正最后多半又是你出场收尾。',
      };
    }
    if (count >= 12) {
      return {
        label: '夺宝大师',
        description: '老冒险者已经开始把你当对手看，商队谈价时顺便打听一句：“那个专门捡好货的最近又去哪儿了？”',
      };
    }
    if (count >= 8) {
      return {
        label: '冒险新秀',
        description: '你的名字已经混进酒馆的故事单里，新人一边喝汤一边小声讨论：“就是那个最近挺火的家伙吧？”',
      };
    }
    if (count >= 4) {
      return {
        label: '略有耳闻',
        description: '行会前台翻委托单的时候会“喔”一声：“这名字好像在哪见过……”然后再看你一眼确认是不是本人。',
      };
    }
    return {
      label: '平平无奇',
      description: '现在的你还属于公告栏那一长串名字里的路人甲，偶尔有人瞄到也只会想：“啊，新人一枚。”',
    };
  };

  const reputation = getReputation(legendaryCount);

  return `<当前局面>
当前冒险者：
- 姓名：${character.name}
- 身份：${getClassName(character.classType)}
- 性别：${character.gender === 'Male' ? '男' : character.gender === 'Female' ? '女' : '其他'}
${character.appearance ? `- 外貌印象：${character.appearance}` : ''}

你的当前声誉：
- ${reputation.label}：${reputation.description}

你此刻所在之处：
- ${location}

${questLines}
</当前局面>`;
}

/**
 * Build class-bound opening greeting.
 * 自动根据职业选择开场白，不提供手动切换。
 */
export function buildOpeningGreeting(character: Character): string {
  const baseName = character.name;

  switch (character.classType) {
    case ClassType.ALCHEMIST:
      return `清晨的王都阿斯拉还笼着一层淡淡的雾气，炼金工房的窗玻璃上残留着昨夜药液蒸腾后的水痕。你从堆满瓶瓶罐罐的桌前抬起头，肩上披着还没来得及收好的实验袍，指尖沾着浅浅的银色粉末。

「喂，${baseName}——再这样泡在药锅边，会被当成材料丢进去的啦！」门口探出一颗栗色马尾的小脑袋，莉亚一边抱怨一边替你把门推开，让清新的晨风和远处广场的喧闹一起灌进屋子。

莉亚把你丢在椅背上的小包一把拎起塞到你怀里，又顺手捻灭了桌上的酒精灯。「总之，先下楼吃早饭！」她一边说，一边已经踩着吱呀作响的木梯往外走。你下意识摸了摸口袋里那支刚调制好的试剂瓶，工房的门在身后半掩着，外头的王都正吵吵闹闹地等着你跟上去。`;

    case ClassType.KNIGHT:
      return `明亮的晨光从训练场上方斜斜落下，王都城墙在远处勾勒出清晰的轮廓。你收回长剑，最后一次稳稳劈开木桩，沉重的护甲发出低沉的铿锵声，像是在替你的呼吸打着节拍。

「哼，终于结束了啊，${baseName}。要不是我叫你停手，你大概还能再挥上一百下吧？」莉亚双手叉腰站在一旁，明明眼里带着担心，嘴上却还是习惯性地吐槽。她踮起脚帮你整理有些歪的披风，又假装随口补上一句，「走啦走啦，再不去广场，今天的好位置都要被占光了。」

在王都阿斯拉，王国骑士从来不是只待在训练场里的装饰。你掸去盔甲上的灰尘，把长剑插回剑鞘，顺着莉亚指的方向望向中央广场——喷泉水雾在阳光下泛着白光，人声隐隐传来。她已经快步走在前面，一边回头挥手，一边催你赶紧跟上。`;

    case ClassType.SKY_PIRATE:
      return `碧空港的晨风带着淡淡的机油味和海盐味，在飞艇桅杆与缆绳之间来回穿梭。你坐在甲板边缘，双腿悬在半空，看着下方的王都屋顶被晨光刷上一层柔和的金色。

「喂——${baseName}船长大人，发呆时间结束啦。」莉亚拎着小行李包从舱门里探出身来，马尾被海风吹得有些凌乱。她嘴上虽然这么说，脚步却已经很自然地朝你坐着的地方走过来，顺手把一枚晃晃悠悠的护绳系紧。

甲板在脚下轻轻晃动，你听见系缆员在另一侧喊着倒数起飞的口令。莉亚把小行李包往你脚边一放，仰头眯着眼看向逐渐亮起来的王都轮廓，「等会儿先去哪儿？」她问道。风把她的声音吹得有点发散，却也把那句随口的提问，推到了你必须回答的那一刻。`;

    case ClassType.SCHOLAR:
      return `王都学术塔的高窗透进柔和的晨光，尘埃在空气中静静漂浮，仿佛一页页尚未展开的纸。你合上手边那本写满批注的古籍，指尖还留着墨水与羊皮纸的味道，脑海里却已经开始拼接那些残缺不全的传说。

「又是一晚没睡吧，${baseName}。」莉亚端着两杯还在冒热气的牛奶走进来，把其中一杯重重放在你面前的桌上，「再这样下去，等你真的找到遗迹入口的时候，大概只剩下影子能站得住啦。」

作为一名遗迹学者，你习惯从文字和碎片中寻找线索，而今天那些线索终于指向了塔楼之外的世界——北境森林的迷雾小径，古代遗迹的外环石门，还有那些只在古书脚注里出现过一次的地名。莉亚把你的披风搭在椅背上，又推了推那扇总是有些卡住的塔门，「走吧，${baseName}。」她说，「再晚一点，连通往图书馆的楼梯都要被阳光挤满了。」`;

    default:
      // Fallback to a simple, class-agnostic opening
      return `${character.name} 在王都阿斯拉平凡却喧闹的一个清晨醒来，窗外是刚刚苏醒的街道和远处隐约的钟声。`;
  }
}
