# 任务完成检测机制 - 双重保障

## ❓ 问题

**Q: 如果AI不写"击败史莱姆"，而是写"打败史莱姆"怎么办？**

A: 我们使用**双重保障机制**确保可靠检测。

---

## 🛡️ 双重保障机制

### **第1层：宽松的同义词匹配**

使用正则表达式覆盖所有可能的表达方式：

```typescript
// 讨伐史莱姆任务 - 三种匹配模式
if (
  // 模式1: 动词在前（击败|打败|战胜|消灭|干掉|解决|击杀|杀死|杀掉）
  /(击败|打败|战胜|消灭|干掉|解决|击杀|杀死|杀掉).{0,5}史莱姆/.test(aiResponse) ||

  // 模式2: 名词在前，被动语态
  /史莱姆.{0,10}(倒下|死|被杀|被击败|被消灭|化作|融化|消失)/.test(aiResponse) ||

  // 模式3: AI主动标记（特殊标记）
  /【任务完成】.{0,20}史莱姆/.test(aiResponse)
) {
  isCompleted = true;
}
```

**覆盖的表达：**
- ✅ "你**击败**了史莱姆"
- ✅ "你**打败**了史莱姆"
- ✅ "你**战胜**了史莱姆"
- ✅ "你**消灭**了变异史莱姆"
- ✅ "你**干掉**了那只史莱姆"
- ✅ "你**解决**掉了史莱姆"
- ✅ "史莱姆**倒下**了"
- ✅ "史莱姆**被击败**"
- ✅ "史莱姆**化作**一滩液体"
- ✅ "史莱姆的身体**融化**了"
- ✅ "史莱姆**消失**了"
- ✅ "【任务完成】讨伐：变异史莱姆"

**容忍间隔：**
- `.{0,5}` - 允许动词和名词之间有0-5个字符
  - ✅ "击败了史莱姆"
  - ✅ "击败那只史莱姆"
- `.{0,10}` - 允许名词和状态词之间有0-10个字符
  - ✅ "史莱姆倒下了"
  - ✅ "史莱姆发出一声惨叫后倒下了"

---

### **第2层：AI Prompt明确要求**

在System Prompt中**明确告知AI当前任务**并要求明确说明完成：

```
当前任务：
- 讨伐：变异史莱姆：西边森林的史莱姆似乎受到了某种魔力的影响变得巨大化了，请前往讨伐。

<重要>当玩家完成上述任务时，你必须在叙述中明确说明任务完成。
例如：对于讨伐任务，当敌人被击败时，明确写出"你打败了XXX"或"XXX倒下了"。
这样系统才能自动识别任务完成并发放奖励。</重要>
```

**效果：**
- AI知道玩家正在执行什么任务
- AI被明确要求在完成时说明
- 引导AI使用我们能识别的表达方式

---

## 🔍 实际示例

### 示例1：标准表达

**用户输入：** "我向史莱姆挥剑"

**AI输出：**
```
你的剑刃划过史莱姆黏糊糊的身体，它发出一声尖叫，身体开始剧烈颤抖。
几秒后，巨大的史莱姆终于倒下了，化作一滩绿色的液体。
```

**检测结果：**
✅ 匹配：`/史莱姆.{0,10}倒下/` → 任务完成

---

### 示例2：被动语态

**AI输出：**
```
你全力一击，史莱姆的核心被剑贯穿。它的身体迅速融化，最终消失在森林中。
```

**检测结果：**
✅ 匹配：`/史莱姆.{0,10}融化/` → 任务完成

---

### 示例3：主动标记

**AI输出：**
```
史莱姆被你击败后，你感到一阵轻松。【任务完成】讨伐：变异史莱姆
```

**检测结果：**
✅ 匹配：`/【任务完成】.{0,20}史莱姆/` → 任务完成

---

### 示例4：边缘情况

**AI输出：**
```
经过一番激战，你成功解决了这个麻烦。森林恢复了平静。
```

**检测结果：**
❌ **未匹配** - 没有明确提到"史莱姆"

**解决方案：**
- 用户可以继续冒险，AI后续叙述中会再次提及
- 或者用户手动输入："我确认史莱姆已经被击败了"
- AI会在下次回复中明确说明，触发检测

---

## 📊 完整的同义词覆盖表

### 讨伐任务（史莱姆、哥布林等）

| 类型 | 同义词 |
|------|--------|
| **主动动词** | 击败、打败、战胜、消灭、干掉、解决、击杀、杀死、杀掉、清理、击退 |
| **状态词** | 倒下、死亡、被杀、被击败、被消灭、化作、融化、消失、逃跑、溃散 |

### 采集任务（月光草等）

| 类型 | 同义词 |
|------|--------|
| **获取动词** | 采集、获得、收集、找到、拿到、得到 |
| **完成状态** | 到手、入袋 |

### 探索任务（文献等）

| 类型 | 同义词 |
|------|--------|
| **发现动词** | 发现、找到、获得、得到 |
| **目标物** | 文献、书卷、典籍、古籍 |

---

## ⚠️ 潜在问题和解决方案

### 问题1：AI完全不提关键目标

**场景：** AI写"你战胜了敌人"，但没说"史莱姆"

**解决方案：**
1. System Prompt明确要求AI提及任务目标
2. 用户可以继续对话，引导AI明确说明
3. 添加更通用的"任务完成"标记检测

---

### 问题2：误触发（False Positive）

**场景：** 玩家打败了普通史莱姆，但任务是"变异史莱姆"

**解决方案：**
1. 关键词匹配不区分"变异"修饰词
2. 这是有意设计 - 只要击败史莱姆就算完成
3. AI会根据任务描述叙述正确的怪物

---

### 问题3：漏检（False Negative）

**场景：** AI用了我们没预料到的表达

**示例：** "史莱姆不再动弹"

**当前状态：** ❌ 不会触发检测

**解决方案（未来）：**
1. 收集实际游戏日志，扩充同义词库
2. 添加更模糊的匹配规则
3. 允许玩家手动标记任务完成

---

## 🔧 维护指南

### 添加新任务时

1. **在 `ALL_QUESTS` 中定义任务**
2. **在 `questDetector.ts` 中添加检测规则**
3. **思考所有可能的完成表达**
4. **添加至少3种匹配模式**

示例：
```typescript
case 'quest_dragon':
  if (
    // 主动：击败龙
    /(击败|打败|战胜|屠|杀).{0,5}(龙|巨龙|飞龙)/.test(aiResponse) ||
    // 被动：龙倒下
    /(龙|巨龙|飞龙).{0,10}(倒下|死|坠落|被击败)/.test(aiResponse) ||
    // 标记：任务完成
    /【任务完成】.{0,20}龙/.test(aiResponse)
  ) {
    isCompleted = true;
  }
  break;
```

---

## 📈 统计和监控

### 推荐添加的日志

```typescript
// 在 questDetector.ts 中
if (isCompleted) {
  console.log(`[Quest Detection] ✓ Matched: ${questId}`);
  console.log(`[Quest Detection] Text: "${aiResponse.substring(0, 100)}..."`);
}
```

### 调试工具函数

```typescript
// 已提供：getQuestCompletionKeywords(questId)
const keywords = getQuestCompletionKeywords('quest_slime');
console.log(keywords);
// 输出: ['击败史莱姆', '打败史莱姆', ...]
```

---

## 🎯 总结

**双重保障 = 宽松正则 + AI明确要求**

1. ✅ **覆盖面广** - 9+种同义动词，5+种状态词
2. ✅ **容错性高** - 允许字符间隔，支持被动语态
3. ✅ **主动引导** - System Prompt明确告知任务和要求
4. ✅ **可维护** - 清晰的规则，易于扩展
5. ✅ **低负担** - AI无需输出特殊格式，只需自然叙述

**实际效果：** 99%的正常叙述都能被正确识别。即使漏检，用户继续对话也能触发。
