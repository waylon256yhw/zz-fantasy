# æç¤ºè¯å·¥ç¨‹æ–‡æ¡£

> **æ–‡æ¡£ç›®çš„ï¼š** æä¾›å®Œæ•´çš„ AI æç¤ºè¯æ¨¡æ¿åº“ï¼Œæ‰€æœ‰æ¨¡æ¿å¯ç›´æ¥å¤åˆ¶åˆ° React é¡¹ç›®ä¸­ä½¿ç”¨ã€‚
>
> **æºä»£ç å‚è€ƒï¼š** `/root/zz-fantasy/alpinejs/fantasy.html` (4814è¡Œ)

---

## ğŸ“‘ ç›®å½•

1. [æç¤ºè¯æ¶æ„æ¦‚è§ˆ](#1-æç¤ºè¯æ¶æ„æ¦‚è§ˆ)
2. [AI è§’è‰²å®šä¹‰å’Œæç¤ºè¯æ¨¡æ¿](#2-ai-è§’è‰²å®šä¹‰å’Œæç¤ºè¯æ¨¡æ¿)
3. [ç»“æ„åŒ–è¾“å‡ºæ ¼å¼è§„èŒƒ](#3-ç»“æ„åŒ–è¾“å‡ºæ ¼å¼è§„èŒƒ)
4. [åŒæ¨¡å‹åä½œæ¨¡å¼](#4-åŒæ¨¡å‹åä½œæ¨¡å¼)
5. [ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥](#5-ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥)
6. [å®Œæ•´å¯å¤ç”¨æ¨¡æ¿åº“](#6-å®Œæ•´å¯å¤ç”¨æ¨¡æ¿åº“)
7. [å¸¸é‡å’Œé…ç½®](#7-å¸¸é‡å’Œé…ç½®)
8. [React ä¸­ä½¿ç”¨æç¤ºè¯](#8-react-ä¸­ä½¿ç”¨æç¤ºè¯)
9. [æœ€ä½³å®è·µ](#9-æœ€ä½³å®è·µ)

---

## 1. æç¤ºè¯æ¶æ„æ¦‚è§ˆ

### 1.1 äº”ç§ AI è§’è‰²

åŸ Alpine.js å®ç°å®šä¹‰äº† **5 ç§ AI è§’è‰²**ï¼Œæ¯ç§è§’è‰²æ‰¿æ‹…ä¸åŒèŒè´£ï¼š

| è§’è‰² | å®šä½ | ä½¿ç”¨æ¨¡å‹ | è¾“å‡ºæ ¼å¼ | è°ƒç”¨åœºæ™¯ |
|------|------|---------|---------|---------|
| **å™äº‹è€…** | å¥‡å¹»RPGæ¸¸æˆçš„å™äº‹è€… | storyModel | çº¯æ–‡æœ¬ï¼ˆåˆ†æ®µï¼‰ | æ•…äº‹ç”Ÿæˆã€å¯¹è¯ç”Ÿæˆ |
| **æ•°æ®åˆ†æå™¨** | æ¸¸æˆæ•°æ®åˆ†æå™¨ | responseModel | `###DATA` + `###NEW` | æ•°æ®è§£æã€çŠ¶æ€æ›´æ–° |
| **ä»»åŠ¡å‘å¸ƒå‘˜** | å†’é™©è€…å…¬ä¼šä»»åŠ¡å‘å¸ƒå‘˜ | responseModel | XML æ ‡ç­¾ | ä»»åŠ¡åˆ—è¡¨ã€ä»»åŠ¡è¯¦æƒ… |
| **ä»»åŠ¡å®¡æ ¸å‘˜** | å†’é™©è€…å…¬ä¼šä»»åŠ¡å®¡æ ¸å‘˜ | responseModel | `###RESULT` | ä»»åŠ¡åˆ¤å®š |
| **ç»˜å›¾æç¤ºè¯ç”Ÿæˆå™¨** | ä¸“ä¸šAIè‰ºæœ¯æç¤ºè¯ç”Ÿæˆå™¨ | responseModel | `###PROMPT` | ä¸­è‹±æ–‡è½¬æ¢ |

### 1.2 åŒæ¨¡å‹åä½œæµç¨‹

```
ç”¨æˆ·è¡ŒåŠ¨
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­£æ–‡æ¨¡å‹           â”‚
â”‚  (storyModel)       â”‚
â”‚  ç”Ÿæˆæ•…äº‹å™äº‹        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    æ•…äº‹æ–‡æœ¬ (ç«‹å³æ˜¾ç¤º)
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å“åº”æ¨¡å‹           â”‚
â”‚  (responseModel)    â”‚
â”‚  è§£ææ•°æ®å’ŒçŠ¶æ€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    æ¸¸æˆæ•°æ®æ›´æ–°
           â†“
    ä¿å­˜åˆ° chat å†å²
```

### 1.3 ç»“æ„åŒ–è¾“å‡ºæ ¼å¼æ±‡æ€»

| æ ¼å¼æ ‡è®° | ç”¨é€” | åŒ…å«å†…å®¹ | è§£ææ–¹å¼ |
|---------|------|---------|---------|
| `###DATA...###END` | æ¸¸æˆæ•°æ®å˜åŒ– | 11ä¸ªå­—æ®µï¼ˆHP/MP/é‡‘å¸/ç»éªŒç­‰ï¼‰ | é€è¡Œ split(':') |
| `###NEW...###END` | è‡ªå®šä¹‰å†…å®¹ | ç‰©å“/æ•Œäºº/è£…å¤‡ï¼ˆé€—å·åˆ†éš”ï¼‰ | split(',') è§£æ |
| `<quest>...</quest>` | ä»»åŠ¡ä¿¡æ¯ | XMLæ ¼å¼çš„ä»»åŠ¡æ•°æ® | æ­£åˆ™æˆ– DOMParser |
| `<description>` | ä»»åŠ¡æè¿° | çº¯æ–‡æœ¬ | æ­£åˆ™æå– |
| `###PROMPT...###END` | ç»˜å›¾æç¤ºè¯ | è‹±æ–‡å…³é”®è¯ | æ­£åˆ™æå– |
| `###RESULT...###END` | ä»»åŠ¡åˆ¤å®š | å®Œæˆåº¦+åŸå›  | é€è¡Œ split(':') |

---

## 2. AI è§’è‰²å®šä¹‰å’Œæç¤ºè¯æ¨¡æ¿

### 2.1 å™äº‹è€…ï¼ˆStory Generatorï¼‰

#### è§’è‰²å®šä½

- **è§’è‰²ï¼š** å¥‡å¹»RPGæ¸¸æˆçš„å™äº‹è€…
- **èŒè´£ï¼š** ç”Ÿæˆç”ŸåŠ¨çš„æ•…äº‹æ–‡æœ¬
- **ä½¿ç”¨æ¨¡å‹ï¼š** storyModel (Turbo/Medium/Max/XL)
- **è°ƒç”¨ä½ç½®ï¼š** `generateStory()` - è¡Œ 1385-1426
- **è¾“å‡ºé£æ ¼ï¼š** åˆ†æ®µå™äº‹ï¼Œæ¯æ®µ50-100å­—ï¼Œåœºæ™¯ä¸å¯¹è¯åˆ†ç¦»

#### å®Œæ•´æç¤ºè¯æ¨¡æ¿

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 1435-1467

```javascript
`ä½ æ˜¯å¥‡å¹»RPGæ¸¸æˆçš„å™äº‹è€…ï¼Œè´Ÿè´£ç”Ÿæˆç”ŸåŠ¨çš„æ•…äº‹æ–‡æœ¬ã€‚

**å½“å‰çŠ¶æ€**ï¼š
- è§’è‰²ï¼š{{playerName}}ï¼ˆ{{gender}}ï¼Œ{{className}} Lv.{{level}}{{appearance}}ï¼‰
- ä½ç½®ï¼š{{locationName}}
- åœºæ™¯ï¼š{{sceneUrl}}
- HP: {{hp}}/{{maxHp}} | MP: {{mp}}/{{maxMp}}
{{#if inBattle}}
- æˆ˜æ–—ä¸­ï¼š{{enemyName}}ï¼ˆHP: {{enemyHp}}/{{enemyMaxHp}}ï¼‰
{{/if}}

{{#if currentQuest}}
**å½“å‰ä»»åŠ¡ï¼ˆæ‰§è¡Œä¸­ï¼‰**ï¼š
ä»»åŠ¡ï¼š{{questTitle}}
æè¿°ï¼š{{questDescription}}
æ‰§è¡Œæç¤ºï¼š{{questGuide}}

**ä»»åŠ¡å½±å“**ï¼š
- ä½ çš„è¡ŒåŠ¨åº”è¯¥è€ƒè™‘ä»»åŠ¡ç›®æ ‡
- å¦‚æœè¡ŒåŠ¨ä¸ä»»åŠ¡ç›¸å…³ï¼Œè‡ªç„¶åœ°æ¨è¿›ä»»åŠ¡è¿›åº¦
- ä¸è¦å¼ºåˆ¶å®Œæˆä»»åŠ¡ï¼Œè®©ç©å®¶è‡ªä¸»æ¢ç´¢
{{/if}}

**è¡ŒåŠ¨**ï¼š{{action}}
{{#if damage}}- é€ æˆä¼¤å®³ï¼š{{damage}}{{/if}}
{{#if skillName}}- ä½¿ç”¨æŠ€èƒ½ï¼š{{skillName}}{{/if}}
{{#if enemyDamage}}- å—åˆ°ä¼¤å®³ï¼š{{enemyDamage}}{{/if}}

**è¾“å‡ºè¦æ±‚**ï¼š
1. åªè¾“å‡ºæ•…äº‹æ­£æ–‡ï¼Œä¸è¦ä»»ä½•æ ‡è®°ã€æ ¼å¼ã€æ•°æ®
2. å¿…é¡»åˆ†æ®µï¼Œæ¯æ®µ50-100å­—
3. è¯­è¨€ç”ŸåŠ¨ç®€æ´ï¼Œåœºæ™¯æå†™å’Œå¯¹è¯åˆ†å¼€
4. ç”¨ç©ºè¡Œåˆ†éš”æ®µè½

ç›´æ¥å¼€å§‹è®²è¿°æ•…äº‹ï¼š`
```

#### å ä½ç¬¦è¯´æ˜

| å ä½ç¬¦ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|-------|------|------|-------|
| `{{playerName}}` | string | ç©å®¶åå­— | "è‰¾è‰å¨…" |
| `{{gender}}` | string | æ€§åˆ« | "ç”·æ€§" / "å¥³æ€§" |
| `{{className}}` | string | èŒä¸šåç§° | "æ³•å¸ˆ" |
| `{{level}}` | number | ç­‰çº§ | 5 |
| `{{appearance}}` | string | å¤–è§‚æè¿°ï¼ˆå¯é€‰ï¼‰ | "ï¼Œå¤–è§‚ï¼šé“¶è‰²é•¿å‘ï¼Œè“è‰²çœ¼ç›" |
| `{{locationName}}` | string | å½“å‰ä½ç½®åç§° | "è¿·é›¾æ£®æ—" |
| `{{sceneUrl}}` | string | åœºæ™¯å›¾ç‰‡URL | "https://..." |
| `{{hp}}` / `{{maxHp}}` | number | ç”Ÿå‘½å€¼ | 80 / 100 |
| `{{mp}}` / `{{maxMp}}` | number | é­”æ³•å€¼ | 50 / 50 |
| `{{inBattle}}` | boolean | æ˜¯å¦åœ¨æˆ˜æ–—ä¸­ | true / false |
| `{{enemyName}}` | string | æ•Œäººåå­— | "æš—å½±ç‹¼" |
| `{{enemyHp}}` / `{{enemyMaxHp}}` | number | æ•Œäººç”Ÿå‘½å€¼ | 60 / 120 |
| `{{currentQuest}}` | object \| null | å½“å‰ä»»åŠ¡ | Questå¯¹è±¡ æˆ– null |
| `{{questTitle}}` | string | ä»»åŠ¡æ ‡é¢˜ | "æ£®æ—ç‹¼ç¾¤æ¸…ç†" |
| `{{questDescription}}` | string | ä»»åŠ¡æè¿° | "æ¶ˆç­è¿·é›¾æ£®æ—ä¸­çš„3åªé‡ç‹¼" |
| `{{questGuide}}` | string | æ‰§è¡Œæç¤º | "å‰å¾€è¿·é›¾æ£®æ—..." |
| `{{action}}` | string | è¡ŒåŠ¨ç±»å‹ | "attack" / "explore" / "rest" |
| `{{damage}}` | number \| undefined | é€ æˆä¼¤å®³ | 25 |
| `{{skillName}}` | string \| undefined | æŠ€èƒ½åç§° | "ç«çƒæœ¯" |
| `{{enemyDamage}}` | number \| undefined | å—åˆ°ä¼¤å®³ | 10 |

#### React ä½¿ç”¨ç¤ºä¾‹

**æ–‡ä»¶ï¼š** `utils/promptBuilder.ts`

```typescript
export const buildStoryPrompt = (
  gameState: GameState,
  action: string,
  context: ActionContext
): string => {
  const { player, currentEnemy, currentQuest, currentLocation } = gameState;

  const genderText = player.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
  const appearanceText = player.appearance ? `ï¼Œå¤–è§‚ï¼š${player.appearance}` : '';

  let prompt = `ä½ æ˜¯å¥‡å¹»RPGæ¸¸æˆçš„å™äº‹è€…ï¼Œè´Ÿè´£ç”Ÿæˆç”ŸåŠ¨çš„æ•…äº‹æ–‡æœ¬ã€‚

**å½“å‰çŠ¶æ€**ï¼š
- è§’è‰²ï¼š${player.name}ï¼ˆ${genderText}ï¼Œ${player.className} Lv.${player.level}${appearanceText}ï¼‰
- ä½ç½®ï¼š${currentLocation.name}
- åœºæ™¯ï¼š${currentLocation.sceneUrl}
- HP: ${player.hp}/${player.maxHp} | MP: ${player.mp}/${player.maxMp}
`;

  if (gameState.inBattle && currentEnemy) {
    prompt += `- æˆ˜æ–—ä¸­ï¼š${currentEnemy.name}ï¼ˆHP: ${currentEnemy.hp}/${currentEnemy.maxHp}ï¼‰\n`;
  }

  if (currentQuest && currentQuest.status === 'IN_PROGRESS') {
    prompt += `
**å½“å‰ä»»åŠ¡ï¼ˆæ‰§è¡Œä¸­ï¼‰**ï¼š
ä»»åŠ¡ï¼š${currentQuest.title}
æè¿°ï¼š${currentQuest.description}
æ‰§è¡Œæç¤ºï¼š${currentQuest.guide}

**ä»»åŠ¡å½±å“**ï¼š
- ä½ çš„è¡ŒåŠ¨åº”è¯¥è€ƒè™‘ä»»åŠ¡ç›®æ ‡
- å¦‚æœè¡ŒåŠ¨ä¸ä»»åŠ¡ç›¸å…³ï¼Œè‡ªç„¶åœ°æ¨è¿›ä»»åŠ¡è¿›åº¦
- ä¸è¦å¼ºåˆ¶å®Œæˆä»»åŠ¡ï¼Œè®©ç©å®¶è‡ªä¸»æ¢ç´¢
`;
  }

  prompt += `\n**è¡ŒåŠ¨**ï¼š${action}\n`;
  if (context.damage) prompt += `- é€ æˆä¼¤å®³ï¼š${context.damage}\n`;
  if (context.skillName) prompt += `- ä½¿ç”¨æŠ€èƒ½ï¼š${context.skillName}\n`;
  if (context.enemyDamage) prompt += `- å—åˆ°ä¼¤å®³ï¼š${context.enemyDamage}\n`;

  prompt += `
**è¾“å‡ºè¦æ±‚**ï¼š
1. åªè¾“å‡ºæ•…äº‹æ­£æ–‡ï¼Œä¸è¦ä»»ä½•æ ‡è®°ã€æ ¼å¼ã€æ•°æ®
2. å¿…é¡»åˆ†æ®µï¼Œæ¯æ®µ50-100å­—
3. è¯­è¨€ç”ŸåŠ¨ç®€æ´ï¼Œåœºæ™¯æå†™å’Œå¯¹è¯åˆ†å¼€
4. ç”¨ç©ºè¡Œåˆ†éš”æ®µè½

ç›´æ¥å¼€å§‹è®²è¿°æ•…äº‹ï¼š`;

  return prompt;
};
```

---

### 2.2 æ•°æ®åˆ†æå™¨ï¼ˆData Parserï¼‰

#### è§’è‰²å®šä½

- **è§’è‰²ï¼š** æ¸¸æˆæ•°æ®åˆ†æå™¨
- **èŒè´£ï¼š** ä»æ•…äº‹æ–‡æœ¬ä¸­æå–ç»“æ„åŒ–æ¸¸æˆæ•°æ®
- **ä½¿ç”¨æ¨¡å‹ï¼š** responseModel (Medium/XL æ¨è)
- **è°ƒç”¨ä½ç½®ï¼š** `parseStoryAndUpdate()` - è¡Œ 1486-1726
- **è¾“å‡ºæ ¼å¼ï¼š** `###DATA...###END` + `###NEW...###END`

#### å®Œæ•´æç¤ºè¯æ¨¡æ¿

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 1492-1702

```javascript
`ä½ æ˜¯æ¸¸æˆæ•°æ®åˆ†æå™¨ã€‚è¯·åˆ†ææ•…äº‹æ–‡æœ¬å’Œç”¨æˆ·è¡ŒåŠ¨ï¼Œæå–æ•°æ®å˜åŒ–ã€‚

<current_context>
**ç”¨æˆ·è¡ŒåŠ¨**ï¼š{{userAction}}
**æ•…äº‹æ­£æ–‡**ï¼š
{{storyText}}
</current_context>

<current_data>
HP:{{hp}}/{{maxHp}}
MP:{{mp}}/{{maxMp}}
ç­‰çº§:{{level}}
é‡‘å¸:{{gold}}
ç»éªŒ:{{exp}}/{{expToNext}}
å½“å‰ä½ç½®:{{locationName}}
æˆ˜æ–—çŠ¶æ€:{{battleStatus}}
{{#if inBattle}}å½“å‰æ•Œäºº:{{enemyName}}(HP:{{enemyHp}}/{{enemyMaxHp}}){{/if}}
</current_data>

<known_content>
**å·²çŸ¥ç‰©å“**ï¼š{{knownItems}}
**å·²çŸ¥æ•Œäºº**ï¼š{{knownEnemies}}
**å·²çŸ¥è£…å¤‡**ï¼š{{knownEquipment}}
</known_content>

<rules>
### æ ¸å¿ƒè§„åˆ™
1. **æˆ˜æ–—è§¦å‘åˆ¤å®š**ï¼š
   - åªæœ‰å½“æ•…äº‹æ­£æ–‡ä¸­**æ˜ç¡®æè¿°ç©å®¶é­é‡/è¢«æ”»å‡»/è¿›å…¥æˆ˜æ–—**æ—¶ï¼Œæ‰åˆ¤å®š"æ–°æ•Œäºº"
   - å¦‚æœåªæ˜¯æåˆ°æ•Œäººåå­—ï¼ˆå¦‚"å²è±å§†å¾ˆå¸¸è§"ã€"è´­ä¹°å¯¹æŠ—å·¨å‹èœ˜è››çš„è£…å¤‡"ï¼‰ï¼Œ**ä¸è§¦å‘æˆ˜æ–—**
   - å¦‚æœå½“å‰å·²åœ¨æˆ˜æ–—ä¸­ï¼Œä¸è¦é‡å¤è§¦å‘æ–°æ•Œäºº

2. **æ•°æ®å˜åŒ–åˆ¤å®š**ï¼š
   - HP/MPå˜åŒ–ï¼šåªè®°å½•æ•…äº‹ä¸­**æ˜ç¡®æè¿°**çš„å˜åŒ–ï¼ˆå¦‚"å—åˆ°10ç‚¹ä¼¤å®³"ï¼‰
   - é‡‘å¸å˜åŒ–ï¼šåªè®°å½•æ•…äº‹ä¸­çš„äº¤æ˜“/æ‹¾å–/å¥–åŠ±
   - ç»éªŒå˜åŒ–ï¼šåªè®°å½•æ•…äº‹ä¸­çš„æˆ˜æ–—èƒœåˆ©/ä»»åŠ¡å®Œæˆ
   - **ç­‰çº§å˜åŒ–**ï¼šå¦‚æœæ•…äº‹ä¸­æåˆ°"å‡çº§"ã€"ç­‰çº§æå‡è‡³X"ï¼Œè®°å½•ç­‰çº§å˜åŒ–
   - è£…å¤‡æ›´æ–°ï¼šåªæœ‰æ•…äº‹ä¸­æ˜ç¡®"è£…å¤‡äº†XX"æ‰è®°å½•

3. **è‡ªå®šä¹‰å†…å®¹åˆ›å»ºè§„åˆ™**ï¼š
   - **å¿…é¡»åˆ›å»º**ï¼šæ•…äº‹ä¸­å‡ºç°äº†**å…¨æ–°çš„**ç‰©å“/æ•Œäºº/è£…å¤‡ï¼Œä¸”ä¸åœ¨å·²çŸ¥åˆ—è¡¨ä¸­
   - **ä¸è¦åˆ›å»º**ï¼šå¦‚æœå†…å®¹å·²å­˜åœ¨äºå·²çŸ¥åˆ—è¡¨ä¸­
   - **ç¤ºä¾‹**ï¼š
     * "å‘ç°äº†æœˆå…‰è‰" â†’ æ£€æŸ¥å·²çŸ¥ç‰©å“ â†’ å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºmoonlight_herb
     * "é‡åˆ°äº†å²è±å§†" â†’ æ£€æŸ¥å·²çŸ¥æ•Œäºº â†’ å·²å­˜åœ¨slimeï¼Œä¸åˆ›å»º
     * "å•†äººå‡ºå”®ç«ç„°å‰‘" â†’ æ£€æŸ¥å·²çŸ¥è£…å¤‡ â†’ å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºflame_sword

4. **æˆ˜æ–—ç»“æŸåˆ¤å®š**ï¼š
   - æˆ˜æ–—ç»“æŸï¼šèƒœåˆ© - æ•Œäººè¢«å‡»è´¥
   - æˆ˜æ–—ç»“æŸï¼šé€ƒè·‘ - ç©å®¶æˆåŠŸé€ƒç¦»
   - æˆ˜æ–—ç»“æŸï¼šå¤±è´¥ - ç©å®¶HPå½’é›¶
   - æˆ˜æ–—ç»§ç»­ - æˆ˜æ–—æœªç»“æŸ
</rules>

<output_format>
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼ˆæ¯è¡Œä¸€ä¸ªæ•°æ®ï¼Œç”¨å†’å·åˆ†éš”ï¼‰ï¼š

###DATA
HPå˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
MPå˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
é‡‘å¸å˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
ç»éªŒå˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
ç­‰çº§å˜åŒ–:æ•°å­—ï¼ˆæå‡ç”¨+ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
è·å¾—ç‰©å“:IDæˆ–æ— 
è£…å¤‡æ›´æ–°:IDæˆ–æ— 
æ–°æ•Œäºº:IDæˆ–æ— 
ä½ç½®å˜åŒ–:IDæˆ–æ— 
NPCåå­—:åå­—æˆ–æ— 
æˆ˜æ–—ç»“æŸ:èƒœåˆ©/é€ƒè·‘/å¤±è´¥/ç»§ç»­
###END

###NEW
ç‰©å“:ID,åå­—,emoji,ç±»å‹,æ•ˆæœ,æ•°å€¼,æè¿°
æ•Œäºº:ID,åå­—,emoji,HP,æ”»å‡»,é˜²å¾¡,ç»éªŒ,é‡‘å¸,æè¿°
è£…å¤‡:ID,åå­—,emoji,ç±»å‹,æ”»å‡»,é˜²å¾¡,æè¿°
###END

**æ³¨æ„**ï¼š
- å¦‚æœæ²¡æœ‰å¯¹åº”å˜åŒ–ï¼Œå¡«"0"æˆ–"æ— "
- å¦‚æœæ•…äº‹ä¸­çš„å†…å®¹å·²åœ¨å·²çŸ¥åˆ—è¡¨ä¸­ï¼ŒNEWåŒºåŸŸå¡«"æ— "
- IDå‘½åï¼šè‹±æ–‡+ä¸‹åˆ’çº¿ï¼Œå¦‚moonlight_herb
</output_format>

<examples>
**ç¤ºä¾‹1ï¼šæˆ˜æ–—åœºæ™¯**
ç”¨æˆ·è¡ŒåŠ¨ï¼šæ™®é€šæ”»å‡»
æ•…äº‹æ­£æ–‡ï¼šä½ æŒ¥èµ·é•¿å‰‘ï¼Œå‰‘åˆƒåˆ’è¿‡æš—å½±ç‹¼çš„èº«èº¯ã€‚ç‹¼å‘å‡ºä¸€å£°æƒ¨å«ï¼Œå—åˆ°äº†25ç‚¹ä¼¤å®³ï¼å®ƒæ„¤æ€’åœ°åå‡»ï¼Œåˆ©çˆªåˆ’ä¼¤äº†ä½ çš„æ‰‹è‡‚ï¼Œä½ å—åˆ°äº†10ç‚¹ä¼¤å®³ã€‚

è¾“å‡ºï¼š
###DATA
HPå˜åŒ–:-10
MPå˜åŒ–:0
é‡‘å¸å˜åŒ–:0
ç»éªŒå˜åŒ–:0
ç­‰çº§å˜åŒ–:0
è·å¾—ç‰©å“:æ— 
è£…å¤‡æ›´æ–°:æ— 
æ–°æ•Œäºº:æ— 
ä½ç½®å˜åŒ–:æ— 
NPCåå­—:æ— 
æˆ˜æ–—ç»“æŸ:ç»§ç»­
###END

###NEW
ç‰©å“:æ— 
æ•Œäºº:æ— 
è£…å¤‡:æ— 
###END

---

**ç¤ºä¾‹2ï¼šæ¢ç´¢å‘ç°æ–°ç‰©å“**
ç”¨æˆ·è¡ŒåŠ¨ï¼šæ¢ç´¢æ£®æ—
æ•…äº‹æ­£æ–‡ï¼šä½ åœ¨æ£®æ—æ·±å¤„å‘ç°äº†ä¸€æ ªå‘å…‰çš„æœˆå…‰è‰ã€‚è¿™æ˜¯ä¸€ç§ç¨€æœ‰çš„é­”æ³•æ¤ç‰©ï¼Œå¯ä»¥æ¢å¤å¤§é‡é­”æ³•å€¼ã€‚ä½ å°å¿ƒç¿¼ç¿¼åœ°é‡‡é›†äº†å®ƒã€‚

è¾“å‡ºï¼š
###DATA
HPå˜åŒ–:0
MPå˜åŒ–:0
é‡‘å¸å˜åŒ–:0
ç»éªŒå˜åŒ–:0
ç­‰çº§å˜åŒ–:0
è·å¾—ç‰©å“:moonlight_herb
è£…å¤‡æ›´æ–°:æ— 
æ–°æ•Œäºº:æ— 
ä½ç½®å˜åŒ–:æ— 
NPCåå­—:æ— 
æˆ˜æ–—ç»“æŸ:ç»§ç»­
###END

###NEW
ç‰©å“:moonlight_herb,æœˆå…‰è‰,ğŸŒ¿,consumable,restore_mp,80,æœˆå…‰ä¸‹ç”Ÿé•¿çš„ç¥ç§˜è‰è¯ï¼Œå¯æ¢å¤å¤§é‡é­”æ³•å€¼
æ•Œäºº:æ— 
è£…å¤‡:æ— 
###END

---

**ç¤ºä¾‹3ï¼šæˆ˜æ–—èƒœåˆ©å¹¶å‡çº§**
ç”¨æˆ·è¡ŒåŠ¨ï¼šä½¿ç”¨æŠ€èƒ½ç«çƒæœ¯
æ•…äº‹æ­£æ–‡ï¼šä½ åŸå”±å’’è¯­ï¼Œä¸€é¢—å·¨å¤§çš„ç«çƒå‘¼å•¸è€Œå‡ºï¼Œç›´å‡»æš—å½±ç‹¼ï¼æš—å½±ç‹¼å“€åšä¸€å£°ï¼Œå€’åœ°ä¸èµ·ã€‚ä½ å‡»è´¥äº†å®ƒï¼Œè·å¾—äº†50ç‚¹ç»éªŒå’Œ30é‡‘å¸ã€‚å¼ºå¤§çš„åŠ›é‡åœ¨ä½ ä½“å†…æ¶ŒåŠ¨ï¼Œä½ å‡çº§äº†ï¼ç­‰çº§æå‡è‡³6çº§ï¼

è¾“å‡ºï¼š
###DATA
HPå˜åŒ–:0
MPå˜åŒ–:-20
é‡‘å¸å˜åŒ–:+30
ç»éªŒå˜åŒ–:+50
ç­‰çº§å˜åŒ–:+1
è·å¾—ç‰©å“:æ— 
è£…å¤‡æ›´æ–°:æ— 
æ–°æ•Œäºº:æ— 
ä½ç½®å˜åŒ–:æ— 
NPCåå­—:æ— 
æˆ˜æ–—ç»“æŸ:èƒœåˆ©
###END

###NEW
ç‰©å“:æ— 
æ•Œäºº:æ— 
è£…å¤‡:æ— 
###END

---

**ç¤ºä¾‹4ï¼šé‡åˆ°æ–°æ•Œäºº**
ç”¨æˆ·è¡ŒåŠ¨ï¼šæ¢ç´¢æ´ç©´
æ•…äº‹æ­£æ–‡ï¼šä½ æ·±å…¥æ´ç©´ï¼Œçªç„¶å¬åˆ°äº†åˆºè€³çš„å°–å«å£°ã€‚ä¸€åªå·¨å¤§çš„å¸è¡€è™è ä»é˜´æš—å¤„æ‰‘æ¥ï¼Œå¼ å¼€è¡€ç›†å¤§å£ï¼æˆ˜æ–—å¼€å§‹äº†ï¼

è¾“å‡ºï¼š
###DATA
HPå˜åŒ–:0
MPå˜åŒ–:0
é‡‘å¸å˜åŒ–:0
ç»éªŒå˜åŒ–:0
ç­‰çº§å˜åŒ–:0
è·å¾—ç‰©å“:æ— 
è£…å¤‡æ›´æ–°:æ— 
æ–°æ•Œäºº:vampire_bat
ä½ç½®å˜åŒ–:æ— 
NPCåå­—:æ— 
æˆ˜æ–—ç»“æŸ:ç»§ç»­
###END

###NEW
ç‰©å“:æ— 
æ•Œäºº:vampire_bat,å¸è¡€è™è ,ğŸ¦‡,150,30,12,60,45,æ –æ¯åœ¨æ´ç©´æ·±å¤„çš„å‡¶çŒ›æ€ªç‰©
è£…å¤‡:æ— 
###END

---

**ç¤ºä¾‹5ï¼šè´­ä¹°è£…å¤‡ï¼ˆä¸è§¦å‘æˆ˜æ–—ï¼‰**
ç”¨æˆ·è¡ŒåŠ¨ï¼šä¸å•†äººå¯¹è¯
æ•…äº‹æ­£æ–‡ï¼šå•†äººçƒ­æƒ…åœ°å‘ä½ å±•ç¤ºä»–çš„å•†å“ï¼š"è¿™æŠŠç«ç„°ä¹‹å‰‘æ˜¯æˆ‘ä»åŒ—æ–¹å•†é˜Ÿé‚£é‡Œè¿›çš„è´§ï¼Œé™„å¸¦ç«ç„°é­”åŠ›ï¼Œéå¸¸é€‚åˆå¯¹ä»˜å†°éœœæ€ªç‰©ï¼åªè¦300é‡‘å¸ã€‚"ä½ è´­ä¹°äº†ç«ç„°ä¹‹å‰‘å¹¶è£…å¤‡ä¸Šäº†ã€‚

è¾“å‡ºï¼š
###DATA
HPå˜åŒ–:0
MPå˜åŒ–:0
é‡‘å¸å˜åŒ–:-300
ç»éªŒå˜åŒ–:0
ç­‰çº§å˜åŒ–:0
è·å¾—ç‰©å“:æ— 
è£…å¤‡æ›´æ–°:flame_sword
æ–°æ•Œäºº:æ— 
ä½ç½®å˜åŒ–:æ— 
NPCåå­—:åŒ—æ–¹å•†äºº
æˆ˜æ–—ç»“æŸ:ç»§ç»­
###END

###NEW
ç‰©å“:æ— 
æ•Œäºº:æ— 
è£…å¤‡:flame_sword,ç«ç„°ä¹‹å‰‘,ğŸ”¥,weapon,30,0,é™„å¸¦ç«ç„°é­”åŠ›çš„ä¼ å¥‡æ­¦å™¨
###END
</examples>

ç°åœ¨åˆ†æï¼š`
```

#### å ä½ç¬¦è¯´æ˜

| å ä½ç¬¦ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|-------|------|-------|
| `{{userAction}}` | ç”¨æˆ·è¾“å…¥çš„è¡ŒåŠ¨ | "æ¢ç´¢æ£®æ—" |
| `{{storyText}}` | AIç”Ÿæˆçš„æ•…äº‹æ­£æ–‡ | "ä½ æ·±å…¥è¿·é›¾æ£®æ—..." |
| `{{hp}}` / `{{maxHp}}` | å½“å‰/æœ€å¤§HP | 80 / 100 |
| `{{mp}}` / `{{maxMp}}` | å½“å‰/æœ€å¤§MP | 50 / 50 |
| `{{level}}` | ç­‰çº§ | 5 |
| `{{gold}}` | é‡‘å¸ | 150 |
| `{{exp}}` / `{{expToNext}}` | å½“å‰ç»éªŒ/å‡çº§æ‰€éœ€ | 80 / 100 |
| `{{locationName}}` | ä½ç½®åç§° | "è¿·é›¾æ£®æ—" |
| `{{battleStatus}}` | æˆ˜æ–—çŠ¶æ€ | "æˆ˜æ–—ä¸­" / "éæˆ˜æ–—" |
| `{{inBattle}}` | æ˜¯å¦åœ¨æˆ˜æ–— | true / false |
| `{{enemyName}}` | æ•Œäººåå­— | "æš—å½±ç‹¼" |
| `{{enemyHp}}` / `{{enemyMaxHp}}` | æ•ŒäººHP | 60 / 120 |
| `{{knownItems}}` | å·²çŸ¥ç‰©å“IDåˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰ | "potion, mana_potion, elixir" |
| `{{knownEnemies}}` | å·²çŸ¥æ•ŒäººIDåˆ—è¡¨ | "slime, wolf, goblin" |
| `{{knownEquipment}}` | å·²çŸ¥è£…å¤‡IDåˆ—è¡¨ | "iron_sword, steel_sword" |

#### React ä½¿ç”¨ç¤ºä¾‹

```typescript
export const buildParsePrompt = (
  storyText: string,
  gameState: GameState,
  userAction: string
): string => {
  const { player, currentEnemy, customItems, customEnemies, customEquipment } = gameState;

  const battleStatus = gameState.inBattle ? 'æˆ˜æ–—ä¸­' : 'éæˆ˜æ–—';

  // åˆå¹¶å·²çŸ¥å†…å®¹
  const knownItems = Object.keys(ITEMS).concat(Object.keys(customItems)).join(', ');
  const knownEnemies = Object.keys(ENEMIES).concat(Object.keys(customEnemies)).join(', ');
  const knownEquipment = Object.keys(ITEMS)
    .filter(id => ['weapon', 'armor', 'accessory'].includes(ITEMS[id].type))
    .concat(Object.keys(customEquipment))
    .join(', ');

  return `ä½ æ˜¯æ¸¸æˆæ•°æ®åˆ†æå™¨ã€‚è¯·åˆ†ææ•…äº‹æ–‡æœ¬å’Œç”¨æˆ·è¡ŒåŠ¨ï¼Œæå–æ•°æ®å˜åŒ–ã€‚

<current_context>
**ç”¨æˆ·è¡ŒåŠ¨**ï¼š${userAction}
**æ•…äº‹æ­£æ–‡**ï¼š
${storyText}
</current_context>

<current_data>
HP:${player.hp}/${player.maxHp}
MP:${player.mp}/${player.maxMp}
ç­‰çº§:${player.level}
é‡‘å¸:${player.gold}
ç»éªŒ:${player.exp}/${player.expToNext}
å½“å‰ä½ç½®:${gameState.currentLocation.name}
æˆ˜æ–—çŠ¶æ€:${battleStatus}
${gameState.inBattle && currentEnemy ? `å½“å‰æ•Œäºº:${currentEnemy.name}(HP:${currentEnemy.hp}/${currentEnemy.maxHp})` : ''}
</current_data>

<known_content>
**å·²çŸ¥ç‰©å“**ï¼š${knownItems}
**å·²çŸ¥æ•Œäºº**ï¼š${knownEnemies}
**å·²çŸ¥è£…å¤‡**ï¼š${knownEquipment}
</known_content>

<rules>
### æ ¸å¿ƒè§„åˆ™
1. **æˆ˜æ–—è§¦å‘åˆ¤å®š**ï¼š
   - åªæœ‰å½“æ•…äº‹æ­£æ–‡ä¸­**æ˜ç¡®æè¿°ç©å®¶é­é‡/è¢«æ”»å‡»/è¿›å…¥æˆ˜æ–—**æ—¶ï¼Œæ‰åˆ¤å®š"æ–°æ•Œäºº"
   - å¦‚æœåªæ˜¯æåˆ°æ•Œäººåå­—ï¼ˆå¦‚"å²è±å§†å¾ˆå¸¸è§"ã€"è´­ä¹°å¯¹æŠ—å·¨å‹èœ˜è››çš„è£…å¤‡"ï¼‰ï¼Œ**ä¸è§¦å‘æˆ˜æ–—**
   - å¦‚æœå½“å‰å·²åœ¨æˆ˜æ–—ä¸­ï¼Œä¸è¦é‡å¤è§¦å‘æ–°æ•Œäºº

2. **æ•°æ®å˜åŒ–åˆ¤å®š**ï¼š
   - HP/MPå˜åŒ–ï¼šåªè®°å½•æ•…äº‹ä¸­**æ˜ç¡®æè¿°**çš„å˜åŒ–ï¼ˆå¦‚"å—åˆ°10ç‚¹ä¼¤å®³"ï¼‰
   - é‡‘å¸å˜åŒ–ï¼šåªè®°å½•æ•…äº‹ä¸­çš„äº¤æ˜“/æ‹¾å–/å¥–åŠ±
   - ç»éªŒå˜åŒ–ï¼šåªè®°å½•æ•…äº‹ä¸­çš„æˆ˜æ–—èƒœåˆ©/ä»»åŠ¡å®Œæˆ
   - **ç­‰çº§å˜åŒ–**ï¼šå¦‚æœæ•…äº‹ä¸­æåˆ°"å‡çº§"ã€"ç­‰çº§æå‡è‡³X"ï¼Œè®°å½•ç­‰çº§å˜åŒ–
   - è£…å¤‡æ›´æ–°ï¼šåªæœ‰æ•…äº‹ä¸­æ˜ç¡®"è£…å¤‡äº†XX"æ‰è®°å½•

3. **è‡ªå®šä¹‰å†…å®¹åˆ›å»ºè§„åˆ™**ï¼š
   - **å¿…é¡»åˆ›å»º**ï¼šæ•…äº‹ä¸­å‡ºç°äº†**å…¨æ–°çš„**ç‰©å“/æ•Œäºº/è£…å¤‡ï¼Œä¸”ä¸åœ¨å·²çŸ¥åˆ—è¡¨ä¸­
   - **ä¸è¦åˆ›å»º**ï¼šå¦‚æœå†…å®¹å·²å­˜åœ¨äºå·²çŸ¥åˆ—è¡¨ä¸­

4. **æˆ˜æ–—ç»“æŸåˆ¤å®š**ï¼š
   - æˆ˜æ–—ç»“æŸï¼šèƒœåˆ© - æ•Œäººè¢«å‡»è´¥
   - æˆ˜æ–—ç»“æŸï¼šé€ƒè·‘ - ç©å®¶æˆåŠŸé€ƒç¦»
   - æˆ˜æ–—ç»“æŸï¼šå¤±è´¥ - ç©å®¶HPå½’é›¶
   - æˆ˜æ–—ç»§ç»­ - æˆ˜æ–—æœªç»“æŸ
</rules>

<output_format>
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼ˆæ¯è¡Œä¸€ä¸ªæ•°æ®ï¼Œç”¨å†’å·åˆ†éš”ï¼‰ï¼š

###DATA
HPå˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
MPå˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
é‡‘å¸å˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
ç»éªŒå˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
ç­‰çº§å˜åŒ–:æ•°å­—ï¼ˆæå‡ç”¨+ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
è·å¾—ç‰©å“:IDæˆ–æ— 
è£…å¤‡æ›´æ–°:IDæˆ–æ— 
æ–°æ•Œäºº:IDæˆ–æ— 
ä½ç½®å˜åŒ–:IDæˆ–æ— 
NPCåå­—:åå­—æˆ–æ— 
æˆ˜æ–—ç»“æŸ:èƒœåˆ©/é€ƒè·‘/å¤±è´¥/ç»§ç»­
###END

###NEW
ç‰©å“:ID,åå­—,emoji,ç±»å‹,æ•ˆæœ,æ•°å€¼,æè¿°
æ•Œäºº:ID,åå­—,emoji,HP,æ”»å‡»,é˜²å¾¡,ç»éªŒ,é‡‘å¸,æè¿°
è£…å¤‡:ID,åå­—,emoji,ç±»å‹,æ”»å‡»,é˜²å¾¡,æè¿°
###END

**æ³¨æ„**ï¼š
- å¦‚æœæ²¡æœ‰å¯¹åº”å˜åŒ–ï¼Œå¡«"0"æˆ–"æ— "
- å¦‚æœæ•…äº‹ä¸­çš„å†…å®¹å·²åœ¨å·²çŸ¥åˆ—è¡¨ä¸­ï¼ŒNEWåŒºåŸŸå¡«"æ— "
- IDå‘½åï¼šè‹±æ–‡+ä¸‹åˆ’çº¿ï¼Œå¦‚moonlight_herb
</output_format>

ç°åœ¨åˆ†æï¼š`;
};
```

---

### 2.3 ä»»åŠ¡å‘å¸ƒå‘˜ï¼ˆQuest Generatorï¼‰

#### è§’è‰²å®šä½

- **è§’è‰²ï¼š** å†’é™©è€…å…¬ä¼šçš„ä»»åŠ¡å‘å¸ƒå‘˜
- **èŒè´£ï¼š** ç”Ÿæˆç¬¦åˆå†’é™©è€…ç­‰çº§çš„ä»»åŠ¡åˆ—è¡¨å’Œè¯¦æƒ…
- **ä½¿ç”¨æ¨¡å‹ï¼š** responseModel
- **è¾“å‡ºæ ¼å¼ï¼š** XML æ ‡ç­¾

#### 2.3.1 ä»»åŠ¡åˆ—è¡¨ç”Ÿæˆæ¨¡æ¿

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 1905-1964

```javascript
`ä½ æ˜¯å†’é™©è€…å…¬ä¼šçš„ä»»åŠ¡å‘å¸ƒå‘˜ã€‚è¯·ä¸º{{adventurerRank}}çº§å†’é™©è€…ç”Ÿæˆ5ä¸ªä¸åŒç±»å‹çš„ä»»åŠ¡ã€‚

<current_context>
å†’é™©è€…ç­‰çº§ï¼š{{adventurerRank}}çº§ï¼ˆ{{rankName}}ï¼‰
å½“å‰ä½ç½®ï¼š{{locationName}}
ç©å®¶ç­‰çº§ï¼š{{playerLevel}}
ç©å®¶èŒä¸šï¼š{{className}}
</current_context>

<quest_types>
âš”ï¸ è®¨ä¼ä»»åŠ¡ï¼šæ¶ˆç­æŒ‡å®šæ€ªç‰©
ğŸ›¡ï¸ æŠ¤é€ä»»åŠ¡ï¼šä¿æŠ¤ç›®æ ‡å®‰å…¨æŠµè¾¾
ğŸŒ¿ é‡‡é›†ä»»åŠ¡ï¼šæ”¶é›†æŒ‡å®šç‰©å“
ğŸ§¹ æ¸…æ‰«ä»»åŠ¡ï¼šæ¸…ç†æŒ‡å®šåŒºåŸŸ
ğŸ“¦ è¿é€ä»»åŠ¡ï¼šè¿é€ç‰©å“åˆ°ç›®çš„åœ°
ğŸ” è°ƒæŸ¥ä»»åŠ¡ï¼šè°ƒæŸ¥ç‰¹å®šäº‹ä»¶
ğŸ’Š æ•‘æ´ä»»åŠ¡ï¼šæ•‘åŠ©è¢«å›°äººå‘˜
</quest_types>

<difficulty_config>
{{adventurerRank}}çº§ä»»åŠ¡å¥–åŠ±èŒƒå›´ï¼š{{minReward}}-{{maxReward}}é‡‘å¸
å†’é™©è€…ç»éªŒå¥–åŠ±ï¼š{{expReward}}ç‚¹
</difficulty_config>

<exclude_list>
{{#if hasExcluded}}
ä»¥ä¸‹ä»»åŠ¡IDå·²ç”Ÿæˆè¿‡ï¼Œä¸è¦é‡å¤ï¼š{{excludedQuestIds}}
{{else}}
æ— æ’é™¤é¡¹
{{/if}}
</exclude_list>

<output_format>
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹XMLæ ¼å¼è¾“å‡º5ä¸ªä»»åŠ¡ï¼š

<quest>
<id>ä»»åŠ¡IDï¼ˆè‹±æ–‡+ä¸‹åˆ’çº¿ï¼Œå¦‚hunt_wolves_forestï¼‰</id>
<type>ä»»åŠ¡ç±»å‹ï¼ˆhunt/escort/gather/clean/delivery/investigate/rescueä¹‹ä¸€ï¼‰</type>
<title>ä»»åŠ¡æ ‡é¢˜ï¼ˆ15å­—å†…ï¼‰</title>
<brief>ç®€è¦æè¿°ï¼ˆ30å­—å†…ï¼‰</brief>
<goldReward>é‡‘å¸å¥–åŠ±ï¼ˆæ•°å­—ï¼Œåœ¨é…ç½®èŒƒå›´å†…ï¼‰</goldReward>
</quest>

**è¦æ±‚**ï¼š
1. 5ä¸ªä»»åŠ¡ç±»å‹å¿…é¡»ä¸åŒ
2. ä»»åŠ¡IDä¸å¾—ä¸æ’é™¤åˆ—è¡¨é‡å¤
3. ä»»åŠ¡éš¾åº¦ç¬¦åˆ{{adventurerRank}}çº§å†’é™©è€…
4. ä»»åŠ¡å†…å®¹ä¸å½“å‰ä½ç½®ã€èŒä¸šç›¸å…³
5. æ ‡é¢˜å¸å¼•äººï¼Œç®€è¦æè¿°æ¸…æ™°
</output_format>

<examples>
<quest>
<id>hunt_slimes_forest</id>
<type>hunt</type>
<title>æ£®æ—å²è±å§†æ¸…ç†</title>
<brief>æ¶ˆç­è¿·é›¾æ£®æ—ä¸­çš„5åªå²è±å§†</brief>
<goldReward>120</goldReward>
</quest>

<quest>
<id>escort_merchant_town</id>
<type>escort</type>
<title>æŠ¤é€å•†äººå›åŸ</title>
<brief>ä¿æŠ¤å•†äººå®‰å…¨è¿”å›æ–°æ‰‹æ‘</brief>
<goldReward>180</goldReward>
</quest>
</examples>

ç°åœ¨å¼€å§‹ç”Ÿæˆï¼š`
```

**å ä½ç¬¦è¯´æ˜ï¼š**

| å ä½ç¬¦ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|-------|------|-------|
| `{{adventurerRank}}` | å†’é™©è€…ç­‰çº§ | "C" |
| `{{rankName}}` | ç­‰çº§åç§° | "Cçº§å†’é™©è€…" |
| `{{locationName}}` | å½“å‰ä½ç½® | "æ–°æ‰‹æ‘" |
| `{{playerLevel}}` | ç©å®¶ç­‰çº§ | 5 |
| `{{className}}` | èŒä¸š | "æ³•å¸ˆ" |
| `{{minReward}}` / `{{maxReward}}` | å¥–åŠ±èŒƒå›´ | 200 / 600 |
| `{{expReward}}` | ç»éªŒå¥–åŠ± | 80 |
| `{{hasExcluded}}` | æ˜¯å¦æœ‰æ’é™¤é¡¹ | true / false |
| `{{excludedQuestIds}}` | å·²ç”Ÿæˆçš„ä»»åŠ¡ID | "hunt_wolves, escort_merchant" |

#### 2.3.2 ä»»åŠ¡è¯¦æƒ…ç”Ÿæˆæ¨¡æ¿

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 2028-2059

```javascript
`ä½ æ˜¯å†’é™©è€…å…¬ä¼šçš„ä»»åŠ¡å‘å¸ƒå‘˜ã€‚è¯·ä¸ºä»¥ä¸‹ä»»åŠ¡ç”Ÿæˆè¯¦ç»†ä»‹ç»ã€‚

<quest_basic>
ä»»åŠ¡IDï¼š{{questId}}
ä»»åŠ¡ç±»å‹ï¼š{{questTypeName}}
ä»»åŠ¡æ ‡é¢˜ï¼š{{questTitle}}
ç®€è¦æè¿°ï¼š{{questBrief}}
</quest_basic>

<output_format>
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

<description>
ä»»åŠ¡çš„è¯¦ç»†èƒŒæ™¯å’Œè¦æ±‚ï¼ˆ100-200å­—ï¼Œè®²è¿°ä»»åŠ¡æ¥æºã€ç›®æ ‡ã€æ³¨æ„äº‹é¡¹ï¼‰
</description>

<guide>
æ‰§è¡Œæç¤ºï¼ˆ50å­—å†…ï¼Œå‘Šè¯‰ç©å®¶å¦‚ä½•å®Œæˆä»»åŠ¡ï¼Œå¦‚"å‰å¾€è¿·é›¾æ£®æ—ï¼Œæ¶ˆç­5åªå²è±å§†åè¿”å›å…¬ä¼š"ï¼‰
</guide>
</output_format>

<example>
<description>
æœ€è¿‘è¿·é›¾æ£®æ—ä¸­çš„å²è±å§†æ•°é‡æ¿€å¢ï¼Œå¨èƒåˆ°äº†é™„è¿‘æ‘æ°‘çš„å®‰å…¨ã€‚æ‘é•¿å§”æ‰˜å…¬ä¼šæ´¾é£å†’é™©è€…å‰å¾€æ¸…ç†ã€‚å²è±å§†è™½ç„¶æ”»å‡»åŠ›ä¸å¼ºï¼Œä½†æ•°é‡ä¼—å¤šï¼Œè¯·åŠ¡å¿…å°å¿ƒã€‚å®Œæˆä»»åŠ¡åï¼Œæ‘æ°‘ä»¬ä¼šéå¸¸æ„Ÿæ¿€ã€‚
</description>

<guide>
å‰å¾€è¿·é›¾æ£®æ—ï¼Œæ¶ˆç­5åªå²è±å§†ï¼Œç„¶åè¿”å›å…¬ä¼šæäº¤ä»»åŠ¡
</guide>
</example>

ç°åœ¨ç”Ÿæˆï¼š`
```

#### React ä½¿ç”¨ç¤ºä¾‹

```typescript
// utils/questPrompts.ts

export const buildQuestListPrompt = (gameState: GameState): string => {
  const { adventurerRank, adventurerExp, player, currentLocation, generatedQuestIds } = gameState;

  const rankInfo = ADVENTURER_RANKS[adventurerRank];
  const difficultyConfig = QUEST_DIFFICULTY[adventurerRank];

  const questTypes = Object.values(QUEST_TYPES)
    .map(t => `${t.icon} ${t.name}ï¼š${t.desc}`)
    .join('\n');

  const excludeSection = generatedQuestIds.length > 0
    ? `ä»¥ä¸‹ä»»åŠ¡IDå·²ç”Ÿæˆè¿‡ï¼Œä¸è¦é‡å¤ï¼š${generatedQuestIds.join(', ')}`
    : 'æ— æ’é™¤é¡¹';

  return `ä½ æ˜¯å†’é™©è€…å…¬ä¼šçš„ä»»åŠ¡å‘å¸ƒå‘˜ã€‚è¯·ä¸º${adventurerRank}çº§å†’é™©è€…ç”Ÿæˆ5ä¸ªä¸åŒç±»å‹çš„ä»»åŠ¡ã€‚

<current_context>
å†’é™©è€…ç­‰çº§ï¼š${adventurerRank}çº§ï¼ˆ${rankInfo.name}ï¼‰
å½“å‰ä½ç½®ï¼š${currentLocation.name}
ç©å®¶ç­‰çº§ï¼š${player.level}
ç©å®¶èŒä¸šï¼š${player.className}
</current_context>

<quest_types>
${questTypes}
</quest_types>

<difficulty_config>
${adventurerRank}çº§ä»»åŠ¡å¥–åŠ±èŒƒå›´ï¼š${difficultyConfig.minReward}-${difficultyConfig.maxReward}é‡‘å¸
å†’é™©è€…ç»éªŒå¥–åŠ±ï¼š${difficultyConfig.expReward}ç‚¹
</difficulty_config>

<exclude_list>
${excludeSection}
</exclude_list>

<output_format>
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹XMLæ ¼å¼è¾“å‡º5ä¸ªä»»åŠ¡ï¼š

<quest>
<id>ä»»åŠ¡IDï¼ˆè‹±æ–‡+ä¸‹åˆ’çº¿ï¼Œå¦‚hunt_wolves_forestï¼‰</id>
<type>ä»»åŠ¡ç±»å‹ï¼ˆhunt/escort/gather/clean/delivery/investigate/rescueä¹‹ä¸€ï¼‰</type>
<title>ä»»åŠ¡æ ‡é¢˜ï¼ˆ15å­—å†…ï¼‰</title>
<brief>ç®€è¦æè¿°ï¼ˆ30å­—å†…ï¼‰</brief>
<goldReward>é‡‘å¸å¥–åŠ±ï¼ˆæ•°å­—ï¼Œåœ¨é…ç½®èŒƒå›´å†…ï¼‰</goldReward>
</quest>

**è¦æ±‚**ï¼š
1. 5ä¸ªä»»åŠ¡ç±»å‹å¿…é¡»ä¸åŒ
2. ä»»åŠ¡IDä¸å¾—ä¸æ’é™¤åˆ—è¡¨é‡å¤
3. ä»»åŠ¡éš¾åº¦ç¬¦åˆ${adventurerRank}çº§å†’é™©è€…
4. ä»»åŠ¡å†…å®¹ä¸å½“å‰ä½ç½®ã€èŒä¸šç›¸å…³
5. æ ‡é¢˜å¸å¼•äººï¼Œç®€è¦æè¿°æ¸…æ™°
</output_format>

ç°åœ¨å¼€å§‹ç”Ÿæˆï¼š`;
};

export const buildQuestDetailPrompt = (quest: QuestBasic): string => {
  return `ä½ æ˜¯å†’é™©è€…å…¬ä¼šçš„ä»»åŠ¡å‘å¸ƒå‘˜ã€‚è¯·ä¸ºä»¥ä¸‹ä»»åŠ¡ç”Ÿæˆè¯¦ç»†ä»‹ç»ã€‚

<quest_basic>
ä»»åŠ¡IDï¼š${quest.id}
ä»»åŠ¡ç±»å‹ï¼š${QUEST_TYPES[quest.type].name}
ä»»åŠ¡æ ‡é¢˜ï¼š${quest.title}
ç®€è¦æè¿°ï¼š${quest.brief}
</quest_basic>

<output_format>
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

<description>
ä»»åŠ¡çš„è¯¦ç»†èƒŒæ™¯å’Œè¦æ±‚ï¼ˆ100-200å­—ï¼Œè®²è¿°ä»»åŠ¡æ¥æºã€ç›®æ ‡ã€æ³¨æ„äº‹é¡¹ï¼‰
</description>

<guide>
æ‰§è¡Œæç¤ºï¼ˆ50å­—å†…ï¼Œå‘Šè¯‰ç©å®¶å¦‚ä½•å®Œæˆä»»åŠ¡ï¼‰
</guide>
</output_format>

<example>
<description>
æœ€è¿‘è¿·é›¾æ£®æ—ä¸­çš„å²è±å§†æ•°é‡æ¿€å¢ï¼Œå¨èƒåˆ°äº†é™„è¿‘æ‘æ°‘çš„å®‰å…¨ã€‚æ‘é•¿å§”æ‰˜å…¬ä¼šæ´¾é£å†’é™©è€…å‰å¾€æ¸…ç†ã€‚å²è±å§†è™½ç„¶æ”»å‡»åŠ›ä¸å¼ºï¼Œä½†æ•°é‡ä¼—å¤šï¼Œè¯·åŠ¡å¿…å°å¿ƒã€‚å®Œæˆä»»åŠ¡åï¼Œæ‘æ°‘ä»¬ä¼šéå¸¸æ„Ÿæ¿€ã€‚
</description>

<guide>
å‰å¾€è¿·é›¾æ£®æ—ï¼Œæ¶ˆç­5åªå²è±å§†ï¼Œç„¶åè¿”å›å…¬ä¼šæäº¤ä»»åŠ¡
</guide>
</example>

ç°åœ¨ç”Ÿæˆï¼š`;
};
```

---

### 2.4 ä»»åŠ¡å®¡æ ¸å‘˜ï¼ˆQuest Judgeï¼‰

#### è§’è‰²å®šä½

- **è§’è‰²ï¼š** å†’é™©è€…å…¬ä¼šçš„ä»»åŠ¡å®¡æ ¸å‘˜
- **èŒè´£ï¼š** æ ¹æ®ç©å®¶æ±‡æŠ¥åˆ¤æ–­ä»»åŠ¡å®Œæˆåº¦
- **ä½¿ç”¨æ¨¡å‹ï¼š** responseModel
- **è¾“å‡ºæ ¼å¼ï¼š** `###RESULT...###END`

#### å®Œæ•´æç¤ºè¯æ¨¡æ¿

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 2180-2213

```javascript
`ä½ æ˜¯å†’é™©è€…å…¬ä¼šçš„ä»»åŠ¡å®¡æ ¸å‘˜ã€‚è¯·æ ¹æ®ç©å®¶çš„æ±‡æŠ¥ï¼Œåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆã€‚

<quest>
ä»»åŠ¡ï¼š{{questTitle}}
ç±»å‹ï¼š{{questTypeName}}
æè¿°ï¼š{{questDescription}}
è¦æ±‚ï¼š{{questGuide}}
</quest>

<player_report>
{{storyContent}}
</player_report>

<rules>
1. æ ¹æ®å¯¹è¯å†…å®¹åˆ¤æ–­ä»»åŠ¡å®Œæˆæƒ…å†µ
2. è®¨ä¼ä»»åŠ¡ï¼šéœ€è¦æ˜ç¡®å‡»è´¥ç›®æ ‡
3. æŠ¤é€ä»»åŠ¡ï¼šéœ€è¦ç›®æ ‡å®‰å…¨æŠµè¾¾
4. é‡‡é›†ä»»åŠ¡ï¼šéœ€è¦æ”¶é›†åˆ°ç‰©å“
5. å…¶ä»–ä»»åŠ¡ï¼šæ ¹æ®æè¿°åˆç†åˆ¤æ–­

åˆ¤æ–­æ ‡å‡†ï¼š
- å®Œå…¨å®Œæˆï¼šç©å®¶æ˜ç¡®å®Œæˆäº†æ‰€æœ‰è¦æ±‚
- éƒ¨åˆ†å®Œæˆï¼šç©å®¶å®Œæˆäº†éƒ¨åˆ†è¦æ±‚
- æœªå®Œæˆï¼šç©å®¶æ²¡æœ‰å®Œæˆè¦æ±‚æˆ–æ²¡æœ‰ç›¸å…³è¡ŒåŠ¨
</rules>

<output_format>
###RESULT
å®Œæˆåº¦:å®Œå…¨å®Œæˆ/éƒ¨åˆ†å®Œæˆ/æœªå®Œæˆ
åŸå› :ç®€è¦è¯´æ˜ï¼ˆ20å­—å†…ï¼‰
###END
</output_format>

ç°åœ¨åˆ¤æ–­ï¼š`
```

**å ä½ç¬¦è¯´æ˜ï¼š**

| å ä½ç¬¦ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|-------|------|-------|
| `{{questTitle}}` | ä»»åŠ¡æ ‡é¢˜ | "æ£®æ—ç‹¼ç¾¤æ¸…ç†" |
| `{{questTypeName}}` | ä»»åŠ¡ç±»å‹åç§° | "è®¨ä¼ä»»åŠ¡" |
| `{{questDescription}}` | ä»»åŠ¡æè¿° | "æœ€è¿‘è¿·é›¾æ£®æ—ä¸­çš„ç‹¼ç¾¤..." |
| `{{questGuide}}` | æ‰§è¡Œæç¤º | "å‰å¾€è¿·é›¾æ£®æ—ï¼Œæ¶ˆç­3åªé‡ç‹¼..." |
| `{{storyContent}}` | ç©å®¶æ±‡æŠ¥å¯¹è¯ | "ä½ å›åˆ°å…¬ä¼šå¤§å…ï¼Œæ¥å¾…å‘˜å¾®ç¬‘ç€..." |

#### React ä½¿ç”¨ç¤ºä¾‹

```typescript
export const buildQuestJudgePrompt = (
  quest: Quest,
  storyContent: string
): string => {
  return `ä½ æ˜¯å†’é™©è€…å…¬ä¼šçš„ä»»åŠ¡å®¡æ ¸å‘˜ã€‚è¯·æ ¹æ®ç©å®¶çš„æ±‡æŠ¥ï¼Œåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆã€‚

<quest>
ä»»åŠ¡ï¼š${quest.title}
ç±»å‹ï¼š${QUEST_TYPES[quest.type].name}
æè¿°ï¼š${quest.description}
è¦æ±‚ï¼š${quest.guide}
</quest>

<player_report>
${storyContent}
</player_report>

<rules>
1. æ ¹æ®å¯¹è¯å†…å®¹åˆ¤æ–­ä»»åŠ¡å®Œæˆæƒ…å†µ
2. è®¨ä¼ä»»åŠ¡ï¼šéœ€è¦æ˜ç¡®å‡»è´¥ç›®æ ‡
3. æŠ¤é€ä»»åŠ¡ï¼šéœ€è¦ç›®æ ‡å®‰å…¨æŠµè¾¾
4. é‡‡é›†ä»»åŠ¡ï¼šéœ€è¦æ”¶é›†åˆ°ç‰©å“
5. å…¶ä»–ä»»åŠ¡ï¼šæ ¹æ®æè¿°åˆç†åˆ¤æ–­

åˆ¤æ–­æ ‡å‡†ï¼š
- å®Œå…¨å®Œæˆï¼šç©å®¶æ˜ç¡®å®Œæˆäº†æ‰€æœ‰è¦æ±‚
- éƒ¨åˆ†å®Œæˆï¼šç©å®¶å®Œæˆäº†éƒ¨åˆ†è¦æ±‚
- æœªå®Œæˆï¼šç©å®¶æ²¡æœ‰å®Œæˆè¦æ±‚æˆ–æ²¡æœ‰ç›¸å…³è¡ŒåŠ¨
</rules>

<output_format>
###RESULT
å®Œæˆåº¦:å®Œå…¨å®Œæˆ/éƒ¨åˆ†å®Œæˆ/æœªå®Œæˆ
åŸå› :ç®€è¦è¯´æ˜ï¼ˆ20å­—å†…ï¼‰
###END
</output_format>

ç°åœ¨åˆ¤æ–­ï¼š`;
};
```

---

### 2.5 ç»˜å›¾æç¤ºè¯ç”Ÿæˆå™¨ï¼ˆPrompt Generatorï¼‰

#### è§’è‰²å®šä½

- **è§’è‰²ï¼š** ä¸“ä¸šAIè‰ºæœ¯æç¤ºè¯ç”Ÿæˆå™¨
- **èŒè´£ï¼š** å°†ä¸­æ–‡åœºæ™¯ä¿¡æ¯è½¬æ¢ä¸ºè‹±æ–‡ Stable Diffusion æç¤ºè¯
- **ä½¿ç”¨æ¨¡å‹ï¼š** responseModel
- **è¾“å‡ºæ ¼å¼ï¼š** `###PROMPT...###END`

#### å®Œæ•´æç¤ºè¯æ¨¡æ¿

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 2900-2919

```javascript
`You are a professional AI art prompt generator. Generate an English prompt for anime-style character illustration based on the following information.

{{sceneInfo}}

Output format:
###PROMPT
[English prompt, comma-separated keywords, max 200 words]
###END

Requirements:
- Only output English prompt, no explanation
- Describe character appearance, clothing, pose, expression
- Describe background and atmosphere
- Use comma-separated keywords
- Focus on visual details

Example:
###PROMPT
1girl, long silver hair, blue eyes, wearing white dress, gentle smile, standing in forest, sunlight filtering through trees, fantasy atmosphere, detailed face, beautiful lighting
###END

ç°åœ¨ç”Ÿæˆï¼š`
```

**åœºæ™¯ä¿¡æ¯æ„å»ºé€»è¾‘** (è¡Œ 2879-2896):

```javascript
buildSceneInfo() {
  let targetInfo = '';

  if (this.artTarget === 'player') {
    const genderText = this.player.gender === 'male' ? 'male' : 'female';
    const appearanceText = this.player.appearance || 'no specific appearance';
    targetInfo = `Character: ${this.player.name}, Gender: ${genderText}, Class: ${this.player.className}, Appearance: ${appearanceText}`;
  } else if (this.artTarget === 'npc' && this.lastNPC) {
    targetInfo = `NPC: ${this.lastNPC}`;
  } else if (this.artTarget === 'enemy' && this.currentEnemy) {
    targetInfo = `Enemy: ${this.currentEnemy.name}`;
  }

  const sceneText = this.storyText.replace(/<[^>]*>/g, '').substring(0, 500);
  const customReq = this.artRequirement || 'no specific requirement';

  return `${targetInfo}\nCurrent scene: ${sceneText}\nCustom requirement: ${customReq}`;
}
```

#### React ä½¿ç”¨ç¤ºä¾‹

```typescript
export const buildSceneInfo = (
  target: 'player' | 'npc' | 'enemy',
  player: Player,
  storyText: string,
  customRequirement?: string,
  npcName?: string,
  enemy?: Enemy
): string => {
  let targetInfo = '';

  if (target === 'player') {
    const genderText = player.gender === 'male' ? 'male' : 'female';
    const appearanceText = player.appearance || 'no specific appearance';
    targetInfo = `Character: ${player.name}, Gender: ${genderText}, Class: ${player.className}, Appearance: ${appearanceText}`;
  } else if (target === 'npc' && npcName) {
    targetInfo = `NPC: ${npcName}`;
  } else if (target === 'enemy' && enemy) {
    targetInfo = `Enemy: ${enemy.name}`;
  }

  const sceneText = storyText.replace(/<[^>]*>/g, '').substring(0, 500);
  const customReq = customRequirement || 'no specific requirement';

  return `${targetInfo}\nCurrent scene: ${sceneText}\nCustom requirement: ${customReq}`;
};

export const buildDrawPromptGeneratorPrompt = (sceneInfo: string): string => {
  return `You are a professional AI art prompt generator. Generate an English prompt for anime-style character illustration based on the following information.

${sceneInfo}

Output format:
###PROMPT
[English prompt, comma-separated keywords, max 200 words]
###END

Requirements:
- Only output English prompt, no explanation
- Describe character appearance, clothing, pose, expression
- Describe background and atmosphere
- Use comma-separated keywords
- Focus on visual details

Example:
###PROMPT
1girl, long silver hair, blue eyes, wearing white dress, gentle smile, standing in forest, sunlight filtering through trees, fantasy atmosphere, detailed face, beautiful lighting
###END

ç°åœ¨ç”Ÿæˆï¼š`;
};
```

---

## 3. ç»“æ„åŒ–è¾“å‡ºæ ¼å¼è§„èŒƒ

### 3.1 ###DATA...###END æ ¼å¼

#### æ ¼å¼å®šä¹‰

```
###DATA
HPå˜åŒ–:+30
MPå˜åŒ–:-20
é‡‘å¸å˜åŒ–:+50
ç»éªŒå˜åŒ–:+100
ç­‰çº§å˜åŒ–:+1
è·å¾—ç‰©å“:moonlight_herb
è£…å¤‡æ›´æ–°:flame_sword
æ–°æ•Œäºº:shadow_wolf
ä½ç½®å˜åŒ–:forest
NPCåå­—:é“åŒ è€æ±¤å§†
æˆ˜æ–—ç»“æŸ:èƒœåˆ©
###END
```

#### å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | å€¼åŸŸ | è¯´æ˜ |
|-------|------|------|------|
| HPå˜åŒ– | number | -999 ~ +999 æˆ– 0 | ç”Ÿå‘½å€¼å˜åŒ–ï¼Œæ­£æ•°æ¢å¤ï¼Œè´Ÿæ•°å—ä¼¤ |
| MPå˜åŒ– | number | -999 ~ +999 æˆ– 0 | é­”æ³•å€¼å˜åŒ–ï¼Œæ­£æ•°æ¢å¤ï¼Œè´Ÿæ•°æ¶ˆè€— |
| é‡‘å¸å˜åŒ– | number | -9999 ~ +9999 æˆ– 0 | é‡‘å¸å˜åŒ–ï¼Œæ­£æ•°è·å¾—ï¼Œè´Ÿæ•°æ”¯å‡º |
| ç»éªŒå˜åŒ– | number | 0 ~ 9999 æˆ– 0 | ç»éªŒå€¼å˜åŒ–ï¼Œåªèƒ½å¢åŠ ä¸èƒ½å‡å°‘ |
| ç­‰çº§å˜åŒ– | number | 0 ~ +10 æˆ– 0 | ç­‰çº§å˜åŒ–ï¼Œé€šå¸¸+1 |
| è·å¾—ç‰©å“ | string | ç‰©å“ID æˆ– "æ— " | è·å¾—çš„ç‰©å“ID |
| è£…å¤‡æ›´æ–° | string | è£…å¤‡ID æˆ– "æ— " | æ›´æ–°çš„è£…å¤‡ID |
| æ–°æ•Œäºº | string | æ•ŒäººID æˆ– "æ— " | è§¦å‘æˆ˜æ–—çš„æ•ŒäººID |
| ä½ç½®å˜åŒ– | string | ä½ç½®ID æˆ– "æ— " | ç§»åŠ¨åˆ°æ–°ä½ç½®çš„ID |
| NPCåå­— | string | NPCåå­— æˆ– "æ— " | å¯¹è¯NPCçš„åå­— |
| æˆ˜æ–—ç»“æŸ | enum | "èƒœåˆ©" / "é€ƒè·‘" / "å¤±è´¥" / "ç»§ç»­" | æˆ˜æ–—çŠ¶æ€ |

#### React è§£æå‡½æ•°

**æ–‡ä»¶ï¼š** `utils/responseParser.ts`

```typescript
export interface GameDataChanges {
  hpChange?: number;
  mpChange?: number;
  goldChange?: number;
  expChange?: number;
  levelChange?: number;
  itemGained?: string;
  equipmentUpdate?: string;
  newEnemy?: string;
  locationChange?: string;
  npcName?: string;
  battleEnd?: 'victory' | 'flee' | 'defeat' | 'continue';
}

export const parseDataBlock = (responseText: string): GameDataChanges => {
  const dataMatch = responseText.match(/###DATA([\s\S]*?)###END/);
  if (!dataMatch) {
    console.warn('[Parser] No DATA block found');
    return {};
  }

  const lines = dataMatch[1].trim().split('\n');
  const changes: GameDataChanges = {};

  lines.forEach(line => {
    const [key, value] = line.split(':').map(s => s.trim());

    switch (key) {
      case 'HPå˜åŒ–':
        if (value !== '0') {
          changes.hpChange = parseInt(value);
        }
        break;

      case 'MPå˜åŒ–':
        if (value !== '0') {
          changes.mpChange = parseInt(value);
        }
        break;

      case 'é‡‘å¸å˜åŒ–':
        if (value !== '0') {
          changes.goldChange = parseInt(value);
        }
        break;

      case 'ç»éªŒå˜åŒ–':
        if (value !== '0') {
          changes.expChange = parseInt(value);
        }
        break;

      case 'ç­‰çº§å˜åŒ–':
        if (value !== '0') {
          changes.levelChange = parseInt(value);
        }
        break;

      case 'è·å¾—ç‰©å“':
        if (value !== 'æ— ') {
          changes.itemGained = value;
        }
        break;

      case 'è£…å¤‡æ›´æ–°':
        if (value !== 'æ— ') {
          changes.equipmentUpdate = value;
        }
        break;

      case 'æ–°æ•Œäºº':
        if (value !== 'æ— ') {
          changes.newEnemy = value;
        }
        break;

      case 'ä½ç½®å˜åŒ–':
        if (value !== 'æ— ') {
          changes.locationChange = value;
        }
        break;

      case 'NPCåå­—':
        if (value !== 'æ— ') {
          changes.npcName = value;
        }
        break;

      case 'æˆ˜æ–—ç»“æŸ':
        if (['èƒœåˆ©', 'é€ƒè·‘', 'å¤±è´¥', 'ç»§ç»­'].includes(value)) {
          const battleEndMap: Record<string, GameDataChanges['battleEnd']> = {
            'èƒœåˆ©': 'victory',
            'é€ƒè·‘': 'flee',
            'å¤±è´¥': 'defeat',
            'ç»§ç»­': 'continue',
          };
          changes.battleEnd = battleEndMap[value];
        }
        break;
    }
  });

  console.log('[Parser] Parsed data changes:', changes);
  return changes;
};
```

---

### 3.2 ###NEW...###END æ ¼å¼

#### æ ¼å¼å®šä¹‰

```
###NEW
ç‰©å“:moonlight_herb,æœˆå…‰è‰,ğŸŒ¿,consumable,restore_mp,80,æœˆå…‰ä¸‹ç”Ÿé•¿çš„ç¥ç§˜è‰è¯
æ•Œäºº:shadow_wolf,æš—å½±ç‹¼,ğŸº,120,25,15,50,40,æ½œä¼åœ¨æš—å¤œæ£®æ—çš„å‡¶çŒ›é‡å…½
è£…å¤‡:flame_sword,ç«ç„°ä¹‹å‰‘,ğŸ”¥,weapon,30,0,é™„å¸¦ç«ç„°é­”åŠ›çš„ä¼ å¥‡æ­¦å™¨
###END
```

#### å­—æ®µè¯´æ˜

**ç‰©å“æ ¼å¼ï¼š** `ç‰©å“:ID,åå­—,emoji,ç±»å‹,æ•ˆæœ,æ•°å€¼,æè¿°`

| ä½ç½® | å­—æ®µå | ç±»å‹ | ç¤ºä¾‹ |
|-----|--------|------|------|
| 1 | ID | string | moonlight_herb |
| 2 | åå­— | string | æœˆå…‰è‰ |
| 3 | emoji | string | ğŸŒ¿ |
| 4 | ç±»å‹ | enum | consumable / material / key |
| 5 | æ•ˆæœ | string | restore_mp / heal / full_heal |
| 6 | æ•°å€¼ | number | 80 |
| 7 | æè¿° | string | æœˆå…‰ä¸‹ç”Ÿé•¿çš„ç¥ç§˜è‰è¯ |

**æ•Œäººæ ¼å¼ï¼š** `æ•Œäºº:ID,åå­—,emoji,HP,æ”»å‡»,é˜²å¾¡,ç»éªŒ,é‡‘å¸,æè¿°`

| ä½ç½® | å­—æ®µå | ç±»å‹ | ç¤ºä¾‹ |
|-----|--------|------|------|
| 1 | ID | string | shadow_wolf |
| 2 | åå­— | string | æš—å½±ç‹¼ |
| 3 | emoji | string | ğŸº |
| 4 | HP | number | 120 |
| 5 | æ”»å‡» | number | 25 |
| 6 | é˜²å¾¡ | number | 15 |
| 7 | ç»éªŒ | number | 50 |
| 8 | é‡‘å¸ | number | 40 |
| 9 | æè¿° | string | æ½œä¼åœ¨æš—å¤œæ£®æ—çš„å‡¶çŒ›é‡å…½ |

**è£…å¤‡æ ¼å¼ï¼š** `è£…å¤‡:ID,åå­—,emoji,ç±»å‹,æ”»å‡»,é˜²å¾¡,æè¿°`

| ä½ç½® | å­—æ®µå | ç±»å‹ | ç¤ºä¾‹ |
|-----|--------|------|------|
| 1 | ID | string | flame_sword |
| 2 | åå­— | string | ç«ç„°ä¹‹å‰‘ |
| 3 | emoji | string | ğŸ”¥ |
| 4 | ç±»å‹ | enum | weapon / armor / accessory |
| 5 | æ”»å‡» | number | 30 |
| 6 | é˜²å¾¡ | number | 0 |
| 7 | æè¿° | string | é™„å¸¦ç«ç„°é­”åŠ›çš„ä¼ å¥‡æ­¦å™¨ |

#### React è§£æå‡½æ•°

```typescript
export interface NewContent {
  items?: CustomItem[];
  enemies?: CustomEnemy[];
  equipment?: CustomEquipment[];
}

export const parseNewContent = (responseText: string): NewContent => {
  const newMatch = responseText.match(/###NEW([\s\S]*?)###END/);
  if (!newMatch) {
    console.warn('[Parser] No NEW block found');
    return {};
  }

  const lines = newMatch[1].trim().split('\n');
  const content: NewContent = {
    items: [],
    enemies: [],
    equipment: [],
  };

  lines.forEach(line => {
    const [key, value] = line.split(':').map(s => s.trim());

    if (key === 'ç‰©å“' && value !== 'æ— ') {
      const parts = value.split(',').map(s => s.trim());
      if (parts.length >= 7) {
        const [id, name, icon, type, effect, val, desc] = parts;
        content.items!.push({
          id,
          name,
          icon,
          type: type as 'consumable' | 'material' | 'key',
          effect,
          value: parseInt(val) || 0,
          desc,
          price: (parseInt(val) || 0) * 2, // è‡ªåŠ¨è®¡ç®—ä»·æ ¼
        });
        console.log(`[Parser] Created item: ${name}`);
      }
    }

    if (key === 'æ•Œäºº' && value !== 'æ— ') {
      const parts = value.split(',').map(s => s.trim());
      if (parts.length >= 9) {
        const [id, name, icon, hp, atk, def, exp, gold, desc] = parts;
        content.enemies!.push({
          id,
          name,
          icon,
          hp: parseInt(hp) || 50,
          atk: parseInt(atk) || 10,
          def: parseInt(def) || 5,
          exp: parseInt(exp) || 30,
          gold: parseInt(gold) || 20,
          desc,
        });
        console.log(`[Parser] Created enemy: ${name}`);
      }
    }

    if (key === 'è£…å¤‡' && value !== 'æ— ') {
      const parts = value.split(',').map(s => s.trim());
      if (parts.length >= 7) {
        const [id, name, icon, type, atk, def, desc] = parts;
        content.equipment!.push({
          id,
          name,
          icon,
          type: type as 'weapon' | 'armor' | 'accessory',
          atk: parseInt(atk) || 0,
          def: parseInt(def) || 0,
          desc,
          price: (parseInt(atk) + parseInt(def)) * 10 || 50,
        });
        console.log(`[Parser] Created equipment: ${name}`);
      }
    }
  });

  return content;
};
```

---

### 3.3 XML æ ¼å¼ï¼ˆä»»åŠ¡ç³»ç»Ÿï¼‰

#### ä»»åŠ¡åˆ—è¡¨æ ¼å¼

```xml
<quest>
<id>hunt_wolves_forest</id>
<type>hunt</type>
<title>æ£®æ—ç‹¼ç¾¤æ¸…ç†</title>
<brief>æ¶ˆç­è¿·é›¾æ£®æ—ä¸­çš„3åªé‡ç‹¼</brief>
<goldReward>150</goldReward>
</quest>
```

#### ä»»åŠ¡è¯¦æƒ…æ ¼å¼

```xml
<description>
æœ€è¿‘è¿·é›¾æ£®æ—ä¸­çš„ç‹¼ç¾¤æ•°é‡æ¿€å¢ï¼Œå¨èƒåˆ°äº†é™„è¿‘å•†é˜Ÿçš„å®‰å…¨ã€‚å•†ä¼šå§”æ‰˜å…¬ä¼šæ´¾é£å†’é™©è€…å‰å¾€æ¸…ç†ã€‚é‡ç‹¼æ”»å‡»åŠ›è¾ƒå¼ºï¼Œå»ºè®®åšå¥½å‡†å¤‡ã€‚
</description>

<guide>
å‰å¾€è¿·é›¾æ£®æ—ï¼Œæ¶ˆç­3åªé‡ç‹¼ï¼Œç„¶åè¿”å›å…¬ä¼šæäº¤ä»»åŠ¡
</guide>
```

#### React è§£æå‡½æ•°

```typescript
export interface QuestBasic {
  id: string;
  type: string;
  title: string;
  brief: string;
  goldReward: number;
}

export const parseQuestList = (responseText: string): QuestBasic[] => {
  const quests: QuestBasic[] = [];

  // æ­£åˆ™æå–æ‰€æœ‰ quest æ ‡ç­¾
  const questRegex = /<quest>[\s\S]*?<id>(.*?)<\/id>[\s\S]*?<type>(.*?)<\/type>[\s\S]*?<title>(.*?)<\/title>[\s\S]*?<brief>(.*?)<\/brief>[\s\S]*?<goldReward>(.*?)<\/goldReward>[\s\S]*?<\/quest>/g;

  let match;
  while ((match = questRegex.exec(responseText)) !== null) {
    quests.push({
      id: match[1].trim(),
      type: match[2].trim(),
      title: match[3].trim(),
      brief: match[4].trim(),
      goldReward: parseInt(match[5]) || 0,
    });
  }

  console.log(`[Parser] Parsed ${quests.length} quests`);
  return quests;
};

export const parseQuestDetails = (responseText: string): {
  description: string;
  guide: string;
} | null => {
  const descMatch = responseText.match(/<description>([\s\S]*?)<\/description>/);
  const guideMatch = responseText.match(/<guide>([\s\S]*?)<\/guide>/);

  if (!descMatch || !guideMatch) {
    console.warn('[Parser] Quest details parsing failed');
    return null;
  }

  return {
    description: descMatch[1].trim(),
    guide: guideMatch[1].trim(),
  };
};
```

---

### 3.4 ###PROMPT...###END æ ¼å¼

#### æ ¼å¼å®šä¹‰

```
###PROMPT
1girl, long silver hair, blue eyes, wearing elegant mage robe, holding magic staff, confident expression, standing in misty forest, glowing magic aura, sunlight filtering through leaves, fantasy atmosphere, detailed face, beautiful lighting, anime style
###END
```

#### React è§£æå‡½æ•°

```typescript
export const parseDrawPrompt = (responseText: string): string | null => {
  const promptMarker = '###PROMPT';
  const endMarker = '###END';

  const promptIndex = responseText.indexOf(promptMarker);
  const endIndex = responseText.indexOf(endMarker, promptIndex + promptMarker.length);

  if (promptIndex === -1 || endIndex === -1) {
    console.warn('[Parser] Draw prompt parsing failed');
    return null;
  }

  const prompt = responseText
    .slice(promptIndex + promptMarker.length, endIndex)
    .trim();

  console.log('[Parser] Parsed draw prompt:', prompt);
  return prompt;
};
```

---

### 3.5 ###RESULT...###END æ ¼å¼

#### æ ¼å¼å®šä¹‰

```
###RESULT
å®Œæˆåº¦:å®Œå…¨å®Œæˆ
åŸå› :æˆåŠŸå‡»è´¥æ‰€æœ‰ç›®æ ‡
###END
```

#### React è§£æå‡½æ•°

```typescript
export type QuestCompletionLevel = 'fully_completed' | 'partially_completed' | 'not_completed';

export interface QuestJudgement {
  completion: QuestCompletionLevel;
  reason: string;
}

export const parseQuestResult = (responseText: string): QuestJudgement => {
  const resultMatch = responseText.match(/å®Œæˆåº¦:(.*?)\n/);
  const reasonMatch = responseText.match(/åŸå› :(.*?)(\n|###END)/);

  const completionText = resultMatch ? resultMatch[1].trim() : 'æœªå®Œæˆ';
  const reason = reasonMatch ? reasonMatch[1].trim() : '';

  const completionMap: Record<string, QuestCompletionLevel> = {
    'å®Œå…¨å®Œæˆ': 'fully_completed',
    'éƒ¨åˆ†å®Œæˆ': 'partially_completed',
    'æœªå®Œæˆ': 'not_completed',
  };

  const completion = completionMap[completionText] || 'not_completed';

  console.log('[Parser] Quest judgement:', { completion, reason });
  return { completion, reason };
};
```

---

## 4. åŒæ¨¡å‹åä½œæ¨¡å¼

### 4.1 æ¨¡å‹èŒè´£åˆ’åˆ†

| æ¨¡å‹ | å˜é‡å | èŒè´£ | æ¨èé…ç½® | è°ƒç”¨åœºæ™¯ |
|------|--------|------|---------|---------|
| **æ­£æ–‡æ¨¡å‹** | `storyModel` | ç”Ÿæˆæ•…äº‹å™äº‹ | Turbo/Medium/Max | æ•…äº‹ç”Ÿæˆã€ä»»åŠ¡å¯¹è¯ |
| **å“åº”æ¨¡å‹** | `responseModel` | è§£ææ•°æ®ã€ç”Ÿæˆç»“æ„åŒ–è¾“å‡º | Medium/XL | æ•°æ®è§£æã€ä»»åŠ¡ç”Ÿæˆã€ä»»åŠ¡åˆ¤å®šã€ç»˜å›¾æç¤ºè¯ |

### 4.2 åä½œæµç¨‹è¯¦è§£

#### Alpine.js åŸå§‹å®ç°

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 1335-1380

```javascript
async requestAI(action, context = {}) {
  this.actionLocked = true;
  this.storyText = '<span class="loading">æ­£åœ¨ç”Ÿæˆæ•…äº‹...</span>';

  try {
    // ===== æ­¥éª¤1ï¼šè°ƒç”¨æ­£æ–‡æ¨¡å‹ç”Ÿæˆå™äº‹ =====
    const storyContent = await this.generateStory(action, context);

    if (!storyContent) {
      throw new Error('æ­£æ–‡ç”Ÿæˆå¤±è´¥');
    }

    // æ˜¾ç¤ºç”Ÿæˆçš„æ­£æ–‡
    this.storyText = storyContent;

    // ===== æ­¥éª¤2ï¼šè°ƒç”¨å“åº”æ¨¡å‹è§£ææ­£æ–‡å¹¶æ›´æ–°æ•°æ® =====
    this.storyText = storyContent + '<br><span class="loading" style="font-size: 12px;">æ­£åœ¨æ›´æ–°æ¸¸æˆæ•°æ®...</span>';

    await this.parseStoryAndUpdate(storyContent, action, context);

    // ç§»é™¤åŠ è½½æç¤º
    this.storyText = storyContent;

    // ===== æ­¥éª¤3ï¼šä¿å­˜åˆ°chatå†å² =====
    await window.dzmm.chat.insert(null, [
      { role: 'user', content: context.userAction },
      { role: 'assistant', content: storyContent }
    ]);

  } catch (error) {
    console.error('AIè¯·æ±‚å¤±è´¥:', error);
    this.storyText = `<p style="color: #ff4444;">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
  } finally {
    this.actionLocked = false;
  }
}
```

#### React å®ç°å»ºè®®

```typescript
// hooks/useGameAction.ts
import { useDZMMContext } from '@/contexts/DZMMContext';
import { useDZMMCompletion } from './useDZMMCompletion';
import { useDZMMChat } from './useDZMMChat';
import { useGameDataParser } from './useGameDataParser';

export const useGameAction = () => {
  const { storyModel, responseModel } = useDZMMContext();
  const { generate: generateStory } = useDZMMCompletion();
  const { parseAndUpdate } = useGameDataParser();
  const { saveMessage } = useDZMMChat();

  const [actionLocked, setActionLocked] = useState(false);
  const [storyText, setStoryText] = useState('');
  const [loadingPhase, setLoadingPhase] = useState<'story' | 'parse' | null>(null);

  const executeAction = async (
    action: string,
    context: ActionContext,
    gameState: GameState
  ) => {
    setActionLocked(true);
    setLoadingPhase('story');
    setStoryText('æ­£åœ¨ç”Ÿæˆæ•…äº‹...');

    try {
      // æ­¥éª¤1: ç”Ÿæˆæ•…äº‹
      const storyPrompt = buildStoryPrompt(gameState, action, context);
      const recentHistory = await getRecentMessages(5);

      const messages = [
        { role: 'user', content: storyPrompt },
        ...recentHistory,
        { role: 'user', content: context.userAction || '' },
      ];

      const storyContent = await generateStory(storyModel, messages, 1000);

      if (!storyContent) {
        throw new Error('æ­£æ–‡ç”Ÿæˆå¤±è´¥');
      }

      // ç«‹å³æ˜¾ç¤ºæ•…äº‹
      setStoryText(storyContent);

      // æ­¥éª¤2: è§£ææ•°æ®
      setLoadingPhase('parse');
      await parseAndUpdate(storyContent, gameState, context.userAction || '');

      // æ­¥éª¤3: ä¿å­˜å†å²
      await saveMessage(context.userAction || '', storyContent);

      setLoadingPhase(null);

    } catch (error) {
      console.error('AIè¯·æ±‚å¤±è´¥:', error);
      setStoryText(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
      setLoadingPhase(null);
    } finally {
      setActionLocked(false);
    }
  };

  return {
    actionLocked,
    storyText,
    loadingPhase,
    executeAction,
  };
};
```

### 4.3 åä½œæµç¨‹ä¼˜åŠ¿

1. **èŒè´£åˆ†ç¦»**ï¼š
   - æ­£æ–‡æ¨¡å‹ä¸“æ³¨äºå™äº‹è´¨é‡
   - å“åº”æ¨¡å‹ä¸“æ³¨äºæ•°æ®å‡†ç¡®æ€§

2. **æµå¼ä½“éªŒ**ï¼š
   - æ•…äº‹ç«‹å³æ˜¾ç¤ºç»™ç”¨æˆ·
   - æ•°æ®è§£æåœ¨åå°è¿›è¡Œ
   - ç”¨æˆ·ä¸éœ€è¦ç­‰å¾…æ•°æ®å¤„ç†å®Œæˆ

3. **å®¹é”™æ€§**ï¼š
   - æ•°æ®è§£æå¤±è´¥ä¸å½±å“æ•…äº‹æ˜¾ç¤º
   - ç”¨æˆ·ä»èƒ½çœ‹åˆ°å®Œæ•´çš„æ•…äº‹æ–‡æœ¬

4. **çµæ´»æ€§**ï¼š
   - å¯ä»¥é€‰æ‹©ä¸åŒæ¨¡å‹ç»„åˆ
   - ä¾‹å¦‚ï¼šæ­£æ–‡ç”¨ XLï¼ˆé«˜è´¨é‡ï¼‰ï¼Œè§£æç”¨ Mediumï¼ˆæˆæœ¬ä½ï¼‰

---

## 5. ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥

### 5.1 å†å²æ¶ˆæ¯é™åˆ¶é…ç½®

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 893

```javascript
const GAME_CONFIG = {
  maxHistoryMessages: 15,     // å…¨å±€å†å²æ¶ˆæ¯æ•°é‡é™åˆ¶ï¼ˆé¿å… token è¶…é™ï¼‰
  baseExpToLevel: 100,
  expGrowthRate: 1.5,
  fleeSuccessRate: 0.6,
  criticalRate: 0.15,
  restHealPercent: 0.3,
  maxSaveSlots: 3,
};
```

**React å®ç°ï¼š**

```typescript
// constants/gameConfig.ts
export const GAME_CONFIG = {
  maxHistoryMessages: 15,    // å…¨å±€é™åˆ¶
  storyHistoryCount: 5,      // æ•…äº‹ç”Ÿæˆç”¨
  questHistoryCount: 3,      // ä»»åŠ¡æäº¤ç”¨
  baseExpToLevel: 100,
  expGrowthRate: 1.5,
  fleeSuccessRate: 0.6,
  criticalRate: 0.15,
  restHealPercent: 0.3,
  maxSaveSlots: 3,
};
```

### 5.2 ä¸Šä¸‹æ–‡ä½¿ç”¨ç­–ç•¥

| åœºæ™¯ | è·å–æ•°é‡ | ä»£ç ä½ç½® | ç”¨é€” |
|------|---------|---------|------|
| æ•…äº‹ç”Ÿæˆ | æœ€è¿‘ 5 æ¡ | è¡Œ 1388-1389 | ä¿è¯å™äº‹è¿è´¯æ€§ |
| ä»»åŠ¡æäº¤ | æœ€è¿‘ 3 æ¡ | è¡Œ 2154 | äº†è§£ç©å®¶è¡ŒåŠ¨ |
| å…¨å±€é™åˆ¶ | æœ€å¤š 15 æ¡ | è¡Œ 893 | é¿å… token è¶…é™ |

**ä»£ç ç¤ºä¾‹ï¼š**

```javascript
// æ•…äº‹ç”Ÿæˆ
const allMessages = await window.dzmm.chat.list();
const recentMessages = allMessages.slice(-5);

// ä»»åŠ¡æäº¤
const recentHistory = await this.getRecentHistory(3);

// å·¥å…·å‡½æ•°
async getRecentHistory(count = 3) {
  const allMessages = await window.dzmm.chat.list();
  return allMessages.slice(-count);
}
```

### 5.3 æ¸¸æˆçŠ¶æ€æ³¨å…¥

#### å½“å‰çŠ¶æ€æ³¨å…¥

```javascript
**å½“å‰çŠ¶æ€**ï¼š
- è§’è‰²ï¼š{{playerName}}ï¼ˆ{{gender}}ï¼Œ{{className}} Lv.{{level}}{{appearance}}ï¼‰
- ä½ç½®ï¼š{{locationName}}
- åœºæ™¯ï¼š{{sceneUrl}}
- HP: {{hp}}/{{maxHp}} | MP: {{mp}}/{{maxMp}}
{{#if inBattle}}
- æˆ˜æ–—ä¸­ï¼š{{enemyName}}ï¼ˆHP: {{enemyHp}}/{{enemyMaxHp}}ï¼‰
{{/if}}
```

#### ä»»åŠ¡çŠ¶æ€æ³¨å…¥

```javascript
{{#if currentQuest}}
**å½“å‰ä»»åŠ¡ï¼ˆæ‰§è¡Œä¸­ï¼‰**ï¼š
ä»»åŠ¡ï¼š{{questTitle}}
æè¿°ï¼š{{questDescription}}
æ‰§è¡Œæç¤ºï¼š{{questGuide}}

**ä»»åŠ¡å½±å“**ï¼š
- ä½ çš„è¡ŒåŠ¨åº”è¯¥è€ƒè™‘ä»»åŠ¡ç›®æ ‡
- å¦‚æœè¡ŒåŠ¨ä¸ä»»åŠ¡ç›¸å…³ï¼Œè‡ªç„¶åœ°æ¨è¿›ä»»åŠ¡è¿›åº¦
- ä¸è¦å¼ºåˆ¶å®Œæˆä»»åŠ¡ï¼Œè®©ç©å®¶è‡ªä¸»æ¢ç´¢
{{/if}}
```

#### å·²çŸ¥å†…å®¹åˆ—è¡¨æ„å»º

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 1511-1515

```javascript
<known_content>
**å·²çŸ¥ç‰©å“**ï¼š${Object.keys(ITEMS).concat(Object.keys(this.customItems)).join(', ')}
**å·²çŸ¥æ•Œäºº**ï¼š${Object.keys(ENEMIES).concat(Object.keys(this.customEnemies)).join(', ')}
**å·²çŸ¥è£…å¤‡**ï¼š${Object.keys(ITEMS).filter(id => ITEMS[id].type === 'weapon' || ITEMS[id].type === 'armor').concat(Object.keys(this.customEquipment)).join(', ')}
</known_content>
```

**React å®ç°ï¼š**

```typescript
const buildKnownContentList = (gameState: GameState): string => {
  const knownItems = [
    ...Object.keys(ITEMS),
    ...Object.keys(gameState.customItems),
  ].join(', ');

  const knownEnemies = [
    ...Object.keys(ENEMIES),
    ...Object.keys(gameState.customEnemies),
  ].join(', ');

  const knownEquipment = [
    ...Object.keys(ITEMS).filter(id =>
      ['weapon', 'armor', 'accessory'].includes(ITEMS[id].type)
    ),
    ...Object.keys(gameState.customEquipment),
  ].join(', ');

  return `<known_content>
**å·²çŸ¥ç‰©å“**ï¼š${knownItems}
**å·²çŸ¥æ•Œäºº**ï¼š${knownEnemies}
**å·²çŸ¥è£…å¤‡**ï¼š${knownEquipment}
</known_content>`;
};
```

### 5.4 ç”¨æˆ·è¡ŒåŠ¨æ ¼å¼åŒ–

**æˆ˜æ–—è¡ŒåŠ¨ï¼š**

```javascript
// æ™®é€šæ”»å‡»
await this.requestAI('attack', {
  damage: 25,
  userAction: 'æ™®é€šæ”»å‡»'
});

// æŠ€èƒ½ä½¿ç”¨
await this.requestAI('use_skill', {
  skillName: 'ç«çƒæœ¯',
  damage: 40,
  userAction: `ä½¿ç”¨æŠ€èƒ½${skill.name}`
});
```

**æ¢ç´¢è¡ŒåŠ¨ï¼š**

```javascript
// è‡ªå®šä¹‰è¾“å…¥
await this.requestAI('custom_action', {
  userAction: this.playerInput  // ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬
});
```

**æç¤ºè¯ä¸­è¡ŒåŠ¨æ³¨å…¥ï¼š**

```javascript
**è¡ŒåŠ¨**ï¼š${action}
${context.damage ? `- é€ æˆä¼¤å®³ï¼š${context.damage}` : ''}
${context.skillName ? `- ä½¿ç”¨æŠ€èƒ½ï¼š${context.skillName}` : ''}
${context.enemyDamage ? `- å—åˆ°ä¼¤å®³ï¼š${context.enemyDamage}` : ''}
```

---

## 6. å®Œæ•´å¯å¤ç”¨æ¨¡æ¿åº“

### 6.1 æ¨¡æ¿ç´¢å¼•

| æ¨¡æ¿ç¼–å· | åç§° | ç”¨é€” | ä»£ç ä½ç½® |
|---------|------|------|---------|
| T1 | æ•…äº‹ç”Ÿæˆæ¨¡æ¿ | ç”Ÿæˆ RPG æ•…äº‹å™äº‹ | è¡Œ 1435-1467 |
| T2 | æ•°æ®è§£ææ¨¡æ¿ | ä»æ•…äº‹ä¸­æå–æ•°æ® | è¡Œ 1492-1702 |
| T3 | ä»»åŠ¡åˆ—è¡¨ç”Ÿæˆæ¨¡æ¿ | ç”Ÿæˆä»»åŠ¡åˆ—è¡¨ | è¡Œ 1905-1964 |
| T4 | ä»»åŠ¡è¯¦æƒ…ç”Ÿæˆæ¨¡æ¿ | ç”Ÿæˆä»»åŠ¡æè¿°å’ŒæŒ‡å¼• | è¡Œ 2028-2059 |
| T5 | ä»»åŠ¡åˆ¤å®šæ¨¡æ¿ | åˆ¤æ–­ä»»åŠ¡å®Œæˆåº¦ | è¡Œ 2180-2213 |
| T6 | ç»˜å›¾æç¤ºè¯æ¨¡æ¿ | ä¸­è‹±æ–‡è½¬æ¢ | è¡Œ 2900-2919 |

### 6.2 ä½¿ç”¨å»ºè®®

æ‰€æœ‰æ¨¡æ¿éƒ½å¯ä»¥ç›´æ¥å¤åˆ¶åˆ° React é¡¹ç›®ä¸­ä½¿ç”¨ï¼Œåªéœ€ï¼š

1. **æ›¿æ¢å ä½ç¬¦**ï¼šç”¨å®é™…çš„æ¸¸æˆçŠ¶æ€æ•°æ®æ›¿æ¢ `{{å˜é‡å}}`
2. **è°ƒæ•´è¾“å‡ºæ ¼å¼**ï¼šæ ¹æ®éœ€è¦ä¿®æ”¹è¾“å‡ºè¦æ±‚
3. **æ·»åŠ ç¤ºä¾‹**ï¼šæ ¹æ®å…·ä½“æ¸¸æˆå†…å®¹å¢åŠ æ›´å¤šç¤ºä¾‹

### 6.3 æ¨¡æ¿ä¼˜åŒ–å»ºè®®

å‚è€ƒåŸ Alpine.js å®ç°ä¸­çš„**æœ€ä½³å®è·µ**ï¼š

1. **æ·»åŠ æ­£åç¤ºä¾‹**ï¼šæ˜ç¡®å‘Šè¯‰ AI ä»€ä¹ˆè¯¥åšã€ä»€ä¹ˆä¸è¯¥åš
2. **ä½¿ç”¨ç»“æ„åŒ–æ ‡è®°**ï¼šç”¨ `###` æˆ– `<xml>` æ ‡è®°æ˜ç¡®è¾“å‡ºæ ¼å¼
3. **æä¾›è¯¦ç»†è§„åˆ™**ï¼šåœ¨ `<rules>` åŒºåŸŸåˆ—å‡ºæ‰€æœ‰åˆ¤å®šè§„åˆ™
4. **é™åˆ¶è¾“å‡ºé•¿åº¦**ï¼šæ˜ç¡®å­—æ•°è¦æ±‚ï¼ˆå¦‚"æ¯æ®µ50-100å­—"ï¼‰
5. **æ£€æŸ¥å·²çŸ¥å†…å®¹**ï¼šæä¾›å·²çŸ¥åˆ—è¡¨ï¼Œé¿å… AI é‡å¤åˆ›å»ºå†…å®¹

---

## 7. å¸¸é‡å’Œé…ç½®

### 7.1 æ¸¸æˆé…ç½®å¸¸é‡

**æ–‡ä»¶ï¼š** `constants/gameConfig.ts`

```typescript
export const GAME_CONFIG = {
  // å†å²æ¶ˆæ¯é™åˆ¶
  maxHistoryMessages: 15,
  storyHistoryCount: 5,
  questHistoryCount: 3,

  // æ¸¸æˆå¹³è¡¡
  baseExpToLevel: 100,
  expGrowthRate: 1.5,
  fleeSuccessRate: 0.6,
  criticalRate: 0.15,
  restHealPercent: 0.3,

  // å­˜æ¡£
  maxSaveSlots: 3,
};
```

### 7.2 å†’é™©è€…ç­‰çº§é…ç½®

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 907-914

```typescript
export const ADVENTURER_RANKS = {
  E: { id: 'E', name: 'Eçº§å†’é™©è€…', color: '#95a5a6', expRequired: 0, questReward: 1.0 },
  D: { id: 'D', name: 'Dçº§å†’é™©è€…', color: '#7f8c8d', expRequired: 100, questReward: 1.2 },
  C: { id: 'C', name: 'Cçº§å†’é™©è€…', color: '#3498db', expRequired: 300, questReward: 1.5 },
  B: { id: 'B', name: 'Bçº§å†’é™©è€…', color: '#9b59b6', expRequired: 600, questReward: 1.8 },
  A: { id: 'A', name: 'Açº§å†’é™©è€…', color: '#e74c3c', expRequired: 1000, questReward: 2.2 },
  S: { id: 'S', name: 'Sçº§å†’é™©è€…', color: '#f39c12', expRequired: 2000, questReward: 3.0 },
};
```

### 7.3 ä»»åŠ¡ç±»å‹é…ç½®

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 917-926

```typescript
export const QUEST_TYPES = {
  hunt: { id: 'hunt', name: 'è®¨ä¼ä»»åŠ¡', icon: 'âš”ï¸', desc: 'æ¶ˆç­æŒ‡å®šæ€ªç‰©' },
  escort: { id: 'escort', name: 'æŠ¤é€ä»»åŠ¡', icon: 'ğŸ›¡ï¸', desc: 'ä¿æŠ¤ç›®æ ‡å®‰å…¨æŠµè¾¾' },
  gather: { id: 'gather', name: 'é‡‡é›†ä»»åŠ¡', icon: 'ğŸŒ¿', desc: 'æ”¶é›†æŒ‡å®šç‰©å“' },
  clean: { id: 'clean', name: 'æ¸…æ‰«ä»»åŠ¡', icon: 'ğŸ§¹', desc: 'æ¸…ç†æŒ‡å®šåŒºåŸŸ' },
  delivery: { id: 'delivery', name: 'è¿é€ä»»åŠ¡', icon: 'ğŸ“¦', desc: 'è¿é€ç‰©å“åˆ°ç›®çš„åœ°' },
  investigate: { id: 'investigate', name: 'è°ƒæŸ¥ä»»åŠ¡', icon: 'ğŸ”', desc: 'è°ƒæŸ¥ç‰¹å®šäº‹ä»¶' },
  rescue: { id: 'rescue', name: 'æ•‘æ´ä»»åŠ¡', icon: 'ğŸ’Š', desc: 'æ•‘åŠ©è¢«å›°äººå‘˜' },
};
```

### 7.4 ä»»åŠ¡éš¾åº¦é…ç½®

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 928-936

```typescript
export const QUEST_DIFFICULTY = {
  E: { minReward: 50, maxReward: 150, expReward: 20 },
  D: { minReward: 100, maxReward: 300, expReward: 40 },
  C: { minReward: 200, maxReward: 600, expReward: 80 },
  B: { minReward: 400, maxReward: 1200, expReward: 150 },
  A: { minReward: 800, maxReward: 2500, expReward: 300 },
  S: { minReward: 1500, maxReward: 5000, expReward: 600 },
};
```

### 7.5 ç»˜å›¾å¸¸é‡

**æºä»£ç ä½ç½®ï¼š** `alpinejs/fantasy.html` è¡Œ 947-948

```typescript
export const QUALITY_TAGS = 'artist:takeuchi_takashi, wanke, rella, (artist:okyou:0.4), (artist:askzy:0.3), (artist:quasarcake:0.3), (artist:wlop:0.3), (artist:nixeu:0.3), masterpiece, best quality, amazing quality, very aesthetic, absurdres, highres, newest, extreme aesthetic, year 2024, year 2023, (Visual impact:1.2), ultra-high resolution, 32K UHD, 6669, GFGoddess, unconventional supreme masterpiece, masterful details, regal atmosphere, high-end texture, fashion photography style, impactful picture, official art, movie perspective';

export const NEGATIVE_PROMPT = 'lowres, bad anatomy, bad hands, text, error, missing fingers, worst quality, low quality, jpeg artifacts, watermark, blurry, multiple views, bad proportions, deformed, ugly, duplicate, mutilated, extra limbs, fused fingers, too many fingers, long neck, cross-eyed';
```

---

## 8. React ä¸­ä½¿ç”¨æç¤ºè¯

### 8.1 æç¤ºè¯æ„å»ºå·¥å…·ç±»

**æ–‡ä»¶ï¼š** `utils/promptBuilder.ts`

```typescript
import { GameState, ActionContext } from '@/types';
import { LOCATIONS, QUEST_STATUS, GAME_CONFIG } from '@/constants';

export class PromptBuilder {
  /**
   * æ„å»ºæ•…äº‹ç”Ÿæˆæç¤ºè¯
   */
  static buildStoryPrompt(
    gameState: GameState,
    action: string,
    context: ActionContext
  ): string {
    const { player, currentEnemy, currentQuest, currentLocation } = gameState;

    const genderText = player.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
    const appearanceText = player.appearance ? `ï¼Œå¤–è§‚ï¼š${player.appearance}` : '';

    let prompt = `ä½ æ˜¯å¥‡å¹»RPGæ¸¸æˆçš„å™äº‹è€…ï¼Œè´Ÿè´£ç”Ÿæˆç”ŸåŠ¨çš„æ•…äº‹æ–‡æœ¬ã€‚

**å½“å‰çŠ¶æ€**ï¼š
- è§’è‰²ï¼š${player.name}ï¼ˆ${genderText}ï¼Œ${player.className} Lv.${player.level}${appearanceText}ï¼‰
- ä½ç½®ï¼š${currentLocation.name}
- åœºæ™¯ï¼š${currentLocation.sceneUrl}
- HP: ${player.hp}/${player.maxHp} | MP: ${player.mp}/${player.maxMp}
`;

    if (gameState.inBattle && currentEnemy) {
      prompt += `- æˆ˜æ–—ä¸­ï¼š${currentEnemy.name}ï¼ˆHP: ${currentEnemy.hp}/${currentEnemy.maxHp}ï¼‰\n`;
    }

    if (currentQuest && currentQuest.status === QUEST_STATUS.IN_PROGRESS) {
      prompt += `
**å½“å‰ä»»åŠ¡ï¼ˆæ‰§è¡Œä¸­ï¼‰**ï¼š
ä»»åŠ¡ï¼š${currentQuest.title}
æè¿°ï¼š${currentQuest.description}
æ‰§è¡Œæç¤ºï¼š${currentQuest.guide}

**ä»»åŠ¡å½±å“**ï¼š
- ä½ çš„è¡ŒåŠ¨åº”è¯¥è€ƒè™‘ä»»åŠ¡ç›®æ ‡
- å¦‚æœè¡ŒåŠ¨ä¸ä»»åŠ¡ç›¸å…³ï¼Œè‡ªç„¶åœ°æ¨è¿›ä»»åŠ¡è¿›åº¦
- ä¸è¦å¼ºåˆ¶å®Œæˆä»»åŠ¡ï¼Œè®©ç©å®¶è‡ªä¸»æ¢ç´¢
`;
    }

    prompt += `\n**è¡ŒåŠ¨**ï¼š${action}\n`;
    if (context.damage) prompt += `- é€ æˆä¼¤å®³ï¼š${context.damage}\n`;
    if (context.skillName) prompt += `- ä½¿ç”¨æŠ€èƒ½ï¼š${context.skillName}\n`;
    if (context.enemyDamage) prompt += `- å—åˆ°ä¼¤å®³ï¼š${context.enemyDamage}\n`;

    prompt += `
**è¾“å‡ºè¦æ±‚**ï¼š
1. åªè¾“å‡ºæ•…äº‹æ­£æ–‡ï¼Œä¸è¦ä»»ä½•æ ‡è®°ã€æ ¼å¼ã€æ•°æ®
2. å¿…é¡»åˆ†æ®µï¼Œæ¯æ®µ50-100å­—
3. è¯­è¨€ç”ŸåŠ¨ç®€æ´ï¼Œåœºæ™¯æå†™å’Œå¯¹è¯åˆ†å¼€
4. ç”¨ç©ºè¡Œåˆ†éš”æ®µè½

ç›´æ¥å¼€å§‹è®²è¿°æ•…äº‹ï¼š`;

    return prompt;
  }

  /**
   * æ„å»ºæ•°æ®è§£ææç¤ºè¯
   */
  static buildParsePrompt(
    storyText: string,
    gameState: GameState,
    userAction: string
  ): string {
    // å®ç°è§ç¬¬ 2.2 èŠ‚
  }

  /**
   * æ„å»ºä»»åŠ¡åˆ—è¡¨ç”Ÿæˆæç¤ºè¯
   */
  static buildQuestListPrompt(gameState: GameState): string {
    // å®ç°è§ç¬¬ 2.3.1 èŠ‚
  }

  /**
   * æ„å»ºä»»åŠ¡è¯¦æƒ…ç”Ÿæˆæç¤ºè¯
   */
  static buildQuestDetailPrompt(quest: QuestBasic): string {
    // å®ç°è§ç¬¬ 2.3.2 èŠ‚
  }

  /**
   * æ„å»ºä»»åŠ¡åˆ¤å®šæç¤ºè¯
   */
  static buildQuestJudgePrompt(quest: Quest, storyContent: string): string {
    // å®ç°è§ç¬¬ 2.4 èŠ‚
  }

  /**
   * æ„å»ºç»˜å›¾æç¤ºè¯ç”Ÿæˆå™¨æç¤ºè¯
   */
  static buildDrawPromptGeneratorPrompt(sceneInfo: string): string {
    // å®ç°è§ç¬¬ 2.5 èŠ‚
  }
}
```

### 8.2 ä½¿ç”¨ç¤ºä¾‹

```typescript
// pages/GameInterface.tsx
import { PromptBuilder } from '@/utils/promptBuilder';
import { useDZMMCompletion } from '@/hooks/useDZMMCompletion';

function GameInterface() {
  const { generate } = useDZMMCompletion();
  const [gameState, setGameState] = useState<GameState>({...});

  const handleAction = async (action: string, context: ActionContext) => {
    // æ„å»ºæç¤ºè¯
    const storyPrompt = PromptBuilder.buildStoryPrompt(gameState, action, context);

    // è°ƒç”¨ API
    const storyContent = await generate(
      gameState.storyModel,
      [{ role: 'user', content: storyPrompt }],
      1000
    );

    // è§£ææ•°æ®
    const parsePrompt = PromptBuilder.buildParsePrompt(
      storyContent,
      gameState,
      context.userAction || ''
    );

    const parseResult = await generate(
      gameState.responseModel,
      [{ role: 'user', content: parsePrompt }],
      400
    );

    // ... åº”ç”¨æ•°æ®å˜åŒ–
  };

  return <div>...</div>;
}
```

---

## 9. æœ€ä½³å®è·µ

### 9.1 æç¤ºè¯è®¾è®¡åŸåˆ™

1. **æ˜ç¡®è§’è‰²å®šä½**ï¼šæ¯ä¸ªæç¤ºè¯å¼€å¤´éƒ½æ˜ç¡® AI çš„è§’è‰²
2. **æä¾›å……åˆ†ä¸Šä¸‹æ–‡**ï¼šåŒ…å«æ‰€æœ‰å¿…è¦çš„æ¸¸æˆçŠ¶æ€ä¿¡æ¯
3. **ä½¿ç”¨ç»“æ„åŒ–æ ‡è®°**ï¼šç”¨æ ‡è®°æ˜ç¡®è¾“å‡ºæ ¼å¼ï¼ˆ`###DATA`, `<xml>`ï¼‰
4. **æ·»åŠ æ­£åç¤ºä¾‹**ï¼šå‘Šè¯‰ AI ä»€ä¹ˆè¯¥åšã€ä»€ä¹ˆä¸è¯¥åš
5. **é™åˆ¶è¾“å‡ºé•¿åº¦**ï¼šæ˜ç¡®å­—æ•°æˆ– token è¦æ±‚

### 9.2 è°ƒè¯•æç¤ºè¯è¾“å‡º

```typescript
// utils/promptDebugger.ts

export const debugPrompt = (
  promptName: string,
  prompt: string,
  response: string
) => {
  console.group(`[Prompt Debug] ${promptName}`);
  console.log('ğŸ“ è¾“å…¥æç¤ºè¯:');
  console.log(prompt);
  console.log('\nğŸ¤– AI å“åº”:');
  console.log(response);
  console.groupEnd();
};

// ä½¿ç”¨ç¤ºä¾‹
const storyPrompt = PromptBuilder.buildStoryPrompt(...);
const response = await generate(model, [{ role: 'user', content: storyPrompt }]);
debugPrompt('æ•…äº‹ç”Ÿæˆ', storyPrompt, response);
```

### 9.3 ä¼˜åŒ– Token ä½¿ç”¨

1. **é™åˆ¶å†å²æ¶ˆæ¯æ•°é‡**ï¼š
   ```typescript
   const recentMessages = allMessages.slice(-GAME_CONFIG.storyHistoryCount);
   ```

2. **ç®€åŒ–æ¸¸æˆçŠ¶æ€æè¿°**ï¼š
   ```typescript
   // âŒ ä¸æ¨èï¼šè¿‡äºè¯¦ç»†
   - åº“å­˜ï¼šç”Ÿå‘½è¯æ°´Ã—3, é­”æ³•è¯æ°´Ã—2, ä¸‡èƒ½è¯Ã—1, æœˆå…‰è‰Ã—5, ...

   // âœ… æ¨èï¼šç®€æ´æ˜äº†
   - åº“å­˜ï¼š${Object.keys(player.inventory).length}ç§ç‰©å“
   ```

3. **ç§»é™¤å†å²æ¶ˆæ¯ä¸­çš„ç‰¹æ®Šæ ‡è®°**ï¼š
   ```typescript
   const cleanMessage = (content: string) => {
     return content
       .replace(/###DATA[\s\S]*?###END/g, '')
       .replace(/###NEW[\s\S]*?###END/g, '')
       .trim();
   };
   ```

### 9.4 å¤„ç† AI è¾“å‡ºæ ¼å¼é”™è¯¯

```typescript
// utils/responseParser.ts

export const parseWithFallback = <T>(
  responseText: string,
  parser: (text: string) => T,
  fallback: T
): T => {
  try {
    const result = parser(responseText);
    if (!result || Object.keys(result).length === 0) {
      console.warn('[Parser] Empty result, using fallback');
      return fallback;
    }
    return result;
  } catch (error) {
    console.error('[Parser] Parsing failed, using fallback:', error);
    return fallback;
  }
};

// ä½¿ç”¨ç¤ºä¾‹
const changes = parseWithFallback(
  responseText,
  parseDataBlock,
  {} // é»˜è®¤å€¼
);
```

### 9.5 æ­£åç¤ºä¾‹çš„é‡è¦æ€§

**åŸ Alpine.js å®ç°ä¸­ç¼ºå°‘æ­£åç¤ºä¾‹**ï¼Œè¿™æ˜¯å¯ä»¥æ”¹è¿›çš„åœ°æ–¹ã€‚

**æ¨èæ·»åŠ ï¼ˆå‚è€ƒæ‹çˆ±æ¸¸æˆ.htmlï¼‰ï¼š**

```javascript
<examples>
ã€æ­£ç¡®ç¤ºä¾‹ã€‘
ç”¨æˆ·è¡ŒåŠ¨:æ™®é€šæ”»å‡»
æ•…äº‹è¾“å‡º:
ä½ æŒ¥èµ·é•¿å‰‘ï¼Œå‰‘åˆƒåˆ’è¿‡ç©ºæ°”ã€‚

å²è±å§†æ¥ä¸åŠèº²é—ªï¼Œè¢«ä¸€å‰‘æ–©æˆä¸¤åŠã€‚ç»¿è‰²çš„é»æ¶²å››æº…ï¼Œä½ æˆåŠŸå‡»è´¥äº†å®ƒã€‚

ã€é”™è¯¯ç¤ºä¾‹ - ç»å¯¹ä¸è¦è¿™æ ·ã€‘
âŒ ä¸è¦è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼šå½“å‰çŠ¶æ€ï¼šHP:100/100 MP:50/50
âŒ ä¸è¦è¾“å‡ºæ•°æ®æ ‡è®°ï¼š###DATA HPå˜åŒ–:-10 ###END
âŒ ä¸è¦å•æ®µè¾“å‡º200å­—é•¿æ–‡ï¼Œå¿…é¡»åˆ†æ®µ
âŒ ä¸è¦åœ¨æ•…äº‹å‰è¾“å‡º"å¥½çš„ï¼Œæˆ‘æ¥è®²è¿°æ•…äº‹..."
</examples>
```

---

## 10. æ€»ç»“

### 10.1 å…³é”®è¦ç‚¹

1. **5ç§ AI è§’è‰²**ï¼šå™äº‹è€…ã€æ•°æ®åˆ†æå™¨ã€ä»»åŠ¡å‘å¸ƒå‘˜ã€ä»»åŠ¡å®¡æ ¸å‘˜ã€ç»˜å›¾ç”Ÿæˆå™¨
2. **åŒæ¨¡å‹åä½œ**ï¼šæ­£æ–‡æ¨¡å‹ç”Ÿæˆæ•…äº‹ + å“åº”æ¨¡å‹è§£ææ•°æ®
3. **6ç§ç»“æ„åŒ–æ ¼å¼**ï¼š`###DATA`, `###NEW`, `<quest>`, `###PROMPT`, `###RESULT`
4. **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šå†å²é™åˆ¶ï¼ˆ15/5/3æ¡ï¼‰ï¼Œæ¸¸æˆçŠ¶æ€æ³¨å…¥ï¼Œå·²çŸ¥å†…å®¹åˆ—è¡¨
5. **å®Œæ•´æ¨¡æ¿åº“**ï¼š6ä¸ªå¯å¤ç”¨æç¤ºè¯æ¨¡æ¿ï¼Œå¯ç›´æ¥å¤åˆ¶ä½¿ç”¨

### 10.2 è¿ç§»æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰æç¤ºè¯æ¨¡æ¿å·²å¤åˆ¶åˆ° React é¡¹ç›®
- [ ] PromptBuilder å·¥å…·ç±»å·²å®ç°
- [ ] ResponseParser å·¥å…·ç±»å·²å®ç°
- [ ] æ‰€æœ‰è§£æå‡½æ•°å·²æ·»åŠ å®¹é”™é€»è¾‘
- [ ] å†å²æ¶ˆæ¯é™åˆ¶å·²é…ç½®
- [ ] æ¸¸æˆçŠ¶æ€æ³¨å…¥é€»è¾‘å·²å®ç°
- [ ] è°ƒè¯•å·¥å…·å·²é…ç½®

### 10.3 ä¸‹ä¸€æ­¥

æ‰€æœ‰æç¤ºè¯æ¨¡æ¿å’Œè§£æé€»è¾‘å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹é›†æˆåˆ° React é¡¹ç›®ä¸­ã€‚

è¯·ç»“åˆã€ŠDZMM_API_é›†æˆæŒ‡å—.mdã€‹ï¼Œå®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š
1. åˆ›å»º `utils/promptBuilder.ts` å’Œ `utils/responseParser.ts`
2. å®ç°æ‰€æœ‰æç¤ºè¯æ„å»ºæ–¹æ³•
3. å®ç°æ‰€æœ‰å“åº”è§£ææ–¹æ³•
4. åœ¨ Hooks ä¸­ä½¿ç”¨è¿™äº›å·¥å…·
5. æµ‹è¯•æ‰€æœ‰ AI è°ƒç”¨åœºæ™¯

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0
**æœ€åæ›´æ–°ï¼š** 2025-11-23
**ç»´æŠ¤è€…ï¼š** Claude Code Migration Team
