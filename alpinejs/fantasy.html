<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¥‡å¹»ä¸–ç•ŒRPG - ä¼˜åŒ–ç‰ˆ</title>
</head>

<!--
===============================================================================
ğŸ® å¥‡å¹»ä¸–ç•ŒRPG - å®Œæ•´ä¼˜åŒ–ç‰ˆ

ğŸ“ æ›´æ–°æ—¥å¿—ï¼š
v2.0 - 2025-11-08
- âœ… ä¿®å¤ï¼šAIå“åº”å¡æ­»é—®é¢˜ï¼ˆé™åˆ¶å†å²æ¶ˆæ¯æ•°é‡ï¼‰
- âœ… ä¿®å¤ï¼šè°ƒè¯•ä¿¡æ¯æ³„éœ²é—®é¢˜ï¼ˆæ·»åŠ æ–‡æœ¬æ¸…æ´—ï¼‰
- âœ… æ–°å¢ï¼šå®Œæ•´çš„èœå•ç³»ç»Ÿï¼ˆå­˜æ¡£/èƒŒåŒ…/è£…å¤‡/ç”»å»Šï¼‰
- âœ… æ–°å¢ï¼šå¤šå­˜æ¡£æ§½ä½æ”¯æŒï¼ˆ3ä¸ªæ§½ä½ï¼‰
- âœ… æ–°å¢ï¼šæ¨¡å‹é€‰æ‹©åŠŸèƒ½ï¼ˆ6ä¸ªæ¨¡å‹å¯é€‰ï¼‰
- âœ… æ–°å¢ï¼šè§’è‰²æ€§åˆ«å’Œå¤–è§‚é€‰æ‹©
- âœ… ä¼˜åŒ–ï¼šé“å…·äº¤äº’ï¼ˆç‚¹å‡»æ˜¾ç¤ºè¯¦æƒ…ï¼Œç¡®è®¤åä½¿ç”¨ï¼‰
- âœ… ä¼˜åŒ–ï¼šAIæ–‡é£ï¼ˆå¼ºåˆ¶åˆ†æ®µï¼Œæä¾›ç¤ºä¾‹ï¼‰
- âœ… æ–°å¢ï¼šç»˜å›¾APIé›†æˆï¼ˆç”Ÿæˆè§’è‰²ç«‹ç»˜ï¼‰
- âœ… æ–°å¢ï¼šç”»å»Šç³»ç»Ÿï¼ˆä¿å­˜å’Œç®¡ç†ç”Ÿæˆçš„å›¾ç‰‡ï¼‰

ğŸ¯ æ ¸å¿ƒæ”¹è¿›ï¼š
1. å†å²æ¶ˆæ¯é™åˆ¶ï¼šåªè¯»å–æœ€è¿‘15æ¡ï¼Œé¿å…tokenè¶…é™
2. ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–ï¼šç®€åŒ–æ ¼å¼ï¼Œæ·»åŠ æ–‡é£è¦æ±‚
3. é”™è¯¯å¤„ç†å¢å¼ºï¼šæ‰€æœ‰APIè°ƒç”¨éƒ½æœ‰try-catch
4. UI/UXä¼˜åŒ–ï¼šèœå•ç³»ç»Ÿã€æ¨¡æ€æ¡†ã€ç¡®è®¤å¯¹è¯æ¡†
5. ç»˜å›¾åŠŸèƒ½ï¼šAIç”Ÿæˆæç¤ºè¯ + ç»˜å›¾API + ç”»å»Šç®¡ç†

===============================================================================
-->

<body x-data="">
  <!-- åŠ è½½ä¸­ -->
  <div x-show="$store.rpg.loading" class="loading-screen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p x-text="$store.rpg.loadingText || 'æ­£åœ¨åŠ è½½å¥‡å¹»ä¸–ç•Œ...'"></p>
    </div>
  </div>

  <!-- è§’è‰²åˆ›å»º/ä¸»èœå• -->
  <div x-show="!$store.rpg.gameStarted && !$store.rpg.loading" x-transition class="char-creation">
    <div class="creation-card">
      <h1>âš”ï¸ å¥‡å¹»ä¸–ç•ŒRPG</h1>

      <!-- ========== ä¸»èœå•é€‰é¡¹ ========== -->
      <div x-show="!$store.rpg.showCharCreation && !$store.rpg.showLoadGame" class="main-menu">
        <button @click="$store.rpg.showCharCreation = true" class="menu-option">
          ğŸ® æ–°æ¸¸æˆ
        </button>
        <button @click="$store.rpg.showLoadGame = true" class="menu-option">
          ğŸ’¾ ç»§ç»­æ¸¸æˆ
        </button>

        <!-- æ­£æ–‡æ¨¡å‹é€‰æ‹© -->
        <div class="model-selection">
          <label>æ­£æ–‡æ¨¡å‹ï¼ˆç”Ÿæˆæ•…äº‹ï¼‰ï¼š</label>
          <select x-model="$store.rpg.storyModel">
    <option value="nalang-turbo-0826">Turbo (å¿«é€Ÿ)</option>

    <option value="nalang-medium-0826">Medium (å¹³è¡¡)</option>

    <option value="nalang-max-0826">Max (å¼ºå¤§)</option>

    <option value="nalang-xl-0826">XL (ç¨³å®š)</option>

    <option value="nalang-max-0826-16k">Max-16K (å¿«é€Ÿå¼ºå¤§)</option>

    <option value="nalang-xl-0826-16k">XL-16K (å¿«é€Ÿç¨³å®š)</option>
          </select>
        </div>

        <!-- å“åº”æ¨¡å‹é€‰æ‹© -->
        <div class="model-selection">
          <label>å“åº”æ¨¡å‹ï¼ˆå¤„ç†æ•°æ®ï¼‰ï¼š</label>
          <select x-model="$store.rpg.responseModel">
    <option value="nalang-turbo-0826">Turbo (å¿«é€Ÿ)</option>

    <option value="nalang-medium-0826">Medium (å¹³è¡¡)</option>

    <option value="nalang-max-0826">Max (å¼ºå¤§)</option>

    <option value="nalang-xl-0826">XL (ç¨³å®š)</option>

    <option value="nalang-max-0826-16k">Max-16K (å¿«é€Ÿå¼ºå¤§)</option>

    <option value="nalang-xl-0826-16k">XL-16K (å¿«é€Ÿç¨³å®š)</option>
          </select>
          <small style="color: rgba(255,255,255,0.6); display: block; margin-top: 5px;">
            å“åº”æ¨¡å‹ç”¨äºè§£ææ­£æ–‡å¹¶æ›´æ–°æ¸¸æˆæ•°æ®ï¼Œå»ºè®®ä½¿ç”¨Medium/XLä»¥ç¡®ä¿æ•°æ®å‡†ç¡®æ€§
          </small>
        </div>
      </div>

      <!-- ========== è¯»å–å­˜æ¡£ç•Œé¢ ========== -->
      <div x-show="$store.rpg.showLoadGame" class="load-game-screen">
        <h2>ğŸ’¾ è¯»å–å­˜æ¡£</h2>
        <div class="save-slots">
          <template x-for="slot in [1, 2, 3]" :key="slot">
            <div class="save-slot" @click="$store.rpg.loadGame(slot)">
              <template x-if="$store.rpg.saveSlots[slot]">
                <div class="save-info">
                  <div class="save-header">
                    <span class="save-name" x-text="$store.rpg.saveSlots[slot].playerName"></span>
                    <span class="save-level" x-text="`Lv.${$store.rpg.saveSlots[slot].level}`"></span>
                  </div>
                  <div class="save-details">
                    <span x-text="$store.rpg.saveSlots[slot].className"></span>
                    <span x-text="$store.rpg.saveSlots[slot].location"></span>
                  </div>
                  <div class="save-time" x-text="$store.rpg.saveSlots[slot].timestamp"></div>
                </div>
              </template>
              <template x-if="!$store.rpg.saveSlots[slot]">
                <div class="empty-slot">
                  <span>ç©ºå­˜æ¡£</span>
                </div>
              </template>
            </div>
          </template>
        </div>
        <button @click="$store.rpg.showLoadGame = false" class="back-btn">è¿”å›</button>
      </div>

      <!-- ========== è§’è‰²åˆ›å»ºç•Œé¢ ========== -->
      <div x-show="$store.rpg.showCharCreation" class="char-creation-form">
        <h2>åˆ›å»ºè§’è‰²</h2>

        <div class="form-group">
          <label>è§’è‰²åç§°ï¼š</label>
          <input x-model="$store.rpg.playerName" placeholder="è¾“å…¥ä½ çš„åå­—" maxlength="12" />
        </div>

        <div class="form-group">
          <label>æ€§åˆ«ï¼š</label>
          <div class="gender-selection">
            <button
              class="gender-btn"
              :class="{ 'selected': $store.rpg.playerGender === 'male' }"
              @click="$store.rpg.playerGender = 'male'">
              â™‚ï¸ ç”·æ€§
            </button>
            <button
              class="gender-btn"
              :class="{ 'selected': $store.rpg.playerGender === 'female' }"
              @click="$store.rpg.playerGender = 'female'">
              â™€ï¸ å¥³æ€§
            </button>
          </div>
        </div>

        <div class="form-group">
          <label>å¤–è§‚ç‰¹å¾ï¼š</label>
          <input x-model="$store.rpg.playerAppearance" placeholder="ä¾‹å¦‚ï¼šé‡‘è‰²é•¿å‘ï¼Œè“è‰²çœ¼ç›" maxlength="50" />
          <small>å¯é€‰ï¼Œç”¨äºç”Ÿæˆè§’è‰²ç«‹ç»˜</small>
        </div>

        <div class="form-group">
          <label>é€‰æ‹©èŒä¸šï¼š</label>
          <div class="class-selection">
            <template x-for="cls in $store.rpg.classes" :key="cls.id">
              <div class="class-card" :class="{ 'selected': $store.rpg.selectedClass === cls.id }"
                @click="$store.rpg.selectedClass = cls.id">
                <div class="class-icon" x-text="cls.icon"></div>
                <div class="class-name" x-text="cls.name"></div>
                <div class="class-desc" x-text="cls.desc"></div>
                <div class="class-stats">
                  <span>â¤ï¸ <span x-text="cls.hp"></span></span>
                  <span>âœ¨ <span x-text="cls.mp"></span></span>
                  <span>âš”ï¸ <span x-text="cls.atk"></span></span>
                  <span>ğŸ›¡ï¸ <span x-text="cls.def"></span></span>
                </div>
              </div>
            </template>
          </div>
        </div>

        <button
          @click="$store.rpg.startGame()"
          :disabled="!$store.rpg.playerName || !$store.rpg.selectedClass"
          class="start-btn">
          ğŸ® å¼€å§‹å†’é™©
        </button>

        <button @click="$store.rpg.showCharCreation = false" class="back-btn">è¿”å›</button>
      </div>
    </div>
  </div>

  <!-- æ¸¸æˆä¸»ç•Œé¢ -->
  <div x-show="$store.rpg.gameStarted && !$store.rpg.loading" x-transition class="game-screen">

    <!-- èœå•æŒ‰é’® -->
    <button @click="$store.rpg.menuOpen = true" class="menu-btn">
      â˜° èœå•
    </button>

    <!-- ç”Ÿæˆç«‹ç»˜æŒ‰é’® -->
    <button @click="$store.rpg.showArtGenerator = true" class="art-btn">
      ğŸ“· ç”Ÿæˆç«‹ç»˜
    </button>

<!-- å†’é™©è€…å…¬ä¼šæŒ‰é’®ï¼ˆæ–°å¢ï¼‰-->
<button @click="$store.rpg.showGuildPanel = true" class="guild-btn">
  ğŸ›ï¸ å…¬ä¼š
</button>

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">
      <div class="player-info">
        <div class="player-name" x-text="$store.rpg.player.name"></div>
        <div class="player-class" x-text="$store.rpg.player.className"></div>
        <div class="player-level">Lv.<span x-text="$store.rpg.player.level"></span></div>
      </div>

      <div class="player-stats">
        <div class="stat-bar">
          <span class="stat-label">â¤ï¸ HP</span>
          <div class="bar">
            <div class="bar-fill hp" :style="`width: ${($store.rpg.player.hp / $store.rpg.player.maxHp) * 100}%`"></div>
          </div>
          <span class="stat-value" x-text="`${$store.rpg.player.hp}/${$store.rpg.player.maxHp}`"></span>
        </div>

        <div class="stat-bar">
          <span class="stat-label">âœ¨ MP</span>
          <div class="bar">
            <div class="bar-fill mp" :style="`width: ${($store.rpg.player.mp / $store.rpg.player.maxMp) * 100}%`"></div>
          </div>
          <span class="stat-value" x-text="`${$store.rpg.player.mp}/${$store.rpg.player.maxMp}`"></span>
        </div>

        <div class="stat-bar">
          <span class="stat-label">â­ EXP</span>
          <div class="bar">
            <div class="bar-fill exp" :style="`width: ${($store.rpg.player.exp / $store.rpg.player.expToNext) * 100}%`">
            </div>
          </div>
          <span class="stat-value" x-text="`${$store.rpg.player.exp}/${$store.rpg.player.expToNext}`"></span>
        </div>
      </div>

      <div class="player-resources">
        <div class="resource">ğŸ’° <span x-text="$store.rpg.player.gold"></span></div>
        <div class="resource">ğŸ“ <span x-text="$store.rpg.player.location"></span></div>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <div class="main-content">

      <!-- å·¦ä¾§ï¼šåœºæ™¯æ˜¾ç¤º -->
      <div class="scene-area">
        <div class="scene-image" :style="`background-image: url('${$store.rpg.currentScene}')`">
          <!-- æˆ˜æ–—æ—¶æ˜¾ç¤ºæ•Œäºº -->
          <div x-show="$store.rpg.inBattle" class="enemy-display">
            <div class="enemy-image">
              <span class="enemy-icon" x-text="$store.rpg.currentEnemy?.icon || 'ğŸ‘¹'"></span>
            </div>
            <div class="enemy-info">
              <div class="enemy-name" x-text="$store.rpg.currentEnemy?.name"></div>
              <div class="enemy-hp-bar">
                <div class="bar">
                  <div class="bar-fill hp"
                    :style="`width: ${($store.rpg.currentEnemy?.hp / $store.rpg.currentEnemy?.maxHp) * 100}%`"></div>
                </div>
                <span x-text="`${$store.rpg.currentEnemy?.hp}/${$store.rpg.currentEnemy?.maxHp}`"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- å‰§æƒ…æ–‡æœ¬æ¡† -->
        <div class="story-box">
          <div class="story-content" x-html="$store.rpg.storyText"></div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šæ“ä½œé¢æ¿ -->
      <div class="control-panel">

        <!-- æˆ˜ æ–—ä¸­ -->
        <div x-show="$store.rpg.inBattle" class="battle-actions">
          <h3>âš”ï¸ æˆ˜æ–—æŒ‡ä»¤</h3>
          <button @click="$store.rpg.attack()" :disabled="$store.rpg.actionLocked" class="action-btn">
            âš”ï¸ æ™®é€šæ”»å‡»
          </button>

          <div class="skills-list">
            <template x-for="skill in $store.rpg.player.skills" :key="skill.id">
              <button
                @click="$store.rpg.useSkill(skill)"
                :disabled="$store.rpg.actionLocked || $store.rpg.player.mp < skill.cost"
                class="skill-btn">
                <span x-text="skill.icon"></span>
                <span x-text="skill.name"></span>
                <span class="skill-cost" x-text="`${skill.cost}MP`"></span>
              </button>
            </template>
          </div>

          <button @click="$store.rpg.flee()" :disabled="$store.rpg.actionLocked" class="action-btn flee">
            ğŸƒ é€ƒè·‘
          </button>
        </div>

        <!-- æ¢ç´¢ä¸­ -->
        <div x-show="!$store.rpg.inBattle" class="explore-actions">
          <h3>ğŸ—ºï¸ æ¢ç´¢æŒ‡ä»¤</h3>

          <div class="location-select">
            <label>å‰å¾€ï¼š</label>
            <select x-model="$store.rpg.targetLocation">
              <template x-for="loc in $store.rpg.availableLocations" :key="loc.id">
                <option :value="loc.id" x-text="`${loc.icon} ${loc.name}`"></option>
              </template>
            </select>
            <button @click="$store.rpg.move()" :disabled="$store.rpg.actionLocked">
              ğŸš¶ ç§»åŠ¨
            </button>
          </div>

          <button @click="$store.rpg.explore()" :disabled="$store.rpg.actionLocked" class="action-btn">
            ğŸ” æ¢ç´¢å½“å‰åŒºåŸŸ
          </button>

          <button @click="$store.rpg.rest()" :disabled="$store.rpg.actionLocked" class="action-btn">
            ğŸ˜´ ä¼‘æ¯æ¢å¤
          </button>

          <button @click="$store.rpg.talk()" :disabled="$store.rpg.actionLocked" class="action-btn">
            ğŸ’¬ ä¸NPCå¯¹è¯
          </button>
        </div>

        <!-- è‡ªç”±è¾“å…¥ -->
        <div class="free-input">
          <input
            x-model="$store.rpg.playerInput"
            placeholder="è¾“å…¥è‡ªå®šä¹‰è¡ŒåŠ¨..."
            :disabled="$store.rpg.actionLocked"
            @keydown.enter="$store.rpg.customAction()" />
          <button @click="$store.rpg.customAction()" :disabled="$store.rpg.actionLocked">
            âœ‰ï¸ å‘é€
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- èœå•è¦†ç›–å±‚ -->
  <div x-show="$store.rpg.menuOpen" x-transition class="menu-overlay" @click.self="$store.rpg.menuOpen = false">
    <div class="menu-panel">
      <h2>æ¸¸æˆèœå•</h2>

      <div class="menu-tabs">
        <button
          class="menu-tab"
          :class="{ 'active': $store.rpg.menuTab === 'save' }"
          @click="$store.rpg.menuTab = 'save'">
          ğŸ’¾ å­˜æ¡£
        </button>
        <button
          class="menu-tab"
          :class="{ 'active': $store.rpg.menuTab === 'bag' }"
          @click="$store.rpg.menuTab = 'bag'">
          ğŸ’ èƒŒåŒ…
        </button>
        <button
          class="menu-tab"
          :class="{ 'active': $store.rpg.menuTab === 'equip' }"
          @click="$store.rpg.menuTab = 'equip'">
          âš”ï¸ è£…å¤‡
        </button>
        <button
          class="menu-tab"
          :class="{ 'active': $store.rpg.menuTab === 'status' }"
          @click="$store.rpg.menuTab = 'status'">
          ğŸ“Š çŠ¶æ€
        </button>
        <button
          class="menu-tab"
          :class="{ 'active': $store.rpg.menuTab === 'gallery' }"
          @click="$store.rpg.menuTab = 'gallery'">
          ğŸ–¼ï¸ ç”»å»Š
        </button>
<button
  class="menu-tab"
  :class="{ 'active': $store.rpg.menuTab === 'quest' }"
  @click="$store.rpg.menuTab = 'quest'">
  ğŸ“œ ä»»åŠ¡
</button>

        <button
          class="menu-tab"
          :class="{ 'active': $store.rpg.menuTab === 'custom' }"
          @click="$store.rpg.menuTab = 'custom'">
          ğŸ”§ è‡ªå®šä¹‰å†…å®¹
        </button>

      </div>

      <div class="menu-content">
        <!-- å­˜æ¡£é¡µ -->
        <div x-show="$store.rpg.menuTab === 'save'" class="menu-page">
          <h3>å­˜æ¡£ç®¡ç†</h3>
          <div class="save-slots-menu">
            <template x-for="slot in [1, 2, 3]" :key="slot">
              <div class="save-slot-menu">
                <template x-if="$store.rpg.saveSlots[slot]">
                  <div class="save-info-menu">
                    <div class="save-header">
                      <span x-text="$store.rpg.saveSlots[slot].playerName"></span>
                      <span x-text="`Lv.${$store.rpg.saveSlots[slot].level}`"></span>
                    </div>
                    <div class="save-details">
                      <span x-text="$store.rpg.saveSlots[slot].className"></span>
                      <span x-text="$store.rpg.saveSlots[slot].location"></span>
                    </div>
                    <div class="save-time" x-text="$store.rpg.saveSlots[slot].timestamp"></div>
                    <div class="save-actions">
                      <button @click="$store.rpg.saveGame(slot)" class="save-action-btn">è¦†ç›–ä¿å­˜</button>
                      <button @click="$store.rpg.loadGame(slot)" class="save-action-btn">è¯»å–</button>
                    </div>
                  </div>
                </template>
                <template x-if="!$store.rpg.saveSlots[slot]">
                  <div class="empty-slot-menu">
                    <span>ç©ºå­˜æ¡£æ§½ä½ #<span x-text="slot"></span></span>
                    <button @click="$store.rpg.saveGame(slot)" class="save-action-btn">ä¿å­˜åˆ°æ­¤</button>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </div>

        <!-- èƒŒåŒ…é¡µ -->
        <div x-show="$store.rpg.menuTab === 'bag'" class="menu-page">
          <h3>ç‰©å“èƒŒåŒ…</h3>
          <div class="inventory-grid-menu">
            <template x-for="(count, itemId) in $store.rpg.player.inventory" :key="itemId">
              <div class="item-card-menu" @click="$store.rpg.showItemModal(itemId)">
                <div class="item-icon" x-text="$store.rpg.getItemData(itemId)?.icon"></div>
                <div class="item-name" x-text="$store.rpg.getItemData(itemId)?.name"></div>
                <div class="item-count" x-text="`x${count}`"></div>
              </div>
            </template>
          </div>
          <div x-show="Object.keys($store.rpg.player.inventory).length === 0" class="empty-state">
            èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ...
          </div>
        </div>

        <!-- è£…å¤‡é¡µ -->
        <div x-show="$store.rpg.menuTab === 'equip'" class="menu-page">
          <h3>è£…å¤‡æ </h3>
          <div class="equipment-slots-menu">
            <div class="equip-slot-menu">
              <span class="equip-label">æ­¦å™¨ï¼š</span>
              <span class="equip-value" x-text="$store.rpg.player.equipment.weapon || 'æ— '"></span>
            </div>
            <div class="equip-slot-menu">
              <span class="equip-label">é˜²å…·ï¼š</span>
              <span class="equip-value" x-text="$store.rpg.player.equipment.armor || 'æ— '"></span>
            </div>
            <div class="equip-slot-menu">
              <span class="equip-label">é¥°å“ï¼š</span>
              <span class="equip-value" x-text="$store.rpg.player.equipment.accessory || 'æ— '"></span>
            </div>
          </div>
        </div>

        <!-- çŠ¶æ€é¡µ -->
        <div x-show="$store.rpg.menuTab === 'status'" class="menu-page">
          <h3>è§’è‰²çŠ¶æ€</h3>
          <div class="status-details-menu">
            <div class="status-row-menu">
              <span>è§’è‰²åï¼š</span>
              <span x-text="$store.rpg.player.name"></span>
            </div>
            <div class="status-row-menu">
              <span>èŒä¸šï¼š</span>
              <span x-text="$store.rpg.player.className"></span>
            </div>
            <div class="status-row-menu">
              <span>æ€§åˆ«ï¼š</span>
              <span x-text="$store.rpg.player.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'"></span>
            </div>
            <div class="status-row-menu">
              <span>ç­‰çº§ï¼š</span>
              <span x-text="$store.rpg.player.level"></span>
            </div>
            <div class="status-row-menu">
              <span>ç”Ÿå‘½å€¼ï¼š</span>
              <span x-text="`${$store.rpg.player.hp} / ${$store.rpg.player.maxHp}`"></span>
            </div>
            <div class="status-row-menu">
              <span>é­”æ³•å€¼ï¼š</span>
              <span x-text="`${$store.rpg.player.mp} / ${$store.rpg.player.maxMp}`"></span>
            </div>
            <div class="status-row-menu">
              <span>æ”»å‡»åŠ›ï¼š</span>
              <span x-text="$store.rpg.player.atk"></span>
            </div>
            <div class="status-row-menu">
              <span>é˜²å¾¡åŠ›ï¼š</span>
              <span x-text="$store.rpg.player.def"></span>
            </div>
            <div class="status-row-menu">
              <span>é‡‘å¸ï¼š</span>
              <span x-text="$store.rpg.player.gold"></span>
            </div>
            <div class="status-row-menu">
              <span>ç»éªŒå€¼ï¼š</span>
              <span x-text="`${$store.rpg.player.exp} / ${$store.rpg.player.expToNext}`"></span>
            </div>
          </div>
        </div>

        <!-- ç”»å»Šé¡µ -->
        <div x-show="$store.rpg.menuTab === 'gallery'" class="menu-page">
          <h3>ç”»å»Š</h3>
          <div class="gallery-grid">
            <template x-for="(img, index) in $store.rpg.gallery" :key="img.id">
              <div class="gallery-item" @click="$store.rpg.viewImage(img)">
                <img :src="img.url" :alt="img.target" class="gallery-thumbnail" />
                <div class="gallery-info">
                  <span x-text="img.target"></span>
                  <button @click.stop="$store.rpg.deleteImage(img.id)" class="delete-btn">ğŸ—‘ï¸</button>
                </div>
              </div>
            </template>
          </div>
          <div x-show="$store.rpg.gallery.length === 0" class="empty-state">
            ç”»å»Šç©ºç©ºå¦‚ä¹Ÿ...
          </div>
        </div>
<!-- ä»»åŠ¡é¡µï¼ˆæ–°å¢ï¼‰-->
<div x-show="$store.rpg.menuTab === 'quest'" class="menu-page">
  <h3>ä»»åŠ¡è®°å½•</h3>

  <!-- å½“å‰ä»»åŠ¡ -->
  <div x-show="$store.rpg.currentQuest" class="quest-record-section">
    <h4>å½“å‰ä»»åŠ¡</h4>
    <div class="quest-record-card">
      <div class="quest-record-header">
        <span x-text="QUEST_TYPES[$store.rpg.currentQuest?.type]?.icon"></span>
        <span x-text="$store.rpg.currentQuest?.title"></span>
      </div>
      <div class="quest-record-status">
        çŠ¶æ€ï¼š<span x-text="$store.rpg.currentQuest?.status === 'in_progress' ? 'æ‰§è¡Œä¸­' : 'æš‚ä¸è€ƒè™‘'"></span>
      </div>
    </div>
  </div>

  <!-- å†å²ä»»åŠ¡ -->
  <div class="quest-record-section">
    <h4>å·²å®Œæˆä»»åŠ¡ (<span x-text="$store.rpg.questHistory.length"></span>)</h4>
    <div class="quest-history-list">
      <template x-for="quest in $store.rpg.questHistory" :key="quest.id">
        <div class="quest-record-card">
          <div class="quest-record-header">
            <span x-text="QUEST_TYPES[quest.type]?.icon"></span>
            <span x-text="quest.title"></span>
          </div>
          <div class="quest-record-rewards">
            è·å¾—ï¼šğŸ’°<span x-text="quest.goldReward"></span> â­<span x-text="quest.expReward"></span>
          </div>
        </div>
      </template>
    </div>
    <div x-show="$store.rpg.questHistory.length === 0" class="empty-state">
      æš‚æ— å®Œæˆè®°å½•
    </div>
  </div>
</div>

        <!-- è‡ªå®šä¹‰å†…å®¹ç®¡ç†é¡µ -->
        <div x-show="$store.rpg.menuTab === 'custom'" class="menu-page">
          <h3>è‡ªå®šä¹‰å†…å®¹ç®¡ç†</h3>

          <!-- ç‰©å“åˆ—è¡¨ -->
          <div class="custom-section">
            <h4>ğŸ“¦ è‡ªå®šä¹‰ç‰©å“ (<span x-text="Object.keys($store.rpg.customItems).length"></span>)</h4>
            <div class="custom-list">
              <template x-for="(item, id) in $store.rpg.customItems" :key="id">
                <div class="custom-item">
                  <div class="custom-item-header">
                    <span class="custom-icon" x-text="item.icon"></span>
                    <span class="custom-name" x-text="item.name"></span>
                    <span class="custom-id" x-text="`(${id})`"></span>
                  </div>
                  <div class="custom-item-info">
                    <span x-text="`ç±»å‹: ${item.type}`"></span>
                    <span x-text="`æ•ˆæœ: ${item.effect}`"></span>
                    <span x-text="`æ•°å€¼: ${item.value}`"></span>
                  </div>
                  <div class="custom-item-desc" x-text="item.desc"></div>
                  <button @click="$store.rpg.deleteCustomItem(id)" class="delete-custom-btn">åˆ é™¤</button>
                </div>
              </template>
            </div>
            <div x-show="Object.keys($store.rpg.customItems).length === 0" class="empty-state">
              æš‚æ— è‡ªå®šä¹‰ç‰©å“
            </div>
          </div>

          <!-- æ•Œäººåˆ—è¡¨ -->
          <div class="custom-section">
            <h4>ğŸ‘¹ è‡ªå®šä¹‰æ•Œäºº (<span x-text="Object.keys($store.rpg.customEnemies).length"></span>)</h4>
            <div class="custom-list">
              <template x-for="(enemy, id) in $store.rpg.customEnemies" :key="id">
                <div class="custom-item">
                  <div class="custom-item-header">
                    <span class="custom-icon" x-text="enemy.icon"></span>
                    <span class="custom-name" x-text="enemy.name"></span>
                    <span class="custom-id" x-text="`(${id})`"></span>
                  </div>
                  <div class="custom-item-info">
                    <span x-text="`HP: ${enemy.hp}`"></span>
                    <span x-text="`æ”»å‡»: ${enemy.atk}`"></span>
                    <span x-text="`é˜²å¾¡: ${enemy.def}`"></span>
                    <span x-text="`ç»éªŒ: ${enemy.exp}`"></span>
                    <span x-text="`é‡‘å¸: ${enemy.gold}`"></span>
                  </div>
                  <div class="custom-item-desc" x-text="enemy.desc"></div>
                  <button @click="$store.rpg.deleteCustomEnemy(id)" class="delete-custom-btn">åˆ é™¤</button>
                </div>
              </template>
            </div>
            <div x-show="Object.keys($store.rpg.customEnemies).length === 0" class="empty-state">
              æš‚æ— è‡ªå®šä¹‰æ•Œäºº
            </div>
          </div>

          <!-- è£…å¤‡åˆ—è¡¨ -->
          <div class="custom-section">
            <h4>âš”ï¸ è‡ªå®šä¹‰è£…å¤‡ (<span x-text="Object.keys($store.rpg.customEquipment).length"></span>)</h4>
            <div class="custom-list">
              <template x-for="(equip, id) in $store.rpg.customEquipment" :key="id">
                <div class="custom-item">
                  <div class="custom-item-header">
                    <span class="custom-icon" x-text="equip.icon"></span>
                    <span class="custom-name" x-text="equip.name"></span>
                    <span class="custom-id" x-text="`(${id})`"></span>
                  </div>
                  <div class="custom-item-info">
                    <span x-text="`ç±»å‹: ${equip.type}`"></span>
                    <span x-text="`æ”»å‡»: ${equip.atk}`"></span>
                    <span x-text="`é˜²å¾¡: ${equip.def}`"></span>
                  </div>
                  <div class="custom-item-desc" x-text="equip.desc"></div>
                  <button @click="$store.rpg.deleteCustomEquipment(id)" class="delete-custom-btn">åˆ é™¤</button>
                </div>
              </template>
            </div>
            <div x-show="Object.keys($store.rpg.customEquipment).length === 0" class="empty-state">
              æš‚æ— è‡ªå®šä¹‰è£…å¤‡
            </div>
          </div>

          <!-- æ¸…ç©ºæŒ‰é’® -->
          <button @click="$store.rpg.clearAllCustomContent()" class="danger-btn" style="margin-top: 20px;">
            ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è‡ªå®šä¹‰å†…å®¹
          </button>
        </div>


      </div>



      <button @click="$store.rpg.menuOpen = false" class="close-menu-btn">è¿”å›æ¸¸æˆ</button>
    </div>
  </div>

  <!-- é“å…·è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div x-show="$store.rpg.itemModalOpen" x-transition class="modal-overlay"
    @click.self="$store.rpg.itemModalOpen = false">
    <div class="modal-content">
      <h3>é“å…·è¯¦æƒ…</h3>
      <div class="item-detail">
        <div class="item-icon-large" x-text="$store.rpg.selectedItemData?.icon"></div>
        <div class="item-name-large" x-text="$store.rpg.selectedItemData?.name"></div>
        <div class="item-description" x-text="$store.rpg.getItemDescription($store.rpg.selectedItemId)"></div>
        <div class="item-count-display">
          æ‹¥æœ‰æ•°é‡ï¼š<span x-text="$store.rpg.player.inventory[$store.rpg.selectedItemId] || 0"></span>
        </div>
      </div>
      <div class="modal-actions">
        <button @click="$store.rpg.confirmUseItem()" class="confirm-btn">ä½¿ç”¨</button>
        <button @click="$store.rpg.itemModalOpen = false" class="cancel-btn">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- ç«‹ç»˜ç”Ÿæˆå™¨æ¨¡æ€æ¡† -->
  <div x-show="$store.rpg.showArtGenerator" x-transition class="modal-overlay"
    @click.self="$store.rpg.showArtGenerator = false">
    <div class="modal-content art-generator">
      <h3>ğŸ“· ç”Ÿæˆè§’è‰²ç«‹ç»˜</h3>

      <div class="form-group">
        <label>é€‰æ‹©ç”Ÿæˆå¯¹è±¡ï¼š</label>
        <select x-model="$store.rpg.artTarget">
          <option value="player">æˆ‘çš„è§’è‰²</option>
          <option value="npc" x-show="$store.rpg.lastNPC">å½“å‰NPC</option>
          <option value="enemy" x-show="$store.rpg.currentEnemy">å½“å‰æ•Œäºº</option>
        </select>
      </div>

      <div class="form-group">
        <label>è‡ªå®šä¹‰è¦æ±‚ï¼ˆå¯é€‰ï¼‰ï¼š</label>
        <textarea
          x-model="$store.rpg.artRequirement"
          placeholder="ä¾‹å¦‚ï¼šå¾®ç¬‘ç€ï¼Œæ‰‹æŒæ­¦å™¨ï¼ŒèƒŒæ™¯æ˜¯æ£®æ—..."
          rows="3"></textarea>
      </div>

      <div class="modal-actions">
        <button @click="$store.rpg.generateArt()" :disabled="$store.rpg.generatingArt" class="confirm-btn">
          <span x-show="!$store.rpg.generatingArt">âœ¨ ç”Ÿæˆ</span>
          <span x-show="$store.rpg.generatingArt">ç”Ÿæˆä¸­...</span>
        </button>
        <button @click="$store.rpg.showArtGenerator = false" class="cancel-btn">å–æ¶ˆ</button>
      </div>

      <div x-show="$store.rpg.artError" class="error-message" x-text="$store.rpg.artError"></div>
    </div>
  </div>

  <!-- å›¾ç‰‡æŸ¥çœ‹å™¨ -->
  <div x-show="$store.rpg.viewingImage" x-transition class="image-viewer" @click="$store.rpg.viewingImage = null">
    <div class="image-viewer-content" @click.stop>
      <img :src="$store.rpg.viewingImage?.url" alt="æŸ¥çœ‹å›¾ç‰‡" class="viewed-image" />
      <div class="image-viewer-info">
        <p><strong>å¯¹è±¡ï¼š</strong><span x-text="$store.rpg.viewingImage?.target"></span></p>
        <p><strong>æç¤ºè¯ï¼š</strong><span x-text="$store.rpg.viewingImage?.prompt"></span></p>
        <p><strong>ç”Ÿæˆæ—¶é—´ï¼š</strong><span x-text="$store.rpg.viewingImage?.timestamp"></span></p>
      </div>
      <button @click="$store.rpg.viewingImage = null" class="close-viewer-btn">âœ•</button>
    </div>
  </div>

<!-- å†’é™©è€…å…¬ä¼šé¢æ¿ï¼ˆæ–°å¢ï¼‰-->
<div x-show="$store.rpg.showGuildPanel" x-transition class="guild-overlay" @click.self="$store.rpg.showGuildPanel = false">
  <div class="guild-panel">
    <h2>ğŸ›ï¸ å†’é™©è€…å…¬ä¼š</h2>

    <!-- å†’é™©è€…ç­‰çº§å±•ç¤º -->
    <div class="adventurer-rank-display">
      <div class="rank-badge" :style="`background: ${ADVENTURER_RANKS[$store.rpg.adventurerRank].color}`">
        <span class="rank-letter" x-text="$store.rpg.adventurerRank"></span>
      </div>
      <div class="rank-info">
        <div class="rank-name" x-text="ADVENTURER_RANKS[$store.rpg.adventurerRank].name"></div>
        <div class="rank-exp-bar">
          <div class="bar">
            <div class="bar-fill exp"
              :style="`width: ${($store.rpg.adventurerExp / $store.rpg.adventurerExpToNext) * 100}%`"></div>
          </div>
          <span class="rank-exp-text" x-text="`${$store.rpg.adventurerExp} / ${$store.rpg.adventurerExpToNext}`"></span>
        </div>
      </div>
    </div>

    <!-- å½“å‰ä»»åŠ¡æ˜¾ç¤º -->
    <div x-show="$store.rpg.currentQuest" class="current-quest-section">
      <h3>ğŸ“œ å½“å‰ä»»åŠ¡</h3>
      <div class="quest-card active">
        <div class="quest-header">
          <span class="quest-type-icon" x-text="QUEST_TYPES[$store.rpg.currentQuest?.type]?.icon"></span>
          <span class="quest-title" x-text="$store.rpg.currentQuest?.title"></span>
          <span class="quest-rank-badge"
            :style="`background: ${ADVENTURER_RANKS[$store.rpg.currentQuest?.rank]?.color}`"
            x-text="$store.rpg.currentQuest?.rank"></span>
        </div>
        <div class="quest-description" x-text="$store.rpg.currentQuest?.description"></div>
        <div class="quest-guide">
          <strong>æ‰§è¡Œæç¤ºï¼š</strong>
          <span x-text="$store.rpg.currentQuest?.guide"></span>
        </div>
        <div class="quest-rewards">
          <span>ğŸ’° <span x-text="$store.rpg.currentQuest?.goldReward"></span></span>
          <span>â­ <span x-text="$store.rpg.currentQuest?.expReward"></span> å†’é™©è€…ç»éªŒ</span>
        </div>
        <div class="quest-status-buttons">
          <button
            @click="$store.rpg.setQuestStatus('in_progress')"
            :class="{ 'active': $store.rpg.currentQuest?.status === 'in_progress' }"
            class="status-btn">
            âœ… æ‰§è¡Œä¸­
          </button>
          <button
            @click="$store.rpg.setQuestStatus('on_hold')"
            :class="{ 'active': $store.rpg.currentQuest?.status === 'on_hold' }"
            class="status-btn">
            â¸ï¸ æš‚ä¸è€ƒè™‘
          </button>
          <button
            @click="$store.rpg.abandonQuest()"
            class="status-btn abandon">
            âŒ æ”¾å¼ƒä»»åŠ¡
          </button>
        </div>
        <button
          @click="$store.rpg.submitQuest()"
          :disabled="$store.rpg.questSubmitting"
          class="submit-quest-btn">
          <span x-show="!$store.rpg.questSubmitting">ğŸ“¤ æäº¤ä»»åŠ¡</span>
          <span x-show="$store.rpg.questSubmitting">æäº¤ä¸­...</span>
        </button>
      </div>
    </div>

    <!-- å¯æ¥å–ä»»åŠ¡åˆ—è¡¨ -->
    <div x-show="!$store.rpg.currentQuest" class="available-quests-section">
      <div class="quest-list-header">
        <h3>ğŸ“‹ å¯æ¥å–ä»»åŠ¡</h3>
        <div class="quest-actions">
          <button
            @click="$store.rpg.generateQuests()"
            :disabled="$store.rpg.questGenerating"
            class="action-btn-small">
            <span x-show="!$store.rpg.questGenerating">ğŸ² å¼€å§‹æ¥å–</span>
            <span x-show="$store.rpg.questGenerating">ç”Ÿæˆä¸­...</span>
          </button>
          <button
            @click="$store.rpg.refreshQuests()"
            :disabled="$store.rpg.questGenerating || $store.rpg.questList.length === 0"
            class="action-btn-small">
            ğŸ”„ åˆ·æ–°
          </button>
        </div>
      </div>

      <!-- ä»»åŠ¡åˆ—è¡¨ -->
      <div class="quest-list">
        <template x-for="quest in $store.rpg.questList" :key="quest.id">
          <div class="quest-card" @click="$store.rpg.selectQuest(quest.id)">
            <div class="quest-header">
              <span class="quest-type-icon" x-text="QUEST_TYPES[quest.type]?.icon"></span>
              <span class="quest-title" x-text="quest.title"></span>
              <span class="quest-rank-badge"
                :style="`background: ${ADVENTURER_RANKS[quest.rank]?.color}`"
                x-text="quest.rank"></span>
            </div>
            <div class="quest-brief" x-text="quest.brief"></div>
            <div class="quest-rewards">
              <span>ğŸ’° <span x-text="quest.goldReward"></span></span>
              <span>â­ <span x-text="quest.expReward"></span></span>
            </div>
          </div>
        </template>
      </div>

      <!-- ç©ºçŠ¶æ€ -->
      <div x-show="$store.rpg.questList.length === 0 && !$store.rpg.questGenerating" class="empty-state">
        ç‚¹å‡»"å¼€å§‹æ¥å–"ç”Ÿæˆä»»åŠ¡åˆ—è¡¨
      </div>
    </div>

    <button @click="$store.rpg.showGuildPanel = false" class="close-guild-btn">è¿”å›æ¸¸æˆ</button>
  </div>
</div>

  <script>
    // é€šçŸ¥çˆ¶çª—å£å‡†å¤‡å°±ç»ª
    if (window.parent !== window) {
      window.parent.postMessage('iframe:content-ready', '*');
    }

    const dzmmReady = new Promise((resolve) => {
      window.addEventListener('message', function handler(event) {
        if (event.data?.type === 'dzmm:ready') {
          window.removeEventListener('message', handler);
          resolve();
        }
      });
    });

    // ============================================================================
    // æ¸¸æˆé…ç½®å¸¸é‡
    // ============================================================================

    const GAME_CONFIG = {
      maxHistoryMessages: 15, // æœ€å¤§å†å²æ¶ˆæ¯æ•°ï¼ˆå…³é”®ä¿®å¤ï¼‰
      baseExpToLevel: 100,
      expGrowthRate: 1.5,
      fleeSuccessRate: 0.6,
      criticalRate: 0.15,
      restHealPercent: 0.3,
      maxSaveSlots: 3,
    };

// ============================================================================
// ä»»åŠ¡ç³»ç»Ÿé…ç½®ï¼ˆæ–°å¢ï¼‰
// ============================================================================

// å†’é™©è€…ç­‰çº§é…ç½®
const ADVENTURER_RANKS = {
  E: { id: 'E', name: 'Eçº§å†’é™©è€…', color: '#95a5a6', expRequired: 0, questReward: 1.0 },
  D: { id: 'D', name: 'Dçº§å†’é™©è€…', color: '#7f8c8d', expRequired: 100, questReward: 1.2 },
  C: { id: 'C', name: 'Cçº§å†’é™©è€…', color: '#3498db', expRequired: 300, questReward: 1.5 },
  B: { id: 'B', name: 'Bçº§å†’é™©è€…', color: '#9b59b6', expRequired: 600, questReward: 1.8 },
  A: { id: 'A', name: 'Açº§å†’é™©è€…', color: '#e74c3c', expRequired: 1000, questReward: 2.2 },
  S: { id: 'S', name: 'Sçº§å†’é™©è€…', color: '#f39c12', expRequired: 2000, questReward: 3.0 }
};

// ä»»åŠ¡ç±»å‹é…ç½®
const QUEST_TYPES = {
  hunt: { id: 'hunt', name: 'è®¨ä¼ä»»åŠ¡', icon: 'âš”ï¸', desc: 'æ¶ˆç­æŒ‡å®šæ€ªç‰©' },
  escort: { id: 'escort', name: 'æŠ¤é€ä»»åŠ¡', icon: 'ğŸ›¡ï¸', desc: 'ä¿æŠ¤ç›®æ ‡å®‰å…¨æŠµè¾¾' },
  gather: { id: 'gather', name: 'é‡‡é›†ä»»åŠ¡', icon: 'ğŸŒ¿', desc: 'æ”¶é›†æŒ‡å®šç‰©å“' },
  clean: { id: 'clean', name: 'æ¸…æ‰«ä»»åŠ¡', icon: 'ğŸ§¹', desc: 'æ¸…ç†æŒ‡å®šåŒºåŸŸ' },
  delivery: { id: 'delivery', name: 'è¿é€ä»»åŠ¡', icon: 'ğŸ“¦', desc: 'è¿é€ç‰©å“åˆ°ç›®çš„åœ°' },
  investigate: { id: 'investigate', name: 'è°ƒæŸ¥ä»»åŠ¡', icon: 'ğŸ”', desc: 'è°ƒæŸ¥ç‰¹å®šäº‹ä»¶' },
  rescue: { id: 'rescue', name: 'æ•‘æ´ä»»åŠ¡', icon: 'ğŸ’Š', desc: 'æ•‘åŠ©è¢«å›°äººå‘˜' }
};

// ä»»åŠ¡éš¾åº¦é…ç½®ï¼ˆæ ¹æ®å†’é™©è€…ç­‰çº§ï¼‰
const QUEST_DIFFICULTY = {
  E: { minReward: 50, maxReward: 150, expReward: 20 },
  D: { minReward: 100, maxReward: 300, expReward: 40 },
  C: { minReward: 200, maxReward: 600, expReward: 80 },
  B: { minReward: 400, maxReward: 1200, expReward: 150 },
  A: { minReward: 800, maxReward: 2500, expReward: 300 },
  S: { minReward: 1500, maxReward: 5000, expReward: 600 }
};

// ä»»åŠ¡çŠ¶æ€æšä¸¾
const QUEST_STATUS = {
  AVAILABLE: 'available',      // å¯æ¥å–
  IN_PROGRESS: 'in_progress',  // æ‰§è¡Œä¸­
  ON_HOLD: 'on_hold',          // æš‚ä¸è€ƒè™‘
  COMPLETED: 'completed',      // å·²å®Œæˆ
  FAILED: 'failed'             // å¤±è´¥
};


    const QUALITY_TAGS = 'artist:takeuchi_takashi, wanke, rella, (artist:okyou:0.4), (artist:askzy:0.3), (artist:quasarcake:0.3), (artist:wlop:0.3), (artist:nixeu:0.3), masterpiece, best quality, amazing quality, very aesthetic, absurdres, highres, newest, extreme aesthetic, year 2024, year 2023, (Visual impact:1.2), ultra-high resolution, 32K UHD, 6669, GFGoddess, unconventional supreme masterpiece, masterful details, regal atmosphere, high-end texture, fashion photography style, impactful picture, official art, movie perspective';

    const NEGATIVE_PROMPT = 'lowres, bad anatomy, bad hands, text, error, missing fingers, worst quality, low quality, jpeg artifacts, watermark, blurry, multiple views, bad proportions, deformed, ugly, duplicate, mutilated, extra limbs, fused fingers, too many fingers, long neck, cross-eyed';

    const CLASSES = [
      {
        id: 'warrior',
        name: 'æˆ˜å£«',
        icon: 'âš”ï¸',
        desc: 'é«˜ç”Ÿå‘½å’Œæ”»å‡»',
        hp: 120,
        mp: 30,
        atk: 15,
        def: 10,
        skills: ['power_strike', 'shield_bash']
      },
      {
        id: 'mage',
        name: 'æ³•å¸ˆ',
        icon: 'ğŸ”®',
        desc: 'é«˜é­”æ³•å’ŒæŠ€èƒ½',
        hp: 80,
        mp: 100,
        atk: 8,
        def: 5,
        skills: ['fireball', 'ice_lance']
      },
      {
        id: 'rogue',
        name: 'ç›—è´¼',
        icon: 'ğŸ—¡ï¸',
        desc: 'é«˜æš´å‡»å’Œé€Ÿåº¦',
        hp: 100,
        mp: 50,
        atk: 12,
        def: 7,
        skills: ['backstab', 'poison_blade']
      }
    ];

    const SKILLS = {
      power_strike: { id: 'power_strike', name: 'åŠ›åŠˆ', icon: 'ğŸ’¥', cost: 10, damage: 2.0, desc: 'å¼ºåŠ›çš„ç‰©ç†æ”»å‡»' },
      shield_bash: { id: 'shield_bash', name: 'ç›¾å‡»', icon: 'ğŸ›¡ï¸', cost: 15, damage: 1.5, stun: true, desc: 'çœ©æ™•æ•Œäºº' },
      fireball: { id: 'fireball', name: 'ç«çƒæœ¯', icon: 'ğŸ”¥', cost: 20, damage: 2.5, desc: 'é­”æ³•ç«ç„°æ”»å‡»' },
      ice_lance: { id: 'ice_lance', name: 'å†°æªæœ¯', icon: 'â„ï¸', cost: 25, damage: 2.2, slow: true, desc: 'å†°å†»å‡é€Ÿ' },
      backstab: { id: 'backstab', name: 'èƒŒåˆº', icon: 'ğŸ—¡ï¸', cost: 15, damage: 2.8, crit: 0.5, desc: 'é«˜æš´å‡»æ”»å‡»' },
      poison_blade: { id: 'poison_blade', name: 'æ¯’åˆƒ', icon: 'â˜ ï¸', cost: 12, damage: 1.5, poison: true, desc: 'æŒç»­æ¯’ä¼¤' }
    };

    const LOCATIONS = {
      town: {
        id: 'town',
        name: 'æ–°æ‰‹æ‘',
        icon: 'ğŸ˜ï¸',
        scene: 'https://opengameart.org/sites/default/files/entrance_-_brightly_lit.png',
        enemies: [],
        desc: 'å®‰å…¨çš„æ‘åº„'
      },
      forest: {
        id: 'forest',
        name: 'è¿·é›¾æ£®æ—',
        icon: 'ğŸŒ²',
        scene: 'https://opengameart.org/sites/default/files/forest_background.png',
        enemies: ['slime', 'wolf', 'goblin'],
        desc: 'å±é™©çš„æ£®æ—'
      },
      cave: {
        id: 'cave',
        name: 'é»‘æš—æ´ç©´',
        icon: 'ğŸ•³ï¸',
        scene: 'https://opengameart.org/sites/default/files/cave_background.png',
        enemies: ['bat', 'spider', 'skeleton'],
        desc: 'é˜´æš—çš„æ´ç©´'
      },
      dungeon: {
        id: 'dungeon',
        name: 'å¤ä»£åœ°ä¸‹åŸ',
        icon: 'ğŸ°',
        scene: 'https://opengameart.org/sites/default/files/dungeon_background.png',
        enemies: ['orc', 'dark_knight', 'dragon'],
        desc: 'å±é™©çš„åœ°ä¸‹åŸ'
      }
    };

    const ENEMIES = {
      slime: { id: 'slime', name: 'å²è±å§†', icon: 'ğŸŸ¢', hp: 30, atk: 5, def: 2, exp: 15, gold: 10 },
      wolf: { id: 'wolf', name: 'é‡ç‹¼', icon: 'ğŸº', hp: 50, atk: 10, def: 5, exp: 25, gold: 20 },
      goblin: { id: 'goblin', name: 'å“¥å¸ƒæ—', icon: 'ğŸ‘º', hp: 60, atk: 12, def: 6, exp: 30, gold: 25 },
      bat: { id: 'bat', name: 'è™è ', icon: 'ğŸ¦‡', hp: 40, atk: 8, def: 3, exp: 20, gold: 15 },
      spider: { id: 'spider', name: 'å·¨è››', icon: 'ğŸ•·ï¸', hp: 70, atk: 15, def: 8, exp: 40, gold: 30 },
      skeleton: { id: 'skeleton', name: 'éª·é«…å…µ', icon: 'ğŸ’€', hp: 80, atk: 18, def: 10, exp: 50, gold: 40 },
      orc: { id: 'orc', name: 'å…½äººæˆ˜å£«', icon: 'ğŸ‘¹', hp: 120, atk: 25, def: 15, exp: 80, gold: 60 },
      dark_knight: { id: 'dark_knight', name: 'é»‘æš—éª‘å£«', icon: 'âš”ï¸', hp: 150, atk: 30, def: 20, exp: 120, gold: 100 },
      dragon: { id: 'dragon', name: 'ç«é¾™', icon: 'ğŸ‰', hp: 300, atk: 50, def: 30, exp: 500, gold: 500 }
    };

    const ITEMS = {
      potion: { id: 'potion', name: 'ç”Ÿå‘½è¯æ°´', icon: 'ğŸ§ª', type: 'consumable', effect: 'heal', value: 50, price: 20, desc: 'æ¢å¤50ç‚¹ç”Ÿå‘½å€¼' },
      mana_potion: { id: 'mana_potion', name: 'é­”æ³•è¯æ°´', icon: 'ğŸ’™', type: 'consumable', effect: 'restore_mp', value: 30, price: 25, desc: 'æ¢å¤30ç‚¹é­”æ³•å€¼' },
      elixir: { id: 'elixir', name: 'ä¸‡èƒ½è¯', icon: 'âœ¨', type: 'consumable', effect: 'full_heal', value: 999, price: 100, desc: 'å®Œå…¨æ¢å¤ç”Ÿå‘½å’Œé­”æ³•' },
      iron_sword: { id: 'iron_sword', name: 'é“å‰‘', icon: 'ğŸ—¡ï¸', type: 'weapon', atk: 10, price: 50, desc: 'æ™®é€šçš„é“åˆ¶å‰‘' },
      steel_sword: { id: 'steel_sword', name: 'é’¢å‰‘', icon: 'âš”ï¸', type: 'weapon', atk: 20, price: 150, desc: 'é”‹åˆ©çš„é’¢åˆ¶å‰‘' },
      leather_armor: { id: 'leather_armor', name: 'çš®ç”²', icon: 'ğŸ¦º', type: 'armor', def: 8, price: 40, desc: 'è½»ä¾¿çš„çš®é©æŠ¤ç”²' },
      chain_mail: { id: 'chain_mail', name: 'é”å­ç”²', icon: 'ğŸ›¡ï¸', type: 'armor', def: 15, price: 120, desc: 'åšå›ºçš„é”å­ç”²' },
      ring_of_power: { id: 'ring_of_power', name: 'åŠ›é‡æˆ’æŒ‡', icon: 'ğŸ’', type: 'accessory', atk: 5, price: 80, desc: 'å¢åŠ æ”»å‡»åŠ›çš„æˆ’æŒ‡' }
    };


    // ============================================================================
    // Alpine.js Store - æ¸¸æˆçŠ¶æ€ç®¡ç†
    // ============================================================================

    document.addEventListener('alpine:init', () => {
      Alpine.store('rpg', {
        // æ¸¸æˆçŠ¶æ€
        loading: true,
        loadingText: 'æ­£åœ¨åŠ è½½å¥‡å¹»ä¸–ç•Œ...',
        gameStarted: false,
        actionLocked: false,
        inBattle: false,

  // ===== æ–°å¢ï¼šåŒæ¨¡å‹é…ç½® =====
  storyModel: 'nalang-xl-0826-16k',     
  responseModel: 'nalang-xl-0826-16k',     

        // UIçŠ¶æ€
        showCharCreation: false,
        showLoadGame: false,
        menuOpen: false,
        menuTab: 'save',
        itemModalOpen: false,
        showArtGenerator: false,
        generatingArt: false,
        artError: '',
        viewingImage: null,

        // è§’è‰²åˆ›å»º
        playerName: '',
        playerGender: 'male',
        playerAppearance: '',
        selectedClass: null,
        classes: CLASSES,

        // å­˜æ¡£ç³»ç»Ÿ
        saveSlots: {},
        currentSlot: null,

        // ç©å®¶æ•°æ®
        player: {
          name: '',
          gender: 'male',
          appearance: '',
          className: '',
          classId: '',
          level: 1,
          exp: 0,
          expToNext: 100,
          hp: 100,
          maxHp: 100,
          mp: 50,
          maxMp: 50,
          atk: 10,
          def: 5,
          gold: 100,
          location: 'town',
          inventory: {},
          equipment: {
            weapon: null,
            armor: null,
            accessory: null
          },
          skills: []
        },

  // ===== ä»»åŠ¡ç³»ç»ŸçŠ¶æ€ï¼ˆæ–°å¢ï¼‰=====
  adventurerRank: 'E',           // å½“å‰å†’é™©è€…ç­‰çº§
  adventurerExp: 0,              // å†’é™©è€…ç»éªŒ
  adventurerExpToNext: 100,      // å‡çº§æ‰€éœ€ç»éªŒ

  showGuildPanel: false,         // æ˜¯å¦æ˜¾ç¤ºå…¬ä¼šé¢æ¿
  questList: [],                 // å¯æ¥å–ä»»åŠ¡åˆ—è¡¨
  currentQuest: null,            // å½“å‰ä»»åŠ¡
  questHistory: [],              // å·²å®Œæˆä»»åŠ¡å†å²
  generatedQuestIds: [],         // å·²ç”Ÿæˆçš„ä»»åŠ¡IDï¼ˆç”¨äºåˆ·æ–°æ—¶æ’é™¤ï¼‰

  questGenerating: false,        // ä»»åŠ¡ç”Ÿæˆä¸­
  questSubmitting: false,        // ä»»åŠ¡æäº¤ä¸­

        // æˆ˜æ–—æ•°æ®
        currentEnemy: null,
        lastNPC: null,

        // UIæ•°æ®
        storyText: 'æ¬¢è¿æ¥åˆ°å¥‡å¹»ä¸–ç•Œ...',
        currentScene: LOCATIONS.town.scene,
        availableLocations: Object.values(LOCATIONS),
        targetLocation: 'town',
        playerInput: '',
        adventureLog: [],

        // é“å…·æ¨¡æ€æ¡†
        selectedItemId: null,
        selectedItemData: null,

        // ç«‹ç»˜ç”Ÿæˆ
        artTarget: 'player',
        artRequirement: '',
        gallery: [],

// ===== æ–°å¢ï¼šåŠ¨æ€å†…å®¹åº“ =====
customItems: {},      // è‡ªå®šä¹‰ç‰©å“ {itemId: itemData}
customEnemies: {},    // è‡ªå®šä¹‰æ•Œäºº {enemyId: enemyData}
customEquipment: {}, // è‡ªå®šä¹‰è£…å¤‡ {equipId: equipData}


        // ========================================================================
        // åˆå§‹åŒ–
        // ========================================================================
        async init() {
          this.loading = true;
          this.loadingText = 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...';
          await dzmmReady;

          this.loadingText = 'æ­£åœ¨åŠ è½½å­˜æ¡£...';
          await this.loadSaveSlots();
          await this.loadGallery();

  // ===== æ–°å¢ï¼šåŠ è½½è‡ªå®šä¹‰å†…å®¹ =====
  this.loadingText = 'æ­£åœ¨åŠ è½½è‡ªå®šä¹‰å†…å®¹...';
  await this.loadCustomContent();

          this.loading = false;
        },

        // ========================================================================
        // å­˜æ¡£ç³»ç»Ÿ
        // ========================================================================
        async loadSaveSlots() {
          try {
            for (let i = 1; i <= GAME_CONFIG.maxSaveSlots; i++) {
              const data = await window.dzmm.kv.get(`rpg_save_slot_${i}`);
              if (data?.value) {
                this.saveSlots[i] = JSON.parse(data.value);
              }
            }
          } catch (error) {
            console.warn('åŠ è½½å­˜æ¡£å¤±è´¥:', error);
          }
        },

        async saveGame(slotId) {
          try {
            const saveData = {
              playerName: this.player.name,
              gender: this.player.gender,
              appearance: this.player.appearance,
              className: this.player.className,
              classId: this.player.classId,
              level: this.player.level,
              location: LOCATIONS[this.player.location].name,
              timestamp: new Date().toLocaleString('zh-CN'),
              player: this.player,
              inBattle: this.inBattle,
              currentEnemy: this.currentEnemy,
              currentScene: this.currentScene,
    // ä»»åŠ¡ç³»ç»Ÿæ•°æ®ï¼ˆæ–°å¢ï¼‰
    adventurerRank: this.adventurerRank,
    adventurerExp: this.adventurerExp,
    adventurerExpToNext: this.adventurerExpToNext,
    currentQuest: this.currentQuest,
    questHistory: this.questHistory,
    generatedQuestIds: this.generatedQuestIds
            };

            await window.dzmm.kv.put(`rpg_save_slot_${slotId}`, JSON.stringify(saveData));
            this.saveSlots[slotId] = saveData;
            this.currentSlot = slotId;

            alert(`ä¿å­˜æˆåŠŸï¼å­˜æ¡£æ§½ä½ #${slotId}`);
          } catch (error) {
            console.error('ä¿å­˜å¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        },

        async loadGame(slotId) {
          try {
            const saveData = this.saveSlots[slotId];
            if (!saveData) {
              alert('æ­¤å­˜æ¡£æ§½ä½ä¸ºç©º');
              return;
            }

            this.player = saveData.player;
            this.inBattle = saveData.inBattle || false;
            this.currentEnemy = saveData.currentEnemy;
            this.currentScene = saveData.currentScene;
            this.currentSlot = slotId;

  // æ¢å¤ä»»åŠ¡ç³»ç»Ÿï¼ˆæ–°å¢ï¼‰
  this.adventurerRank = saveData.adventurerRank || 'E';
  this.adventurerExp = saveData.adventurerExp || 0;
  this.adventurerExpToNext = saveData.adventurerExpToNext || 100;
  this.currentQuest = saveData.currentQuest || null;
  this.questHistory = saveData.questHistory || [];
  this.generatedQuestIds = saveData.generatedQuestIds || [];

            this.gameStarted = true;
            this.showLoadGame = false;

            // ä»chat APIæ¢å¤æœ€åçš„å‰§æƒ…æ–‡æœ¬
            await this.restoreStoryText();

            alert('è¯»å–æˆåŠŸï¼');
          } catch (error) {
            console.error('è¯»å–å¤±è´¥:', error);
            alert('è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        },

        async restoreStoryText() {
          try {
            const messages = await window.dzmm.chat.list();
            if (messages && messages.length > 0) {
              for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].role === 'assistant') {
                  const parsed = this.parseAIResponse(messages[i].content);
                  if (parsed.ready) {
                    this.storyText = parsed.story;
                    break;
                  }
                }
              }
            }
          } catch (error) {
            console.warn('æ¢å¤å‰§æƒ…æ–‡æœ¬å¤±è´¥:', error);
          }
        },

        // ========================================================================
        // æ¸¸æˆå¼€å§‹
        // ========================================================================
        async startGame() {
          const selectedClassData = CLASSES.find(c => c.id === this.selectedClass);
          if (!selectedClassData) return;

          this.player = {
            name: this.playerName,
            gender: this.playerGender,
            appearance: this.playerAppearance,
            className: selectedClassData.name,
            classId: selectedClassData.id,
            level: 1,
            exp: 0,
            expToNext: GAME_CONFIG.baseExpToLevel,
            hp: selectedClassData.hp,
            maxHp: selectedClassData.hp,
            mp: selectedClassData.mp,
            maxMp: selectedClassData.mp,
            atk: selectedClassData.atk,
            def: selectedClassData.def,
            gold: 100,
            location: 'town',
            inventory: { potion: 3 },
            equipment: { weapon: null, armor: null, accessory: null },
            skills: selectedClassData.skills.map(id => SKILLS[id])
          };

          this.gameStarted = true;
          this.showCharCreation = false;
          this.currentScene = LOCATIONS.town.scene;
          this.addLog(`${this.player.name}å¼€å§‹äº†å†’é™©æ—…ç¨‹ï¼`);

// æ¸…ç©ºæ—§çš„chatå†å²ï¼ˆæ–°æ¸¸æˆï¼‰
try {
  const oldMessages = await window.dzmm.chat.list();
  console.log(`æ¸…ç†${oldMessages.length}æ¡æ—§æ¶ˆæ¯`);
} catch (e) {
  console.warn('æ¸…ç†å†å²å¤±è´¥:', e);
}

await this.requestAI('game_start', { userAction: 'å¼€å§‹æ¸¸æˆ' });
        },

        // ========================================================================
// ========================================================================
// AIè¯·æ±‚ - åŒæ¨¡å‹åä½œï¼ˆå®Œå…¨æ›¿æ¢åŸå‡½æ•°ï¼‰
// ========================================================================
async requestAI(action, context = {}) {
  this.actionLocked = true;
  this.storyText = '<span class="loading">æ­£åœ¨ç”Ÿæˆæ•…äº‹...</span>';

  try {
    // ===== æ­¥éª¤1ï¼šè°ƒç”¨æ­£æ–‡æ¨¡å‹ç”Ÿæˆå™äº‹ =====
    const storyContent = await this.generateStory(action, context);

    if (!storyContent) {
      throw new Error('æ­£æ–‡ç”Ÿæˆå¤±è´¥');
    }

    // æ˜¾ç¤ºç”Ÿæˆçš„æ­£æ–‡
    this.storyText = storyContent;

    // ===== æ­¥éª¤2ï¼šè°ƒç”¨å“åº”æ¨¡å‹è§£ææ­£æ–‡å¹¶æ›´æ–°æ•°æ® =====
    this.storyText = storyContent + '<br><span class="loading" style="font-size: 12px; color: #ffd43b;">æ­£åœ¨æ›´æ–°æ¸¸æˆæ•°æ®...</span>';

    await this.parseStoryAndUpdate(storyContent, action, context);

    // ç§»é™¤åŠ è½½æç¤º
    this.storyText = storyContent;

    // ===== æ­¥éª¤3ï¼šä¿å­˜åˆ°chatå†å² =====
    try {
      const toSave = [];
      if (context.userAction && context.userAction.trim()) {
        toSave.push({ role: 'user', content: context.userAction });
      }
      toSave.push({ role: 'assistant', content: storyContent });

      if (toSave.length > 0) {
        await window.dzmm.chat.insert(null, toSave);
        console.log(`å·²ä¿å­˜${toSave.length}æ¡æ¶ˆæ¯`);
      }
    } catch (saveError) {
      console.warn('ä¿å­˜æ¶ˆæ¯å¤±è´¥:', saveError);
    }

  } catch (error) {
    console.error('AIè¯·æ±‚å¤±è´¥:', error);
    this.storyText = `<p style="color: #ff4444;">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
  } finally {
    this.actionLocked = false;
  }
},

// ========================================================================
// ç”Ÿæˆæ•…äº‹æ­£æ–‡ï¼ˆæ­£æ–‡æ¨¡å‹ï¼‰
// ========================================================================
async generateStory(action, context) {
  try {
    // è¯»å–æœ€è¿‘5æ¡å†å²ï¼ˆä»…ç”¨äºæ•…äº‹è¿è´¯æ€§ï¼‰
    const allMessages = await window.dzmm.chat.list();
    const recentMessages = allMessages.slice(-5);

    // æ„å»ºç®€åŒ–çš„æ•…äº‹æç¤ºè¯
    const storyPrompt = this.buildStoryPrompt(action, context);

    const messages = [
      { role: 'user', content: storyPrompt },
      ...recentMessages.map(msg => ({ role: msg.role, content: msg.content }))
    ];

    if (context.userAction && context.userAction.trim()) {
      messages.push({ role: 'user', content: context.userAction });
    }

    let fullContent = '';

    await window.dzmm.completions(
      {
        model: this.storyModel,  // ä½¿ç”¨æ­£æ–‡æ¨¡å‹
        messages,
        maxTokens: 1000
      },
      (content, done) => {
        fullContent = content;
        if (!done) {
          // æµå¼æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰
          this.storyText = this.formatStory(fullContent);
        }
      }
    );

    return this.formatStory(fullContent);

  } catch (error) {
    console.error('æ­£æ–‡ç”Ÿæˆå¤±è´¥:', error);
    return null;
  }
},

// ========================================================================
// æ„å»ºæ•…äº‹æç¤ºè¯ï¼ˆç²¾ç®€ç‰ˆï¼Œä»…å…³æ³¨å™äº‹ï¼‰
// ========================================================================
buildStoryPrompt(action, context) {
  const genderText = this.player.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
  const appearanceText = this.player.appearance ? `ï¼Œå¤–è§‚ï¼š${this.player.appearance}` : '';

  return `ä½ æ˜¯å¥‡å¹»RPGæ¸¸æˆçš„å™äº‹è€…ï¼Œè´Ÿè´£ç”Ÿæˆç”ŸåŠ¨çš„æ•…äº‹æ–‡æœ¬ã€‚

**å½“å‰çŠ¶æ€**ï¼š
- è§’è‰²ï¼š${this.player.name}ï¼ˆ${genderText}ï¼Œ${this.player.className} Lv.${this.player.level}${appearanceText}ï¼‰
- ä½ç½®ï¼š${LOCATIONS[this.player.location].name}
- åœºæ™¯ï¼š${this.currentScene}
- HP: ${this.player.hp}/${this.player.maxHp} | MP: ${this.player.mp}/${this.player.maxMp}
${this.inBattle ? `- æˆ˜æ–—ä¸­ï¼š${this.currentEnemy.name}ï¼ˆHP: ${this.currentEnemy.hp}/${this.currentEnemy.maxHp}ï¼‰` : ''}

${this.currentQuest && this.currentQuest.status === QUEST_STATUS.IN_PROGRESS ? `
**å½“å‰ä»»åŠ¡ï¼ˆæ‰§è¡Œä¸­ï¼‰**ï¼š
ä»»åŠ¡ï¼š${this.currentQuest.title}
æè¿°ï¼š${this.currentQuest.description}
æ‰§è¡Œæç¤ºï¼š${this.currentQuest.guide}

**ä»»åŠ¡å½±å“**ï¼š
- ä½ çš„è¡ŒåŠ¨åº”è¯¥è€ƒè™‘ä»»åŠ¡ç›®æ ‡
- å¦‚æœè¡ŒåŠ¨ä¸ä»»åŠ¡ç›¸å…³ï¼Œè‡ªç„¶åœ°æ¨è¿›ä»»åŠ¡è¿›åº¦
- ä¸è¦å¼ºåˆ¶å®Œæˆä»»åŠ¡ï¼Œè®©ç©å®¶è‡ªä¸»æ¢ç´¢
` : ''}

**è¡ŒåŠ¨**ï¼š${action}
${context.damage ? `- é€ æˆä¼¤å®³ï¼š${context.damage}` : ''}
${context.skillName ? `- ä½¿ç”¨æŠ€èƒ½ï¼š${context.skillName}` : ''}
${context.enemyDamage ? `- å—åˆ°ä¼¤å®³ï¼š${context.enemyDamage}` : ''}

**è¾“å‡ºè¦æ±‚**ï¼š
1. åªè¾“å‡ºæ•…äº‹æ­£æ–‡ï¼Œä¸è¦ä»»ä½•æ ‡è®°ã€æ ¼å¼ã€æ•°æ®
2. å¿…é¡»åˆ†æ®µï¼Œæ¯æ®µ50-100å­—
3. è¯­è¨€ç”ŸåŠ¨ç®€æ´ï¼Œåœºæ™¯æå†™å’Œå¯¹è¯åˆ†å¼€
4. ç”¨ç©ºè¡Œåˆ†éš”æ®µè½

ç›´æ¥å¼€å§‹è®²è¿°æ•…äº‹ï¼š`;
},

// ========================================================================
// æ ¼å¼åŒ–æ•…äº‹æ–‡æœ¬
// ========================================================================
formatStory(text) {
  // æ¸…ç†å¯èƒ½çš„è°ƒè¯•ä¿¡æ¯
  text = text.replace(/å½“å‰çŠ¶æ€ï¼š[\s\S]*?è¡ŒåŠ¨ï¼š\w+/g, '');
  text = text.replace(/\*\*.*?\*\*/g, '');  // ç§»é™¤åŠ ç²—æ ‡è®°

  // è½¬æ¢æ¢è¡Œ
  text = text.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
  return `<p>${text.trim()}</p>`;
},

// ========================================================================
// è§£ææ•…äº‹å¹¶æ›´æ–°æ¸¸æˆæ•°æ®ï¼ˆå“åº”æ¨¡å‹ï¼‰- ä¿®å¤ç‰ˆ
// ========================================================================
async parseStoryAndUpdate(storyText, action, context) {
  try {
    // è·å–ç”¨æˆ·æœ€åè¾“å…¥ï¼ˆå¦‚æœæœ‰ï¼‰
    const userAction = context.userAction || '';

    // æ„å»ºè§£ææç¤ºè¯
    const parsePrompt = `ä½ æ˜¯æ¸¸æˆæ•°æ®åˆ†æå™¨ã€‚è¯·åˆ†ææ•…äº‹æ–‡æœ¬å’Œç”¨æˆ·è¡ŒåŠ¨ï¼Œæå–æ•°æ®å˜åŒ–ã€‚

<current_context>
**ç”¨æˆ·è¡ŒåŠ¨**ï¼š${userAction}
**æ•…äº‹æ­£æ–‡**ï¼š
${storyText}
</current_context>

<current_data>
HP:${this.player.hp}/${this.player.maxHp}
MP:${this.player.mp}/${this.player.maxMp}
ç­‰çº§:${this.player.level}
é‡‘å¸:${this.player.gold}
ç»éªŒ:${this.player.exp}/${this.player.expToNext}
å½“å‰ä½ç½®:${LOCATIONS[this.player.location].name}
æˆ˜æ–—çŠ¶æ€:${this.inBattle ? 'æˆ˜æ–—ä¸­' : 'éæˆ˜æ–—'}
${this.inBattle ? `å½“å‰æ•Œäºº:${this.currentEnemy.name}(HP:${this.currentEnemy.hp}/${this.currentEnemy.maxHp})` : ''}
</current_data>

<known_content>
**å·²çŸ¥ç‰©å“**ï¼š${Object.keys(ITEMS).concat(Object.keys(this.customItems)).join(', ')}
**å·²çŸ¥æ•Œäºº**ï¼š${Object.keys(ENEMIES).concat(Object.keys(this.customEnemies)).join(', ')}
**å·²çŸ¥è£…å¤‡**ï¼š${Object.keys(ITEMS).filter(id => ITEMS[id].type === 'weapon' || ITEMS[id].type === 'armor').concat(Object.keys(this.customEquipment)).join(', ')}
</known_content>

<rules>
### æ ¸å¿ƒè§„åˆ™
1. **æˆ˜æ–—è§¦å‘åˆ¤å®š**ï¼š
   - åªæœ‰å½“æ•…äº‹æ­£æ–‡ä¸­**æ˜ç¡®æè¿°ç©å®¶é­é‡/è¢«æ”»å‡»/è¿›å…¥æˆ˜æ–—**æ—¶ï¼Œæ‰åˆ¤å®š"æ–°æ•Œäºº"
   - å¦‚æœåªæ˜¯æåˆ°æ•Œäººåå­—ï¼ˆå¦‚"å²è±å§†å¾ˆå¸¸è§"ã€"è´­ä¹°å¯¹æŠ—å·¨å‹èœ˜è››çš„è£…å¤‡"ï¼‰ï¼Œ**ä¸è§¦å‘æˆ˜æ–—**
   - å¦‚æœå½“å‰å·²åœ¨æˆ˜æ–—ä¸­ï¼Œä¸è¦é‡å¤è§¦å‘æ–°æ•Œäºº

2. **æ•°æ®å˜åŒ–åˆ¤å®š**ï¼š
   - HP/MPå˜åŒ–ï¼šåªè®°å½•æ•…äº‹ä¸­**æ˜ç¡®æè¿°**çš„å˜åŒ–ï¼ˆå¦‚"å—åˆ°10ç‚¹ä¼¤å®³"ï¼‰
   - é‡‘å¸å˜åŒ–ï¼šåªè®°å½•æ•…äº‹ä¸­çš„äº¤æ˜“/æ‹¾å–/å¥–åŠ±
   - ç»éªŒå˜åŒ–ï¼šåªè®°å½•æ•…äº‹ä¸­çš„æˆ˜æ–—èƒœåˆ©/ä»»åŠ¡å®Œæˆ
   - **ç­‰çº§å˜åŒ–**ï¼šå¦‚æœæ•…äº‹ä¸­æåˆ°"å‡çº§"ã€"ç­‰çº§æå‡è‡³X"ï¼Œè®°å½•ç­‰çº§å˜åŒ–
   - è£…å¤‡æ›´æ–°ï¼šåªæœ‰æ•…äº‹ä¸­æ˜ç¡®"è£…å¤‡äº†XX"æ‰è®°å½•

3. **è‡ªå®šä¹‰å†…å®¹åˆ›å»ºè§„åˆ™**ï¼š
   - **å¿…é¡»åˆ›å»º**ï¼šæ•…äº‹ä¸­å‡ºç°äº†**å…¨æ–°çš„**ç‰©å“/æ•Œäºº/è£…å¤‡ï¼Œä¸”ä¸åœ¨å·²çŸ¥åˆ—è¡¨ä¸­
   - **ä¸è¦åˆ›å»º**ï¼šå¦‚æœå†…å®¹å·²å­˜åœ¨äºå·²çŸ¥åˆ—è¡¨ä¸­
   - **ç¤ºä¾‹**ï¼š
     * "å‘ç°äº†æœˆå…‰è‰" â†’ æ£€æŸ¥å·²çŸ¥ç‰©å“ â†’ å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºmoonlight_herb
     * "é‡åˆ°äº†å²è±å§†" â†’ æ£€æŸ¥å·²çŸ¥æ•Œäºº â†’ å·²å­˜åœ¨slimeï¼Œä¸åˆ›å»º
     * "å•†äººå‡ºå”®ç«ç„°å‰‘" â†’ æ£€æŸ¥å·²çŸ¥è£…å¤‡ â†’ å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºflame_sword

4. **æˆ˜æ–—ç»“æŸåˆ¤å®š**ï¼š
   - æˆ˜æ–—ç»“æŸï¼šèƒœåˆ© - æ•Œäººè¢«å‡»è´¥
   - æˆ˜æ–—ç»“æŸï¼šé€ƒè·‘ - ç©å®¶æˆåŠŸé€ƒç¦»
   - æˆ˜æ–—ç»“æŸï¼šå¤±è´¥ - ç©å®¶HPå½’é›¶
   - æˆ˜æ–—ç»§ç»­ - æˆ˜æ–—æœªç»“æŸ
</rules>

<output_format>
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼ˆæ¯è¡Œä¸€ä¸ªæ•°æ®ï¼Œç”¨å†’å·åˆ†éš”ï¼‰ï¼š

###DATA
HPå˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
MPå˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
é‡‘å¸å˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
ç»éªŒå˜åŒ–:æ•°å­—ï¼ˆæ­£æ•°ç”¨+ï¼Œè´Ÿæ•°ç”¨-ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
ç­‰çº§å˜åŒ–:æ•°å­—ï¼ˆæå‡ç”¨+ï¼Œæ— å˜åŒ–ç”¨0ï¼‰
è·å¾—ç‰©å“:IDæˆ–æ— 
è£…å¤‡æ›´æ–°:IDæˆ–æ— 
æ–°æ•Œäºº:IDæˆ–æ— 
ä½ç½®å˜åŒ–:IDæˆ–æ— 
NPCåå­—:åå­—æˆ–æ— 
æˆ˜æ–—ç»“æŸ:èƒœåˆ©/é€ƒè·‘/å¤±è´¥/ç»§ç»­
###END

###NEW
ç‰©å“:ID,åå­—,emoji,ç±»å‹,æ•ˆæœ,æ•°å€¼,æè¿°
æ•Œäºº:ID,åå­—,emoji,HP,æ”»å‡»,é˜²å¾¡,ç»éªŒ,é‡‘å¸,æè¿°
è£…å¤‡:ID,åå­—,emoji,ç±»å‹,æ”»å‡»,é˜²å¾¡,æè¿°
###END

**æ³¨æ„**ï¼š
- å¦‚æœæ²¡æœ‰å¯¹åº”å˜åŒ–ï¼Œå¡«"0"æˆ–"æ— "
- å¦‚æœæ•…äº‹ä¸­çš„å†…å®¹å·²åœ¨å·²çŸ¥åˆ—è¡¨ä¸­ï¼ŒNEWåŒºåŸŸå¡«"æ— "
- IDå‘½åï¼šè‹±æ–‡+ä¸‹åˆ’çº¿ï¼Œå¦‚moonlight_herb
</output_format>

<examples>
### ç¤ºä¾‹1ï¼šä¼‘æ¯åœºæ™¯ï¼ˆä¸è§¦å‘æˆ˜æ–—ï¼‰
**ç”¨æˆ·è¡ŒåŠ¨**ï¼šä¼‘æ¯æ¢å¤
**æ•…äº‹æ­£æ–‡**ï¼šä½ åœ¨æ–°æ‰‹æ‘çš„æ—…é¦†ä¸­ä¼‘æ¯ï¼Œæ¢å¤äº†30ç‚¹ç”Ÿå‘½å€¼ã€‚æ‘æ°‘ä»¬åœ¨è®¨è®ºæœ€è¿‘å²è±å§†å¢å¤šçš„äº‹æƒ…ã€‚

**æ­£ç¡®è¾“å‡º**ï¼š
###DATA
HPå˜åŒ–:+30
MPå˜åŒ–:0
é‡‘å¸å˜åŒ–:0
ç»éªŒå˜åŒ–:0
ç­‰çº§å˜åŒ–:0
è·å¾—ç‰©å“:æ— 
è£…å¤‡æ›´æ–°:æ— 
æ–°æ•Œäºº:æ— 
ä½ç½®å˜åŒ–:æ— 
NPCåå­—:æ— 
æˆ˜æ–—ç»“æŸ:ç»§ç»­
###END

###NEW
ç‰©å“:æ— 
æ•Œäºº:æ— 
è£…å¤‡:æ— 
###END

### ç¤ºä¾‹2ï¼šè´­ä¹°è£…å¤‡åœºæ™¯ï¼ˆä¸è§¦å‘æˆ˜æ–—ï¼‰
**ç”¨æˆ·è¡ŒåŠ¨**ï¼šè´­ä¹°è£…å¤‡
**æ•…äº‹æ­£æ–‡**ï¼šä½ æ¥åˆ°é“åŒ é“ºï¼Œå•†äººå‘ä½ æ¨èäº†ä¸€æŠŠä¸“é—¨ç”¨æ¥å¯¹æŠ—å·¨å‹èœ˜è››çš„é’¢å‰‘ï¼Œå”®ä»·150é‡‘å¸ã€‚ä½ æ”¯ä»˜äº†é‡‘å¸ï¼Œè£…å¤‡ä¸Šäº†é’¢å‰‘ã€‚

**æ­£ç¡®è¾“å‡º**ï¼š
###DATA
HPå˜åŒ–:0
MPå˜åŒ–:0
é‡‘å¸å˜åŒ–:-150
ç»éªŒå˜åŒ–:0
ç­‰çº§å˜åŒ–:0
è·å¾—ç‰©å“:æ— 
è£…å¤‡æ›´æ–°:steel_sword
æ–°æ•Œäºº:æ— 
ä½ç½®å˜åŒ–:æ— 
NPCåå­—:é“åŒ 
æˆ˜æ–—ç»“æŸ:ç»§ç»­
###END

###NEW
ç‰©å“:æ— 
æ•Œäºº:æ— 
è£…å¤‡:æ— 
###END

### ç¤ºä¾‹3ï¼šçœŸæ­£é­é‡æ•Œäººï¼ˆè§¦å‘æˆ˜æ–—ï¼‰
**ç”¨æˆ·è¡ŒåŠ¨**ï¼šæ¢ç´¢æ£®æ—
**æ•…äº‹æ­£æ–‡**ï¼šä½ æ·±å…¥è¿·é›¾æ£®æ—ï¼Œçªç„¶ä¸€åªå·¨å¤§çš„å²è±å§†ä»æ ‘ä¸›ä¸­è·³å‡ºï¼ŒæŒ¡ä½äº†ä½ çš„å»è·¯ï¼å®ƒå‘å‡ºå¨èƒæ€§çš„å«å£°ï¼Œæˆ˜æ–—å¼€å§‹äº†ï¼

**æ­£ç¡®è¾“å‡º**ï¼š
###DATA
HPå˜åŒ–:0
MPå˜åŒ–:0
é‡‘å¸å˜åŒ–:0
ç»éªŒå˜åŒ–:0
ç­‰çº§å˜åŒ–:0
è·å¾—ç‰©å“:æ— 
è£…å¤‡æ›´æ–°:æ— 
æ–°æ•Œäºº:slime
ä½ç½®å˜åŒ–:æ— 
NPCåå­—:æ— 
æˆ˜æ–—ç»“æŸ:ç»§ç»­
###END

###NEW
ç‰©å“:æ— 
æ•Œäºº:æ— 
è£…å¤‡:æ— 
###END

### ç¤ºä¾‹4ï¼šè·å¾—æ–°ç‰©å“ï¼ˆéœ€è¦åˆ›å»ºï¼‰
**ç”¨æˆ·è¡ŒåŠ¨**ï¼šæ¢ç´¢æ£®æ—
**æ•…äº‹æ­£æ–‡**ï¼šä½ åœ¨æ£®æ—æ·±å¤„å‘ç°äº†ä¸€æ ªæ•£å‘ç€é“¶è‰²å…‰èŠ’çš„æœˆå…‰è‰ï¼Œè¿™æ˜¯ä¸€ç§ç½•è§çš„è‰è¯ã€‚ä½ å°å¿ƒç¿¼ç¿¼åœ°é‡‡é›†äº†å®ƒã€‚

**æ­£ç¡®è¾“å‡º**ï¼š
###DATA
HPå˜åŒ–:0
MPå˜åŒ–:0
é‡‘å¸å˜åŒ–:0
ç»éªŒå˜åŒ–:0
ç­‰çº§å˜åŒ–:0
è·å¾—ç‰©å“:moonlight_herb
è£…å¤‡æ›´æ–°:æ— 
æ–°æ•Œäºº:æ— 
ä½ç½®å˜åŒ–:æ— 
NPCåå­—:æ— 
æˆ˜æ–—ç»“æŸ:ç»§ç»­
###END

###NEW
ç‰©å“:moonlight_herb,æœˆå…‰è‰,ğŸŒ¿,consumable,restore_mp,80,æœˆå…‰ä¸‹ç”Ÿé•¿çš„ç¥ç§˜è‰è¯ï¼Œå¯æ¢å¤å¤§é‡é­”æ³•å€¼
æ•Œäºº:æ— 
è£…å¤‡:æ— 
###END

### ç¤ºä¾‹5ï¼šå‡çº§åœºæ™¯
**ç”¨æˆ·è¡ŒåŠ¨**ï¼šå‡»è´¥å“¥å¸ƒæ—
**æ•…äº‹æ­£æ–‡**ï¼šå“¥å¸ƒæ—å‘å‡ºæœ€åçš„å“€åšå€’ä¸‹äº†ã€‚ä½ è·å¾—äº†30ç‚¹ç»éªŒå’Œ25é‡‘å¸ã€‚ä¸€é“é‡‘å…‰é—ªè¿‡ï¼Œä½ æ„Ÿåˆ°åŠ›é‡æ¶Œå…¥èº«ä½“â€”â€”ç­‰çº§æå‡è‡³2çº§ï¼

**æ­£ç¡®è¾“å‡º**ï¼š
###DATA
HPå˜åŒ–:0
MPå˜åŒ–:0
é‡‘å¸å˜åŒ–:+25
ç»éªŒå˜åŒ–:+30
ç­‰çº§å˜åŒ–:+1
è·å¾—ç‰©å“:æ— 
è£…å¤‡æ›´æ–°:æ— 
æ–°æ•Œäºº:æ— 
ä½ç½®å˜åŒ–:æ— 
NPCåå­—:æ— 
æˆ˜æ–—ç»“æŸ:èƒœåˆ©
###END

###NEW
ç‰©å“:æ— 
æ•Œäºº:æ— 
è£…å¤‡:æ— 
###END
</examples>

ç°åœ¨åˆ†æï¼š`;

    let responseText = '';

    await window.dzmm.completions(
      {
        model: this.responseModel,
        messages: [{ role: 'user', content: parsePrompt }],
        maxTokens: 400
      },
      (content, done) => {
        responseText = content;
      }
    );

    // è§£ææ–°å†…å®¹
    this.parseNewContent(responseText);

    // åº”ç”¨æ•°æ®å˜åŒ–
    this.applyDataChanges(responseText, action);

  } catch (error) {
    console.error('æ•°æ®è§£æå¤±è´¥:', error);
  }
},

// ========================================================================
// åº”ç”¨æ•°æ®å˜åŒ–ï¼ˆä¿®å¤ç‰ˆï¼‰
// ========================================================================
applyDataChanges(responseText, action) {
  try {
    const dataMarker = '###DATA';
    const endMarker = '###END';
    const dataIndex = responseText.indexOf(dataMarker);
    const endIndex = responseText.indexOf(endMarker, dataIndex + dataMarker.length);

    if (dataIndex === -1 || endIndex === -1) {
      console.warn('å“åº”æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡æ•°æ®æ›´æ–°');
      return;
    }

    const dataBlock = responseText.slice(dataIndex + dataMarker.length, endIndex).trim();
    const lines = dataBlock.split('\n');

    console.log('===== æ•°æ®è§£æ =====');
    console.log(dataBlock);

    // ===== ä¿®å¤ï¼šæŠ€èƒ½ä½¿ç”¨æ—¶è·³è¿‡MPå˜åŒ– =====
    const skipMPUpdate = action === 'use_skill';

    lines.forEach(line => {
      const [key, value] = line.split(':').map(s => s.trim());

      // HPå˜åŒ–
      if (key === 'HPå˜åŒ–' && value !== '0') {
        const change = parseInt(value);
        if (!isNaN(change)) {
          this.player.hp = Math.max(0, Math.min(this.player.maxHp, this.player.hp + change));
          console.log(`HPå˜åŒ–: ${change > 0 ? '+' : ''}${change}`);
        }
      }

      // MPå˜åŒ–ï¼ˆæŠ€èƒ½ä½¿ç”¨æ—¶è·³è¿‡ï¼‰
      if (key === 'MPå˜åŒ–' && value !== '0' && !skipMPUpdate) {
        const change = parseInt(value);
        if (!isNaN(change)) {
          this.player.mp = Math.max(0, Math.min(this.player.maxMp, this.player.mp + change));
          console.log(`MPå˜åŒ–: ${change > 0 ? '+' : ''}${change}`);
        }
      } else if (skipMPUpdate) {
        console.log('æŠ€èƒ½ä½¿ç”¨ï¼Œè·³è¿‡MPæ›´æ–°ï¼ˆé¿å…é‡å¤æ‰£é™¤ï¼‰');
      }

      // é‡‘å¸å˜åŒ–
      if (key === 'é‡‘å¸å˜åŒ–' && value !== '0') {
        const change = parseInt(value);
        if (!isNaN(change)) {
          this.player.gold = Math.max(0, this.player.gold + change);
          console.log(`é‡‘å¸å˜åŒ–: ${change > 0 ? '+' : ''}${change}`);
        }
      }

      // ===== ä¿®å¤ï¼šç­‰çº§å˜åŒ– =====
      if (key === 'ç­‰çº§å˜åŒ–' && value !== '0') {
        const change = parseInt(value);
        if (!isNaN(change) && change > 0) {
          for (let i = 0; i < change; i++) {
            this.levelUpDirect();
          }
          console.log(`ç­‰çº§æå‡: +${change}`);
        }
      }

      // ç»éªŒå€¼å˜åŒ–
      if (key === 'ç»éªŒå˜åŒ–' && value !== '0') {
        const change = parseInt(value);
        if (!isNaN(change)) {
          this.addExperience(change);
          console.log(`ç»éªŒå€¼å˜åŒ–: ${change > 0 ? '+' : ''}${change}`);
        }
      }

      // è·å¾—ç‰©å“
      if (key === 'è·å¾—ç‰©å“' && value !== 'æ— ') {
        const itemData = this.getItemData(value);
        if (itemData) {
          this.addItem(value, 1);
          console.log(`è·å¾—ç‰©å“: ${itemData.name}`);
        } else {
          console.warn(`æœªæ‰¾åˆ°ç‰©å“: ${value}`);
        }
      }

      // è£…å¤‡æ›´æ–°
      if (key === 'è£…å¤‡æ›´æ–°' && value !== 'æ— ') {
        const item = this.getItemData(value);
        if (item && (item.type === 'weapon' || item.type === 'armor')) {
          if (item.type === 'weapon') {
            this.player.equipment.weapon = value;
            this.player.atk += item.atk || 0;
          } else if (item.type === 'armor') {
            this.player.equipment.armor = value;
            this.player.def += item.def || 0;
          }
          console.log(`è£…å¤‡æ›´æ–°: ${item.name}`);
        } else {
          console.warn(`æœªæ‰¾åˆ°è£…å¤‡æˆ–ç±»å‹é”™è¯¯: ${value}`);
        }
      }

      // æ–°æ•Œäººï¼ˆåªåœ¨éæˆ˜æ–—çŠ¶æ€ä¸‹è§¦å‘ï¼‰
      if (key === 'æ–°æ•Œäºº' && value !== 'æ— ' && !this.inBattle) {
        const enemyData = this.getEnemyData(value);
        if (enemyData) {
          this.triggerBattleFromAI(value);
          console.log(`è§¦å‘æˆ˜æ–—: ${enemyData.name}`);
        } else {
          console.warn(`æœªæ‰¾åˆ°æ•Œäºº: ${value}`);
        }
      }

      // ä½ç½®å˜åŒ–
      if (key === 'ä½ç½®å˜åŒ–' && value !== 'æ— ' && LOCATIONS[value]) {
        this.player.location = value;
        this.currentScene = LOCATIONS[value].scene;
        console.log(`ä½ç½®å˜åŒ–: ${LOCATIONS[value].name}`);
      }

      // NPCè®°å½•
      if (key === 'NPCåå­—' && value !== 'æ— ') {
        this.lastNPC = value;
        console.log(`è®°å½•NPC: ${value}`);
      }

      // ===== ä¿®å¤ï¼šæˆ˜æ–—ç»“æŸåˆ¤å®š =====
      if (key === 'æˆ˜æ–—ç»“æŸ' && this.inBattle) {
        if (value === 'èƒœåˆ©') {
          console.log('æˆ˜æ–—èƒœåˆ©ï¼Œå‘æ”¾å¥–åŠ±');
          this.winBattleReward();
        } else if (value === 'é€ƒè·‘') {
          console.log('æˆåŠŸé€ƒè·‘');
          this.inBattle = false;
          this.currentEnemy = null;
        } else if (value === 'å¤±è´¥') {
          console.log('æˆ˜æ–—å¤±è´¥');
          this.gameOver();
        }
        // 'ç»§ç»­'åˆ™ä¸åšå¤„ç†
      }
    });

  } catch (error) {
    console.error('åº”ç”¨æ•°æ®å˜åŒ–å¤±è´¥:', error);
  }
},

// ========================================================================
// ç»éªŒå€¼å¤„ç†ï¼ˆæ–°å¢å‡½æ•°ï¼‰
// ========================================================================
addExperience(exp) {
  this.player.exp += exp;

  // å¾ªç¯æ£€æŸ¥å‡çº§ï¼ˆå¤„ç†æº¢å‡ºç»éªŒï¼‰
  while (this.player.exp >= this.player.expToNext) {
    const overflow = this.player.exp - this.player.expToNext;
    this.levelUpDirect();
    this.player.exp = overflow;  // ä¿ç•™æº¢å‡ºç»éªŒ
    console.log(`æº¢å‡ºç»éªŒ: ${overflow}`);
  }
},

// ========================================================================
// ä»»åŠ¡ç³»ç»Ÿé€»è¾‘ï¼ˆæ–°å¢ï¼‰
// ========================================================================

// ç”Ÿæˆä»»åŠ¡åˆ—è¡¨
async generateQuests() {
  if (this.questGenerating) return;

  this.questGenerating = true;
  this.loadingText = 'æ­£åœ¨ç”Ÿæˆä»»åŠ¡...';

  try {
    const prompt = `ä½ æ˜¯å†’é™©è€…å…¬ä¼šçš„ä»»åŠ¡å‘å¸ƒå‘˜ã€‚è¯·ä¸º${this.adventurerRank}çº§å†’é™©è€…ç”Ÿæˆ5ä¸ªä¸åŒç±»å‹çš„ä»»åŠ¡ã€‚

<current_context>
å†’é™©è€…ç­‰çº§ï¼š${this.adventurerRank}çº§ï¼ˆ${ADVENTURER_RANKS[this.adventurerRank].name}ï¼‰
å½“å‰ä½ç½®ï¼š${LOCATIONS[this.player.location].name}
ç©å®¶ç­‰çº§ï¼š${this.player.level}
ç©å®¶èŒä¸šï¼š${this.player.className}
</current_context>

<quest_types>
${Object.values(QUEST_TYPES).map(t => `${t.icon} ${t.name}ï¼š${t.desc}`).join('\n')}
</quest_types>

<difficulty_config>
${this.adventurerRank}çº§ä»»åŠ¡å¥–åŠ±èŒƒå›´ï¼š${QUEST_DIFFICULTY[this.adventurerRank].minReward}-${QUEST_DIFFICULTY[this.adventurerRank].maxReward}é‡‘å¸
å†’é™©è€…ç»éªŒå¥–åŠ±ï¼š${QUEST_DIFFICULTY[this.adventurerRank].expReward}ç‚¹
</difficulty_config>

<exclude_list>
${this.generatedQuestIds.length > 0 ? `ä»¥ä¸‹ä»»åŠ¡IDå·²ç”Ÿæˆè¿‡ï¼Œä¸è¦é‡å¤ï¼š${this.generatedQuestIds.join(', ')}` : 'æ— æ’é™¤é¡¹'}
</exclude_list>

<output_format>
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹XMLæ ¼å¼è¾“å‡º5ä¸ªä»»åŠ¡ï¼š

<quest>
<id>ä»»åŠ¡IDï¼ˆè‹±æ–‡+ä¸‹åˆ’çº¿ï¼Œå¦‚hunt_wolves_forestï¼‰</id>
<type>ä»»åŠ¡ç±»å‹ï¼ˆhunt/escort/gather/clean/delivery/investigate/rescueä¹‹ä¸€ï¼‰</type>
<title>ä»»åŠ¡æ ‡é¢˜ï¼ˆ15å­—å†…ï¼‰</title>
<brief>ç®€è¦æè¿°ï¼ˆ30å­—å†…ï¼‰</brief>
<goldReward>é‡‘å¸å¥–åŠ±ï¼ˆæ•°å­—ï¼Œåœ¨é…ç½®èŒƒå›´å†…ï¼‰</goldReward>
</quest>

**è¦æ±‚**ï¼š
1. 5ä¸ªä»»åŠ¡ç±»å‹å¿…é¡»ä¸åŒ
2. ä»»åŠ¡IDä¸å¾—ä¸æ’é™¤åˆ—è¡¨é‡å¤
3. ä»»åŠ¡éš¾åº¦ç¬¦åˆ${this.adventurerRank}çº§å†’é™©è€…
4. ä»»åŠ¡å†…å®¹ä¸å½“å‰ä½ç½®ã€èŒä¸šç›¸å…³
5. æ ‡é¢˜å¸å¼•äººï¼Œç®€è¦æè¿°æ¸…æ™°
</output_format>

<examples>
<quest>
<id>hunt_slimes_forest</id>
<type>hunt</type>
<title>æ£®æ—å²è±å§†æ¸…ç†</title>
<brief>æ¶ˆç­è¿·é›¾æ£®æ—ä¸­çš„5åªå²è±å§†</brief>
<goldReward>120</goldReward>
</quest>

<quest>
<id>escort_merchant_town</id>
<type>escort</type>
<title>æŠ¤é€å•†äººå›åŸ</title>
<brief>ä¿æŠ¤å•†äººå®‰å…¨è¿”å›æ–°æ‰‹æ‘</brief>
<goldReward>180 </goldReward>
</quest>
</examples>

ç°åœ¨å¼€å§‹ç”Ÿæˆï¼š`;

    let responseText = '';
    await window.dzmm.completions(
      {
        model: this.responseModel,
        messages: [{ role: 'user', content: prompt }],
        maxTokens: 1000
      },
      (content, done) => {
        responseText = content;
      }
    );

    console.log('===== ä»»åŠ¡ç”ŸæˆåŸå§‹è¿”å› =====');
    console.log(responseText);

    // è§£æä»»åŠ¡åˆ—è¡¨
    const questMatches = [...responseText.matchAll(/<quest>[\s\S]*?<id>(.*?)<\/id>[\s\S]*?<type>(.*?)<\/type>[\s\S]*?<title>(.*?)<\/title>[\s\S]*?<brief>(.*?)<\/brief>[\s\S]*?<goldReward>(\d+)<\/goldReward>[\s\S]*?<\/quest>/g)];

    if (questMatches.length === 0) {
      console.error('ä»»åŠ¡è§£æå¤±è´¥');
      alert('ä»»åŠ¡ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
      return;
    }

    this.questList = questMatches.map(match => ({
      id: match[1].trim(),
      type: match[2].trim(),
      title: match[3].trim(),
      brief: match[4].trim(),
      goldReward: parseInt(match[5]),
      expReward: QUEST_DIFFICULTY[this.adventurerRank].expReward,
      rank: this.adventurerRank
    }));

    // è®°å½•å·²ç”Ÿæˆçš„ä»»åŠ¡ID
    this.generatedQuestIds.push(...this.questList.map(q => q.id));

    console.log(`æˆåŠŸç”Ÿæˆ ${this.questList.length} ä¸ªä»»åŠ¡`);

  } catch (error) {
    console.error('ä»»åŠ¡ç”Ÿæˆå¤±è´¥:', error);
    alert('ä»»åŠ¡ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
  } finally {
    this.questGenerating = false;
  }
},

// åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ï¼ˆæ’é™¤å·²ç”Ÿæˆçš„ï¼‰
async refreshQuests() {
  this.questList = [];
  await this.generateQuests();
},

// é€‰æ‹©ä»»åŠ¡å¹¶ç”Ÿæˆè¯¦æƒ…
async selectQuest(questId) {
  const quest = this.questList.find(q => q.id === questId);
  if (!quest) return;

  this.questGenerating = true;
  this.loadingText = 'æ­£åœ¨ç”Ÿæˆä»»åŠ¡è¯¦æƒ…...';

  try {
    const prompt = `ä½ æ˜¯å†’é™©è€…å…¬ä¼šçš„ä»»åŠ¡å‘å¸ƒå‘˜ã€‚è¯·ä¸ºä»¥ä¸‹ä»»åŠ¡ç”Ÿæˆè¯¦ç»†ä»‹ç»ã€‚

<quest_basic>
ä»»åŠ¡IDï¼š${quest.id}
ä»»åŠ¡ç±»å‹ï¼š${QUEST_TYPES[quest.type].name}
ä»»åŠ¡æ ‡é¢˜ï¼š${quest.title}
ç®€è¦æè¿°ï¼š${quest.brief}
</quest_basic>

<output_format>
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

<description>
ä»»åŠ¡çš„è¯¦ç»†èƒŒæ™¯å’Œè¦æ±‚ï¼ˆ100-200å­—ï¼Œè®²è¿°ä»»åŠ¡æ¥æºã€ç›®æ ‡ã€æ³¨æ„äº‹é¡¹ï¼‰
</description>

<guide>
æ‰§è¡Œæç¤ºï¼ˆ50å­—å†…ï¼Œå‘Šè¯‰ç©å®¶å¦‚ä½•å®Œæˆä»»åŠ¡ï¼Œå¦‚"å‰å¾€è¿·é›¾æ£®æ—ï¼Œæ¶ˆç­5åªå²è±å§†åè¿”å›å…¬ä¼š"ï¼‰
</guide>
</output_format>

<example>
<description>
æœ€è¿‘è¿·é›¾æ£®æ—ä¸­çš„å²è±å§†æ•°é‡æ¿€å¢ï¼Œå¨èƒåˆ°äº†é™„è¿‘æ‘æ°‘çš„å®‰å…¨ã€‚æ‘é•¿å§”æ‰˜å…¬ä¼šæ´¾é£å†’é™©è€…å‰å¾€æ¸…ç†ã€‚å²è±å§†è™½ç„¶æ”»å‡»åŠ›ä¸å¼ºï¼Œä½†æ•°é‡ä¼—å¤šï¼Œè¯·åŠ¡å¿…å°å¿ƒã€‚å®Œæˆä»»åŠ¡åï¼Œæ‘æ°‘ä»¬ä¼šéå¸¸æ„Ÿæ¿€ã€‚
</description>

<guide>
å‰å¾€è¿·é›¾æ£®æ—ï¼Œæ¶ˆç­5åªå²è±å§†ï¼Œç„¶åè¿”å›å…¬ä¼šæäº¤ä»»åŠ¡
</guide>
</example>

ç°åœ¨ç”Ÿæˆï¼š`;

    let responseText = '';
    await window.dzmm.completions(
      {
        model: this.responseModel,
        messages: [{ role: 'user', content: prompt }],
        maxTokens: 500
      },
      (content, done) => {
        responseText = content;
      }
    );

    // è§£æè¯¦æƒ…
    const descMatch = responseText.match(/<description>([\s\S]*?)<\/description>/);
    const guideMatch = responseText.match(/<guide>([\s\S]*?)<\/guide>/);

    if (!descMatch || !guideMatch) {
      console.error('ä»»åŠ¡è¯¦æƒ…è§£æå¤±è´¥');
      alert('ä»»åŠ¡è¯¦æƒ…ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
      return;
    }

    // è®¾ç½®å½“å‰ä»»åŠ¡
    this.currentQuest = {
      ...quest,
      description: descMatch[1].trim(),
      guide: guideMatch[1].trim(),
      status: QUEST_STATUS.IN_PROGRESS
    };

    this.questList = [];
    this.addLog(`æ¥å–ä»»åŠ¡ï¼š${quest.title}`);

  } catch (error) {
    console.error('ä»»åŠ¡è¯¦æƒ…ç”Ÿæˆå¤±è´¥:', error);
    alert('ä»»åŠ¡è¯¦æƒ…ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
  } finally {
    this.questGenerating = false;
  }
},

// è®¾ç½®ä»»åŠ¡çŠ¶æ€
setQuestStatus(status) {
  if (!this.currentQuest) return;
  this.currentQuest.status = status;
  console.log(`ä»»åŠ¡çŠ¶æ€å˜æ›´ä¸ºï¼š${status}`);
},

// æ”¾å¼ƒä»»åŠ¡
abandonQuest() {
  if (!this.currentQuest) return;

  const fee = 50; // æ‰‹ç»­è´¹
  if (this.player.gold < fee) {
    alert('é‡‘å¸ä¸è¶³ï¼Œæ— æ³•æ”¯ä»˜æ”¾å¼ƒä»»åŠ¡çš„æ‰‹ç»­è´¹');
    return;
  }

  if (!confirm(`æ”¾å¼ƒä»»åŠ¡å°†æ‰£é™¤${fee}é‡‘å¸æ‰‹ç»­è´¹ï¼Œç¡®å®šè¦æ”¾å¼ƒå—ï¼Ÿ`)) {
    return;
  }

  this.player.gold -= fee;
  this.addLog(`æ”¾å¼ƒä»»åŠ¡ï¼š${this.currentQuest.title}ï¼Œæ‰£é™¤${fee}é‡‘å¸`);

  // é‡ç½®ä»»åŠ¡ç³»ç»Ÿ
  this.currentQuest = null;
  this.questList = [];
  this.generatedQuestIds = [];
},

// æäº¤ä»»åŠ¡
async submitQuest() {
  if (!this.currentQuest || this.questSubmitting) return;

  this.questSubmitting = true;
  this.actionLocked = true;
  this.loadingText = 'æ­£åœ¨æäº¤ä»»åŠ¡...';

  try {
    // æ­¥éª¤1ï¼šç”Ÿæˆæäº¤å‰§æƒ…ï¼ˆæ­£æ–‡æ¨¡å‹ï¼‰
    const submitPrompt = `ä½ æ˜¯å¥‡å¹»RPGæ¸¸æˆçš„å™äº‹è€…ã€‚ç©å®¶æ­£åœ¨å‘å†’é™©è€…å…¬ä¼šæäº¤ä»»åŠ¡ã€‚

**å½“å‰çŠ¶æ€**ï¼š
è§’è‰²ï¼š${this.player.name}ï¼ˆ${this.player.className}ï¼‰
ç­‰çº§ï¼š${this.player.level}

**ä»»åŠ¡ä¿¡æ¯**ï¼š
ä»»åŠ¡ï¼š${this.currentQuest.title}
æè¿°ï¼š${this.currentQuest.description}
æ‰§è¡Œæç¤ºï¼š${this.currentQuest.guide}

**æœ€è¿‘è¡ŒåŠ¨**ï¼š
${(await this.getRecentHistory(3)).map(msg => msg.content).join('\n')}

**å½“å‰è¡ŒåŠ¨**ï¼šç©å®¶è¿”å›å†’é™©è€…å…¬ä¼šï¼Œç”³è¯·æäº¤ä»»åŠ¡

**è¦æ±‚**ï¼š
1. æè¿°ç©å®¶ä¸å…¬ä¼šæ¥å¾…å‘˜çš„å¯¹è¯ï¼ˆ100-200å­—ï¼‰
2. æ¥å¾…å‘˜ä¼šè¯¢é—®ä»»åŠ¡å®Œæˆæƒ…å†µ
3. ç©å®¶éœ€è¦æ±‡æŠ¥è‡ªå·±çš„è¡ŒåŠ¨å’Œæˆæœ
4. å¯¹è¯è¦è‡ªç„¶ã€çœŸå®

ç°åœ¨å¼€å§‹è®²è¿°ï¼š`;

    let storyContent = '';
    await window.dzmm.completions(
      {
        model: this.storyModel,
        messages: [{ role: 'user', content: submitPrompt }],
        maxTokens: 500
      },
      (content, done) => {
        storyContent = content;
        this.storyText = `<p>${storyContent.replace(/\n\n/g, '</p><p>')}</p>`;
      }
    );

    // æ­¥éª¤2ï¼šAIåˆ¤æ–­ä»»åŠ¡å®Œæˆåº¦ï¼ˆå“åº”æ¨¡å‹ï¼‰
    const judgePrompt = `ä½ æ˜¯å†’é™©è€…å…¬ä¼šçš„ä»»åŠ¡å®¡æ ¸å‘˜ã€‚è¯·æ ¹æ®ç©å®¶çš„æ±‡æŠ¥ï¼Œåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆã€‚

<quest>
ä»»åŠ¡ï¼š${this.currentQuest.title}
ç±»å‹ï¼š${QUEST_TYPES[this.currentQuest.type].name}
æè¿°ï¼š${this.currentQuest.description}
è¦æ±‚ï¼š${this.currentQuest.guide}
</quest>

<player_report>
${storyContent}
</player_report>

<rules>
1. æ ¹æ®å¯¹è¯å†…å®¹åˆ¤æ–­ä»»åŠ¡å®Œæˆæƒ…å†µ
2. è®¨ä¼ä»»åŠ¡ï¼šéœ€è¦æ˜ç¡®å‡»è´¥ç›®æ ‡
3. æŠ¤é€ä»»åŠ¡ï¼šéœ€è¦ç›®æ ‡å®‰å…¨æŠµè¾¾
4. é‡‡é›†ä»»åŠ¡ï¼šéœ€è¦æ”¶é›†åˆ°ç‰©å“
5. å…¶ä»–ä»»åŠ¡ï¼šæ ¹æ®æè¿°åˆç†åˆ¤æ–­

åˆ¤æ–­æ ‡å‡†ï¼š
- å®Œå…¨å®Œæˆï¼šç©å®¶æ˜ç¡®å®Œæˆäº†æ‰€æœ‰è¦æ±‚
- éƒ¨åˆ†å®Œæˆï¼šç©å®¶å®Œæˆäº†éƒ¨åˆ†è¦æ±‚
- æœªå®Œæˆï¼šç©å®¶æ²¡æœ‰å®Œæˆè¦æ±‚æˆ–æ²¡æœ‰ç›¸å…³è¡ŒåŠ¨
</rules>

<output_format>
###RESULT
å®Œæˆåº¦:å®Œå…¨å®Œæˆ/éƒ¨åˆ†å®Œæˆ/æœªå®Œæˆ
åŸå› :ç®€è¦è¯´æ˜ï¼ˆ20å­—å†…ï¼‰
###END
</output_format>

ç°åœ¨åˆ¤æ–­ï¼š`;

    let judgeResult = '';
    await window.dzmm.completions(
      {
        model: this.responseModel,
        messages: [{ role: 'user', content: judgePrompt }],
        maxTokens: 200
      },
      (content, done) => {
        judgeResult = content;
      }
    );

    console.log('===== ä»»åŠ¡åˆ¤å®šç»“æœ =====');
    console.log(judgeResult);

    // è§£æåˆ¤å®šç»“æœ
    const resultMatch = judgeResult.match(/å®Œæˆåº¦:(.*?)\n/);
    const reasonMatch = judgeResult.match(/åŸå› :(.*?)\n/);

    const completion = resultMatch ? resultMatch[1].trim() : 'æœªå®Œæˆ';
    const reason = reasonMatch ? reasonMatch[1].trim() : '';

    // æ­¥éª¤3ï¼šç»“ç®—å¥–åŠ±
    if (completion === 'å®Œå…¨å®Œæˆ') {
      // å…¨é¢å¥–åŠ±
      this.player.gold += this.currentQuest.goldReward;
      this.addAdventurerExp(this.currentQuest.expReward);

      this.addLog(`âœ… ä»»åŠ¡å®Œæˆï¼è·å¾—${this.currentQuest.goldReward}é‡‘å¸å’Œ${this.currentQuest.expReward}å†’é™©è€…ç»éªŒ`);

      // æ·»åŠ åˆ°å†å²
      this.questHistory.push({
        ...this.currentQuest,
        completedAt: new Date().toISOString()
      });

      // è¿½åŠ ç»“ç®—å‰§æƒ…
      this.storyText += `<p style="color: #4caf50; font-weight: bold;">ä»»åŠ¡å®Œæˆï¼ä½ è·å¾—äº†${this.currentQuest.goldReward}é‡‘å¸å’Œ${this.currentQuest.expReward}ç‚¹å†’é™©è€…ç»éªŒã€‚</p>`;

    } else if (completion === 'éƒ¨åˆ†å®Œæˆ') {
      // 50%å¥–åŠ±
      const halfGold = Math.floor(this.currentQuest.goldReward * 0.5);
      const halfExp = Math.floor(this.currentQuest.expReward * 0.5);

      this.player.gold += halfGold;
      this.addAdventurerExp(halfExp);

      this.addLog(`âš ï¸ ä»»åŠ¡éƒ¨åˆ†å®Œæˆï¼š${reason}ã€‚è·å¾—${halfGold}é‡‘å¸å’Œ${halfExp}å†’é™©è€…ç»éªŒ`);

      this.storyText += `<p style="color: #f39c12; font-weight: bold;">ä»»åŠ¡éƒ¨åˆ†å®Œæˆï¼ˆ${reason}ï¼‰ã€‚ä½ è·å¾—äº†${halfGold}é‡‘å¸å’Œ${halfExp}ç‚¹å†’é™©è€…ç»éªŒã€‚</p>`;

    } else {
      // æ— å¥–åŠ±
      this.addLog(`âŒ ä»»åŠ¡æœªå®Œæˆï¼š${reason}`);
      this.storyText += `<p style="color: #e74c3c; font-weight: bold;">ä»»åŠ¡æœªå®Œæˆï¼ˆ${reason}ï¼‰ã€‚è¯·ç»§ç»­åŠªåŠ›å®Œæˆä»»åŠ¡è¦æ±‚ã€‚</p>`;
      return; // ä¸é‡ç½®ä»»åŠ¡ï¼Œè®©ç©å®¶ç»§ç»­å°è¯•
    }

    // ä¿å­˜åˆ°chatå†å²
    await window.dzmm.chat.insert(null, [
      { role: 'user', content: 'æäº¤ä»»åŠ¡ï¼š' + this.currentQuest.title },
      { role: 'assistant', content: storyContent }
    ]);

    // é‡ç½®ä»»åŠ¡ç³»ç»Ÿ
    this.currentQuest = null;
    this.questList = [];
    this.generatedQuestIds = [];

  } catch (error) {
    console.error('ä»»åŠ¡æäº¤å¤±è´¥:', error);
    alert('ä»»åŠ¡æäº¤å¤±è´¥ï¼š' + error.message);
  } finally {
    this.questSubmitting = false;
    this.actionLocked = false;
  }
},

// æ·»åŠ å†’é™©è€…ç»éªŒ
addAdventurerExp(exp) {
  this.adventurerExp += exp;

  // æ£€æŸ¥å‡çº§
  const ranks = Object.keys(ADVENTURER_RANKS);
  const currentIndex = ranks.indexOf(this.adventurerRank);

  if (currentIndex < ranks.length - 1) {
    const nextRank = ranks[currentIndex + 1];
    const nextRequired = ADVENTURER_RANKS[nextRank].expRequired;

    if (this.adventurerExp >= nextRequired) {
      this.adventurerRank = nextRank;
      this.adventurerExpToNext = currentIndex + 2 < ranks.length
        ? ADVENTURER_RANKS[ranks[currentIndex + 2]].expRequired
        : 99999;

      this.addLog(`ğŸ‰ å†’é™©è€…ç­‰çº§æå‡è‡³${ADVENTURER_RANKS[nextRank].name}ï¼`);
      alert(`ğŸ‰ æ­å–œï¼ä½ çš„å†’é™©è€…ç­‰çº§æå‡è‡³${ADVENTURER_RANKS[nextRank].name}ï¼`);
    }
  }
},

// è·å–æœ€è¿‘Næ¡å†å²
async getRecentHistory(count = 3) {
  const allMessages = await window.dzmm.chat.list();
  return allMessages.slice(-count);
},


// ç›´æ¥å‡çº§ï¼ˆä¸é‡ç½®ç»éªŒï¼‰
levelUpDirect() {
  this.player.level++;
  this.player.expToNext = Math.floor(GAME_CONFIG.baseExpToLevel * Math.pow(GAME_CONFIG.expGrowthRate, this.player.level - 1));

  const hpGain = 20;
  const mpGain = 10;
  const atkGain = 3;
  const defGain = 2;

  this.player.maxHp += hpGain;
  this.player.maxMp += mpGain;
  this.player.atk += atkGain;
  this.player.def += defGain;
  this.player.hp = this.player.maxHp;
  this.player.mp = this.player.maxMp;

  this.addLog(`ğŸ‰ å‡çº§äº†ï¼ç­‰çº§æå‡è‡³${this.player.level}ï¼`);
  console.log(`å‡çº§è‡³ Lv.${this.player.level}ï¼Œä¸‹ä¸€çº§éœ€è¦ ${this.player.expToNext} ç»éªŒ`);
},

// ========================================================================
// æˆ˜æ–—èƒœåˆ©å¥–åŠ±ï¼ˆæ–°å¢å‡½æ•°ï¼‰
// ========================================================================
winBattleReward() {
  if (!this.currentEnemy) return;

  const expGain = this.currentEnemy.exp;
  const goldGain = this.currentEnemy.gold;

  // ç›´æ¥è®¡ç®—å¥–åŠ±
  this.addExperience(expGain);
  this.player.gold += goldGain;

  this.addLog(`å‡»è´¥${this.currentEnemy.name}ï¼è·å¾—${expGain}EXPå’Œ${goldGain}é‡‘å¸`);

  // 30%æ¦‚ç‡æ‰è½ç‰©å“
  if (Math.random() < 0.3) {
    const dropItem = 'potion';
    this.addItem(dropItem, 1);
    this.addLog(`è·å¾—äº†${ITEMS[dropItem].name}ï¼`);
  }

  // ç»“æŸæˆ˜æ–—
  this.inBattle = false;
  this.currentEnemy = null;
},


// ========================================================================
// è§£æå¹¶æ³¨å†Œæ–°å†…å®¹ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
// ========================================================================
parseNewContent(responseText) {
  try {
    const newMarker = '###NEW';
    const endMarker = '###END';
    const newIndex = responseText.indexOf(newMarker);
    const endIndex = responseText.indexOf(endMarker, newIndex + newMarker.length);

    if (newIndex === -1 || endIndex === -1) {
      console.warn('æœªæ‰¾åˆ°NEWæ ‡è®°');
      return;
    }

    const newBlock = responseText.slice(newIndex + newMarker.length, endIndex).trim();
    const lines = newBlock.split('\n');

    console.log('===== æ–°å†…å®¹è§£æ =====');
    console.log(newBlock);

    lines.forEach(line => {
      const [key, value] = line.split(':').map(s => s.trim());

      // è§£ææ–°ç‰©å“ï¼ˆç®€åŒ–æ ¼å¼ï¼šID,åå­—,emoji,ç±»å‹,æ•ˆæœ,æ•°å€¼,æè¿°ï¼‰
      if (key === 'ç‰©å“' && value !== 'æ— ') {
        try {
          const parts = value.split(',').map(s => s.trim());
          if (parts.length >= 7) {
            const [id, name, icon, type, effect, val, desc] = parts;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (ITEMS[id] || this.customItems[id]) {
              console.log(`ç‰©å“${id}å·²å­˜åœ¨ï¼Œè·³è¿‡æ³¨å†Œ`);
              return;
            }

            const itemData = {
              id, name, icon, type, effect,
              value: parseInt(val) || 0,
              desc,
              price: parseInt(val) * 2 || 20  // è‡ªåŠ¨è®¡ç®—ä»·æ ¼
            };

            this.customItems[id] = itemData;
            console.log(`âœ… æ³¨å†Œæ–°ç‰©å“: ${name} (${id})`);
            this.saveCustomContent();
          }
        } catch (error) {
          console.error('è§£ææ–°ç‰©å“å¤±è´¥:', error, value);
        }
      }

      // è§£ææ–°æ•Œäººï¼ˆç®€åŒ–æ ¼å¼ï¼šID,åå­—,emoji,HP,æ”»å‡»,é˜²å¾¡,ç»éªŒ,é‡‘å¸,æè¿°ï¼‰
      if (key === 'æ•Œäºº' && value !== 'æ— ') {
        try {
          const parts = value.split(',').map(s => s.trim());
          if (parts.length >= 9) {
            const [id, name, icon, hp, atk, def, exp, gold, desc] = parts;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (ENEMIES[id] || this.customEnemies[id]) {
              console.log(`æ•Œäºº${id}å·²å­˜åœ¨ï¼Œè·³è¿‡æ³¨å†Œ`);
              return;
            }

            const enemyData = {
              id, name, icon,
              hp: parseInt(hp) || 50,
              atk: parseInt(atk) || 10,
              def: parseInt(def) || 5,
              exp: parseInt(exp) || 30,
              gold: parseInt(gold) || 20,
              desc
            };

            this.customEnemies[id] = enemyData;
            console.log(`âœ… æ³¨å†Œæ–°æ•Œäºº: ${name} (${id})`);
            this.saveCustomContent();
          }
        } catch (error) {
          console.error('è§£ææ–°æ•Œäººå¤±è´¥:', error, value);
        }
      }

      // è§£ææ–°è£…å¤‡ï¼ˆç®€åŒ–æ ¼å¼ï¼šID,åå­—,emoji,ç±»å‹,æ”»å‡»,é˜²å¾¡,æè¿°ï¼‰
      if (key === 'è£…å¤‡' && value !== 'æ— ') {
        try {
          const parts = value.split(',').map(s => s.trim());
          if (parts.length >= 7) {
            const [id, name, icon, type, atk, def, desc] = parts;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (ITEMS[id] || this.customEquipment[id]) {
              console.log(`è£…å¤‡${id}å·²å­˜åœ¨ï¼Œè·³è¿‡æ³¨å†Œ`);
              return;
            }

            const equipData = {
              id, name, icon, type,
              atk: parseInt(atk) || 0,
              def: parseInt(def) || 0,
              desc,
              price: (parseInt(atk) + parseInt(def)) * 10 || 50
            };

            this.customEquipment[id] = equipData;
            console.log(`âœ… æ³¨å†Œæ–°è£…å¤‡: ${name} (${id})`);
            this.saveCustomContent();
          }
        } catch (error) {
          console.error('è§£ææ–°è£…å¤‡å¤±è´¥:', error, value);
        }
      }
    });

  } catch (error) {
    console.error('æ–°å†…å®¹è§£æå¤±è´¥:', error);
  }
},

// ========================================================================
// ä¿å­˜è‡ªå®šä¹‰å†…å®¹åˆ°KV
// ========================================================================
async saveCustomContent() {
  try {
    await window.dzmm.kv.put('rpg_custom_items', JSON.stringify(this.customItems));
    await window.dzmm.kv.put('rpg_custom_enemies', JSON.stringify(this.customEnemies));
    await window.dzmm.kv.put('rpg_custom_equipment', JSON.stringify(this.customEquipment));
    console.log('è‡ªå®šä¹‰å†…å®¹å·²ä¿å­˜');
  } catch (error) {
    console.error('ä¿å­˜è‡ªå®šä¹‰å†…å®¹å¤±è´¥:', error);
  }
},

// ========================================================================
// åŠ è½½è‡ªå®šä¹‰å†…å®¹ï¼ˆæ¸¸æˆå¯åŠ¨æ—¶è°ƒç”¨ï¼‰
// ========================================================================
async loadCustomContent() {
  try {
    const items = await window.dzmm.kv.get('rpg_custom_items');
    const enemies = await window.dzmm.kv.get('rpg_custom_enemies');
    const equipment = await window.dzmm.kv.get('rpg_custom_equipment');

    if (items?.value) {
      this.customItems = JSON.parse(items.value);
      console.log(`åŠ è½½${Object.keys(this.customItems).length}ä¸ªè‡ªå®šä¹‰ç‰©å“`);
    }

    if (enemies?.value) {
      this.customEnemies = JSON.parse(enemies.value);
      console.log(`åŠ è½½${Object.keys(this.customEnemies).length}ä¸ªè‡ªå®šä¹‰æ•Œäºº`);
    }

    if (equipment?.value) {
      this.customEquipment = JSON.parse(equipment.value);
      console.log(`åŠ è½½${Object.keys(this.customEquipment).length}ä¸ªè‡ªå®šä¹‰è£…å¤‡`);
    }
  } catch (error) {
    console.warn('åŠ è½½è‡ªå®šä¹‰å†…å®¹å¤±è´¥:', error);
  }
},



 // ========================================================================
// AIè§¦å‘æˆ˜æ–—ï¼ˆæ”¯æŒè‡ªå®šä¹‰æ•Œäººï¼‰
// ========================================================================
triggerBattleFromAI(enemyId) {
  const enemyData = this.getEnemyData(enemyId);  // â† ä¿®æ”¹ä¸ºä½¿ç”¨æ–°å‡½æ•°

  if (!enemyData) {
    console.error(`æ— æ•ˆçš„æ•ŒäººID: ${enemyId}`);
    return;
  }

  console.log(`AIè§¦å‘æˆ˜æ–—: ${enemyData.name}`);

  this.currentEnemy = {
    ...enemyData,
    hp: enemyData.hp,
    maxHp: enemyData.hp
  };

  this.inBattle = true;
  this.addLog(`é­é‡${this.currentEnemy.name}ï¼`);
},

        // æˆ˜æ–—ç³»ç»Ÿ
        // ========================================================================
        async attack() {
          if (!this.inBattle || !this.currentEnemy) return;

          const baseDamage = Math.max(1, this.player.atk - this.currentEnemy.def);
          const isCrit = Math.random() < GAME_CONFIG.criticalRate;
          const damage = Math.floor(baseDamage * (isCrit ? 2 : 1));

          this.currentEnemy.hp = Math.max(0, this.currentEnemy.hp - damage);

          this.addLog(`æ”»å‡»${this.currentEnemy.name}ï¼Œé€ æˆ${damage}ç‚¹ä¼¤å®³${isCrit ? 'ï¼ˆæš´å‡»ï¼ï¼‰' : ''}`);

          await this.requestAI('attack', { damage, userAction: 'æ™®é€šæ”»å‡»' });

          if (this.currentEnemy.hp <= 0) {
            await this.winBattle();
            return;
          }

          await this.enemyTurn();
        },

// ========================================================================
// ä½¿ç”¨æŠ€èƒ½ï¼ˆä¿®å¤ç‰ˆï¼‰
// ========================================================================
async useSkill(skill) {
  if (!this.inBattle || !this.currentEnemy) return;
  if (this.player.mp < skill.cost) return;

  // å…ˆæ‰£é™¤MP
  this.player.mp -= skill.cost;

  const baseDamage = Math.floor(this.player.atk * skill.damage);
  const isCrit = Math.random() < (GAME_CONFIG.criticalRate + (skill.crit || 0));
  const damage = Math.floor(baseDamage * (isCrit ? 2 : 1));

  this.currentEnemy.hp = Math.max(0, this.currentEnemy.hp - damage);

  this.addLog(`ä½¿ç”¨${skill.name}ï¼Œé€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);

  // ===== ä¿®å¤ï¼šä¼ é€’actionæ ‡è¯†ï¼Œè·³è¿‡MPæ›´æ–° =====
  await this.requestAI('use_skill', {
    skillName: skill.name,
    damage,
    userAction: `ä½¿ç”¨æŠ€èƒ½${skill.name}`
  });

  if (this.currentEnemy.hp <= 0) {
    // æˆ˜æ–—èƒœåˆ©ç”±å“åº”æ¨¡å‹åˆ¤å®š
    return;
  }

  await this.enemyTurn();
},

        async enemyTurn() {
          await new Promise(resolve => setTimeout(resolve, 800));

          const enemyDamage = Math.max(1, this.currentEnemy.atk - this.player.def);
          this.player.hp = Math.max(0, this.player.hp - enemyDamage);

          this.addLog(`${this.currentEnemy.name}æ”»å‡»ï¼Œå—åˆ°${enemyDamage}ç‚¹ä¼¤å®³ï¼`);

          await this.requestAI('enemy_attack', { enemyDamage, userAction: `${this.currentEnemy.name}çš„å›åˆ` });

          if (this.player.hp <= 0) {
            await this.gameOver();
          }
        },

// ========================================================================
// æˆ˜æ–—èƒœåˆ©ï¼ˆæ—§å‡½æ•°ï¼Œæ”¹ä¸ºåªå¤„ç†AIå™è¿°ï¼‰
// ========================================================================
async winBattle() {
  // å¥–åŠ±å·²ç”±winBattleReward()å¤„ç†ï¼Œè¿™é‡Œåªè´Ÿè´£AIå™è¿°
  const defeatedEnemy = this.currentEnemy.name;
  await this.requestAI('win_battle', { userAction: `å‡»è´¥${defeatedEnemy}` });
},

        async flee() {
          if (Math.random() < GAME_CONFIG.fleeSuccessRate) {
            this.addLog('æˆåŠŸé€ƒè·‘äº†ï¼');
            this.inBattle = false;
            this.currentEnemy = null;
            await this.requestAI('flee_success', { userAction: 'é€ƒè·‘' });
          } else {
            this.addLog('é€ƒè·‘å¤±è´¥ï¼');
            await this.requestAI('flee_failed', { userAction: 'é€ƒè·‘å¤±è´¥' });
            await this.enemyTurn();
          }
        },

        async levelUp() {
          this.player.level++;
          this.player.exp = 0;
          this.player.expToNext = Math.floor(GAME_CONFIG.baseExpToLevel * Math.pow(GAME_CONFIG.expGrowthRate, this.player.level - 1));

          const hpGain = 20;
          const mpGain = 10;
          const atkGain = 3;
          const defGain = 2;

          this.player.maxHp += hpGain;
          this.player.maxMp += mpGain;
          this.player.atk += atkGain;
          this.player.def += defGain;
          this.player.hp = this.player.maxHp;
          this.player.mp = this.player.maxMp;

          this.addLog(`ğŸ‰ å‡çº§äº†ï¼ç­‰çº§æå‡è‡³${this.player.level}ï¼`);
        },

        async gameOver() {
          this.addLog('ä½ è¢«å‡»è´¥äº†...');
          this.storyText = '<p style="color: #ff4444; font-size: 24px;">æ¸¸æˆç»“æŸ</p><p>è¯·ä»èœå•è¯»å–å­˜æ¡£æˆ–é‡æ–°å¼€å§‹</p>';
          this.actionLocked = true;
        },

        // ========================================================================
        // ========================================================================
        // æ¢ç´¢ç³»ç»Ÿï¼ˆå·²ä¿®å¤ï¼‰
        // ========================================================================
        async explore() {
          const location = LOCATIONS[this.player.location];

          if (location.enemies.length === 0) {
            this.addLog('è¿™é‡Œå¾ˆå®‰å…¨ï¼Œæ²¡æœ‰é‡åˆ°æ•Œäºº');
            await this.requestAI('explore_safe', { userAction: 'æ¢ç´¢å½“å‰åŒºåŸŸ' });
            return;
          }

          if (Math.random() < 0.6) {
            const enemyId = location.enemies[Math.floor(Math.random() * location.enemies.length)];
            const enemyData = ENEMIES[enemyId];

            this.currentEnemy = {
              ...enemyData,
              hp: enemyData.hp,
              maxHp: enemyData.hp
            };

            this.inBattle = true;
            this.addLog(`é‡åˆ°äº†${this.currentEnemy.name}ï¼`);
            await this.requestAI('encounter_enemy', { userAction: 'æ¢ç´¢å½“å‰åŒºåŸŸ' });
          } else {
            const goldFound = Math.floor(Math.random() * 50) + 20;
            this.player.gold += goldFound;
            this.addLog(`å‘ç°äº†å®ç®±ï¼è·å¾—${goldFound}é‡‘å¸`);
            await this.requestAI('find_treasure', { reward: `${goldFound}é‡‘å¸`, userAction: 'æ¢ç´¢å½“å‰åŒºåŸŸ' });
          }
        },

        async move() {
          if (this.targetLocation === this.player.location) {
            this.addLog('ä½ å·²ç»åœ¨è¿™é‡Œäº†');
            return;
          }

          const targetName = LOCATIONS[this.targetLocation].name;
          this.player.location = this.targetLocation;
          this.currentScene = LOCATIONS[this.targetLocation].scene;
          this.addLog(`å‰å¾€${targetName}`);

          await this.requestAI('move_location', { userAction: `å‰å¾€${targetName}` });
        },

        async rest() {
          const hpRestore = Math.floor(this.player.maxHp * GAME_CONFIG.restHealPercent);
          const mpRestore = Math.floor(this.player.maxMp * GAME_CONFIG.restHealPercent);

          this.player.hp = Math.min(this.player.maxHp, this.player.hp + hpRestore);
          this.player.mp = Math.min(this.player.maxMp, this.player.mp + mpRestore);

          this.addLog(`ä¼‘æ¯æ¢å¤äº†${hpRestore}HPå’Œ${mpRestore}MP`);
          await this.requestAI('rest', { userAction: 'ä¼‘æ¯æ¢å¤' });
        },

        async talk() {
          this.addLog('ä¸NPCäº¤è°ˆä¸­...');
          await this.requestAI('talk_npc', { userAction: 'ä¸NPCå¯¹è¯' });
        },

        // ========================================================================
        // ç‰©å“ç³»ç»Ÿï¼ˆå·²ä¼˜åŒ–ï¼‰
        // ========================================================================
        showItemModal(itemId) {
          this.selectedItemId = itemId;
          this.selectedItemData = ITEMS[itemId];
          this.itemModalOpen = true;
        },

// ========================================================================
// ç¡®è®¤ä½¿ç”¨ç‰©å“ï¼ˆæ”¯æŒè‡ªå®šä¹‰ç‰©å“ï¼‰
// ========================================================================
confirmUseItem() {
  if (!this.selectedItemId) return;

  const item = this.getItemData(this.selectedItemId);  // â† ä¿®æ”¹ä¸ºä½¿ç”¨æ–°å‡½æ•°
  if (!item) return;

  if (!this.player.inventory[this.selectedItemId] || this.player.inventory[this.selectedItemId] <= 0) {
    alert('æ²¡æœ‰è¿™ä¸ªç‰©å“');
    return;
  }

  this.player.inventory[this.selectedItemId]--;
  if (this.player.inventory[this.selectedItemId] === 0) {
    delete this.player.inventory[this.selectedItemId];
  }

  // åº”ç”¨ç‰©å“æ•ˆæœ
  if (item.effect === 'heal') {
    this.player.hp = Math.min(this.player.maxHp, this.player.hp + item.value);
    this.addLog(`ä½¿ç”¨${item.name}ï¼Œæ¢å¤${item.value}HP`);
  } else if (item.effect === 'restore_mp') {
    this.player.mp = Math.min(this.player.maxMp, this.player.mp + item.value);
    this.addLog(`ä½¿ç”¨${item.name}ï¼Œæ¢å¤${item.value}MP`);
  } else if (item.effect === 'full_heal') {
    this.player.hp = this.player.maxHp;
    this.player.mp = this.player.maxMp;
    this.addLog(`ä½¿ç”¨${item.name}ï¼Œå®Œå…¨æ¢å¤ï¼`);
  }

  this.itemModalOpen = false;
},

        addItem(itemId, count = 1) {
          if (!this.player.inventory[itemId]) {
            this.player.inventory[itemId] = 0;
          }
          this.player.inventory[itemId] += count;
        },

// ========================================================================
// è·å–ç‰©å“æ•°æ®ï¼ˆæ”¯æŒè‡ªå®šä¹‰ç‰©å“ï¼‰
// ========================================================================
getItemData(itemId) {
  // ä¼˜å…ˆæŸ¥æ‰¾é¢„è®¾ç‰©å“
  if (ITEMS[itemId]) {
    return ITEMS[itemId];
  }
  // æŸ¥æ‰¾è‡ªå®šä¹‰ç‰©å“
  if (this.customItems[itemId]) {
    return this.customItems[itemId];
  }
  // æŸ¥æ‰¾è‡ªå®šä¹‰è£…å¤‡
  if (this.customEquipment[itemId]) {
    return this.customEquipment[itemId];
  }
  return null;
},

// ========================================================================
// è·å–æ•Œäººæ•°æ®ï¼ˆæ”¯æŒè‡ªå®šä¹‰æ•Œäººï¼‰
// ========================================================================
getEnemyData(enemyId) {
  // ä¼˜å…ˆæŸ¥æ‰¾é¢„è®¾æ•Œäºº
  if (ENEMIES[enemyId]) {
    return ENEMIES[enemyId];
  }
  // æŸ¥æ‰¾è‡ªå®šä¹‰æ•Œäºº
  if (this.customEnemies[enemyId]) {
    return this.customEnemies[enemyId];
  }
  return null;
},

        getItemDescription(itemId) {
          const item = ITEMS[itemId];
          return item?.desc || 'æ— æè¿°';
        },

        // ========================================================================
        // ç»˜å›¾ç³»ç»Ÿï¼ˆæ–°å¢ï¼‰
        // ========================================================================
        async generateArt() {
          this.generatingArt = true;
          this.artError = '';

          try {
            // 1. æ„å»ºåœºæ™¯ä¿¡æ¯
            const sceneInfo = this.buildSceneInfo();

            // 2. ç”Ÿæˆæç¤ºè¯
            this.loadingText = 'æ­£åœ¨ç”Ÿæˆæç¤ºè¯...';
            const prompt = await this.generatePrompt(sceneInfo);

            // 3. æ‹¼æ¥è´¨é‡è¯
            const fullPrompt = `${prompt}, ${QUALITY_TAGS}`;

            // 4. è°ƒç”¨ç»˜å›¾API
            this.loadingText = 'æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...';
            const result = await window.dzmm.draw.generate({
              prompt: fullPrompt,
              negativePrompt: NEGATIVE_PROMPT,
              model: 'anime',
              dimension: '2:3'
            });

            if (result.images && result.images.length > 0) {
              // 5. ä¿å­˜åˆ°ç”»å»Š
              await this.saveToGallery(result.images[0], this.getTargetName(), prompt);

              alert('ç”ŸæˆæˆåŠŸï¼å·²ä¿å­˜åˆ°ç”»å»Š');
              this.showArtGenerator = false;
              this.artRequirement = '';
            } else {
              throw new Error('ç”Ÿæˆå¤±è´¥ï¼Œæœªè¿”å›å›¾ç‰‡');
            }
          } catch (error) {
            console.error('ç”Ÿæˆå¤±è´¥:', error);
            this.artError = error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•';
          } finally {
            this.generatingArt = false;
          }
        },

        buildSceneInfo() {
          let targetInfo = '';

          if (this.artTarget === 'player') {
            const genderText = this.player.gender === 'male' ? 'male' : 'female';
            const appearanceText = this.player.appearance || 'no specific appearance';
            targetInfo = `Character: ${this.player.name}, Gender: ${genderText}, Class: ${this.player.className}, Appearance: ${appearanceText}`;
          } else if (this.artTarget === 'npc' && this.lastNPC) {
            targetInfo = `NPC: ${this.lastNPC}`;
          } else if (this.artTarget === 'enemy' && this.currentEnemy) {
            targetInfo = `Enemy: ${this.currentEnemy.name}`;
          }

          const sceneText = this.storyText.replace(/<[^>]*>/g, '').substring(0, 500);
          const customReq = this.artRequirement || 'no specific requirement';

          return `${targetInfo}\nCurrent scene: ${sceneText}\nCustom requirement: ${customReq}`;
        },

        async generatePrompt(sceneInfo) {
          try {
            const systemPrompt = `You are a professional AI art prompt generator. Generate an English prompt for anime-style character illustration based on the following information.

${sceneInfo}

Output format:
###PROMPT
[English prompt, comma-separated keywords, max 200 words]
###END

Requirements:
- Only output English prompt, no explanation
- Describe character appearance, clothing, pose, expression
- Describe background and atmosphere
- Use comma-separated keywords
- Focus on visual details

Example:
###PROMPT
1girl, long silver hair, blue eyes, wearing white dress, gentle smile, standing in forest, sunlight filtering through trees, fantasy atmosphere, detailed face, beautiful lighting
###END`;

            let fullContent = '';

            await window.dzmm.completions(
              { model: this.responseModel, messages: [{ role: 'user', content: systemPrompt }], maxTokens: 500 },
              (content, done) => {
                fullContent = content;
              }
            );

            // è§£ææç¤ºè¯
            const promptMarker = '###PROMPT';
            const endMarker = '###END';
            const promptIndex = fullContent.indexOf(promptMarker);
            const endIndex = fullContent.indexOf(endMarker, promptIndex + promptMarker.length);

            if (promptIndex !== -1 && endIndex !== -1) {
              const prompt = fullContent.slice(promptIndex + promptMarker.length, endIndex).trim();
              console.log('ç”Ÿæˆçš„æç¤ºè¯:', prompt);
              return prompt;
            } else {
              throw new Error('æç¤ºè¯æ ¼å¼é”™è¯¯');
            }
          } catch (error) {
            console.error('ç”Ÿæˆæç¤ºè¯å¤±è´¥:', error);
            throw new Error('æç¤ºè¯ç”Ÿæˆå¤±è´¥');
          }
        },

        getTargetName() {
          if (this.artTarget === 'player') {
            return this.player.name;
          } else if (this.artTarget === 'npc' && this.lastNPC) {
            return this.lastNPC;
          } else if (this.artTarget === 'enemy' && this.currentEnemy) {
            return this.currentEnemy.name;
          }
          return 'æœªçŸ¥';
        },

        async saveToGallery(imageUrl, target, prompt) {
          const imageData = {
            id: `img-${Date.now()}`,
            url: imageUrl,
            target,
            prompt,
            timestamp: new Date().toLocaleString('zh-CN')
          };

          this.gallery.push(imageData);

          // ä¿å­˜åˆ°KV
          try {
            await window.dzmm.kv.put('rpg_gallery', JSON.stringify(this.gallery));
          } catch (error) {
            console.warn('ä¿å­˜ç”»å»Šå¤±è´¥:', error);
          }
        },

        async loadGallery() {
          try {
            const data = await window.dzmm.kv.get('rpg_gallery');
            if (data?.value) {
              this.gallery = JSON.parse(data.value);
            }
          } catch (error) {
            console.warn('åŠ è½½ç”»å»Šå¤±è´¥:', error);
          }
        },

        viewImage(img) {
          this.viewingImage = img;
        },

        async deleteImage(imageId) {
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;

          this.gallery = this.gallery.filter(img => img.id !== imageId);

          try {
            await window.dzmm.kv.put('rpg_gallery', JSON.stringify(this.gallery));
            alert('åˆ é™¤æˆåŠŸ');
          } catch (error) {
            console.error('åˆ é™¤å¤±è´¥:', error);
            alert('åˆ é™¤å¤±è´¥');
          }
        },

        // ========================================================================
        // ========================================================================
        // å·¥å…·å‡½æ•°
        // ========================================================================
        addLog(message) {
          this.adventureLog.unshift(`[${new Date().toLocaleTimeString()}] ${message}`);
          if (this.adventureLog.length > 20) {
            this.adventureLog.pop();
          }
        },

        // ========================================================================
        // è‡ªç”±è¾“å…¥è¡ŒåŠ¨ï¼ˆä¿®å¤"å‘é€"æŒ‰é’®ï¼‰
        // ========================================================================
        async customAction() {
          const input = this.playerInput.trim();
          if (!input) {
            this.addLog('è¯·è¾“å…¥è¡ŒåŠ¨å†…å®¹');
            return;
          }

          this.playerInput = '';
          this.addLog(`è‡ªå®šä¹‰è¡ŒåŠ¨: ${input}`);

          await this.requestAI('custom_action', { userAction: input });
        }
      });

      // ä¿®å¤åˆå§‹åŒ–æ—¶æœº
      queueMicrotask(() => {
        if (Alpine.store('rpg')?.init) {
          Alpine.store('rpg').init();
        }
      });
    });
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* åŠ è½½å±å¹• */
    .loading-screen {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-content {
      text-align: center;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top-color: #4caf50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* è§’è‰²åˆ›å»º */
    .char-creation {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .creation-card {
      max-width: 900px;
      width: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .creation-card h1 {
      font-size: 36px;
      margin-bottom: 30px;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .creation-card h2 {
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
    }

    /* ä¸»èœå• */
    .main-menu {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .menu-option {
      width: 100%;
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .menu-option:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .model-selection {
      margin-top: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
    }

    .model-selection label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .model-selection select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
    }

    /* å­˜æ¡£ç•Œé¢ */
    .load-game-screen {
      animation: fadeIn 0.3s;
    }

    .save-slots {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .save-slot {
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .save-slot:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #4caf50;
      transform: translateY(-2px);
    }

    .save-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .save-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      font-weight: bold;
    }

    .save-details {
      display: flex;
      gap: 15px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }

    .save-time {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
    }

    .empty-slot {
      text-align: center;
      padding: 20px;
      color: rgba(255, 255, 255, 0.5);
    }

    /* è§’è‰²åˆ›å»ºè¡¨å• */
    .char-creation-form {
      animation: fadeIn 0.3s;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #4caf50;
      background: rgba(255, 255, 255, 0.15);
    }

    .form-group small {
      display: block;
      margin-top: 5px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
    }

    .gender-selection {
      display: flex;
      gap: 10px;
    }

    .gender-btn {
      flex: 1;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 16px;
    }

    .gender-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .gender-btn.selected {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-color: #667eea;
    }

    .class-selection {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
    }

    .class-card {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .class-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-3px);
    }

    .class-card.selected {
      border-color: #4caf50;
      background: rgba(76, 175, 80, 0.2);
    }

    .class-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .class-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .class-desc {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 12px;
    }

    .class-stats {
      display: flex;
      justify-content: space-around;
      font-size: 13px;
    }

    .start-btn,
    .back-btn {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .start-btn {
      background: linear-gradient(135deg, #4caf50, #45a049);
      color: #fff;
    }

    .start-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
    }

    .start-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* æ¸¸æˆä¸»ç•Œé¢ */
    .game-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .menu-btn,
    .art-btn {
      position: fixed;
      top: 20px;
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
      z-index: 100;
      font-size: 16px;
    }

    .menu-btn {
      left: 20px;
    }

    .art-btn {
      right: 20px;
    }

    .menu-btn:hover,
    .art-btn:hover {
      background: rgba(0, 0, 0, 0.9);
      border-color: #4caf50;
      transform: translateY(-2px);
    }

/* å…¬ä¼šæŒ‰é’®ï¼ˆæ–°å¢ï¼‰*/
.guild-btn {
  position: fixed;
  top: 20px;
  right: 180px;
  padding: 12px 20px;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  color: #fff;
  cursor: pointer;
  transition: all 0.3s;
  z-index: 100;
  font-size: 16px;
}

.guild-btn:hover {
  background: rgba(0, 0, 0, 0.9);
  border-color: #f39c12;
  transform: translateY(-2px);
}


    /* çŠ¶æ€æ  */
    .status-bar {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      margin-top: 60px;
    }

    .player-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .player-name {
      font-size: 20px;
      font-weight: bold;
    }

    .player-class {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }

    .player-level {
      padding: 4px 12px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 12px;
      font-weight: bold;
    }

    .player-stats {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 400px;
    }

    .stat-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .stat-label {
      min-width: 60px;
    }

    .bar {
      flex: 1;
      height: 18px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      transition: width 0.3s ease;
    }

    .bar-fill.hp {
      background: linear-gradient(90deg, #ff6b6b, #ee5a6f);
    }

    .bar-fill.mp {
      background: linear-gradient(90deg, #4dabf7, #339af0);
    }

    .bar-fill.exp {
      background: linear-gradient(90deg, #ffd43b, #fab005);
    }

    .stat-value {
      min-width: 80px;
      text-align: right;
      font-size: 13px;
    }

    .player-resources {
      display: flex;
      gap: 20px;
      font-size: 16px;
    }

    .resource {
      padding: 8px 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    /* ä¸»è¦å†…å®¹åŒº */
    .main-content {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* åœºæ™¯åŒºåŸŸ */
    .scene-area {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .scene-image {
      height: 400px;
      background-size: cover;
      background-position: center;
      border-radius: 15px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .enemy-display {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      animation: enemyAppear 0.5s ease-out;
    }

    @keyframes enemyAppear {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }

      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    .enemy-image {
      margin-bottom: 15px;
    }

    .enemy-icon {
      font-size: 120px;
      filter: drop-shadow(0 0 20px rgba(255, 0, 0, 0.5));
      animation: enemyFloat 2s ease-in-out infinite;
    }

    @keyframes enemyFloat {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .enemy-info {
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
    }

    .enemy-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #ff6b6b;
    }

    .enemy-hp-bar {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .enemy-hp-bar .bar {
      flex: 1;
      height: 20px;
    }

    .story-box {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      min-height: 200px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .story-content {
      font-size: 16px;
      line-height: 1.8;
      color: rgba(255, 255, 255, 0.95);
    }

    .story-content p {
      margin-bottom: 15px;
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    /* æ§åˆ¶é¢æ¿ */
    .control-panel {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 600px;
      overflow-y: auto;
    }

    .battle-actions,
    .explore-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .battle-actions h3,
    .explore-actions h3 {
      margin-bottom: 10px;
      font-size: 18px;
      color: #4caf50;
    }

    .action-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .action-btn.flee {
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
    }

    .skills-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .skill-btn {
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }

    .skill-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.2);
      border-color: #4caf50;
    }

    .skill-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .skill-cost {
      font-size: 12px;
      color: #4dabf7;
    }

    .location-select {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .location-select label {
      display: flex;
      align-items: center;
      font-size: 14px;
    }

    .location-select select {
      flex: 1;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }

    .location-select button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #4caf50, #45a049);
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
    }

    .free-input {
      display: flex;
      gap: 10px;
      padding-top: 15px;
      border-top: 2px solid rgba(255, 255, 255, 0.1);
    }

    .free-input input {
      flex: 1;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }

    .free-input input:focus {
      outline: none;
      border-color: #4caf50;
    }

    .free-input button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
    }

    /* èœå•è¦†ç›–å±‚ */
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .menu-panel {
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .menu-panel h2 {
      text-align: center;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .menu-tabs {
      display: flex;
      gap: 10px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 10px;
      flex-wrap: wrap;
    }

    .menu-tab {
      flex: 1;
      min-width: 100px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border: none;
      border-radius: 8px;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .menu-tab:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .menu-tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }

    .menu-content {
      flex: 1;
      overflow-y: auto;
      max-height: 500px;
    }

    .menu-page {
      animation: fadeIn 0.3s;
    }

    .menu-page h3 {
      margin-bottom: 15px;
      font-size: 20px;
      color: #4caf50;
    }

    /* å­˜æ¡£é¡µ */
    .save-slots-menu {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .save-slot-menu {
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
    }

    .save-info-menu {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .save-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .save-action-btn {
      flex: 1;
      padding: 8px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .save-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .empty-slot-menu {
      text-align: center;
      padding: 20px;
      color: rgba(255, 255, 255, 0.5);
    }

    .empty-slot-menu button {
      margin-top: 10px;
    }

    /* èƒŒåŒ…é¡µ */
    .inventory-grid-menu {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
    }

    .item-card-menu {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .item-card-menu:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #4caf50;
      transform: translateY(-3px);
    }

    .item-icon {
      font-size: 36px;
      margin-bottom: 8px;
    }

    .item-name {
      font-size: 13px;
      margin-bottom: 5px;
    }

    .item-count {
      font-size: 12px;
      color: #ffd43b;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.5);
      font-size: 14px;
    }

    /* è£…å¤‡é¡µ */
    .equipment-slots-menu {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .equip-slot-menu {
      display: flex;
      justify-content: space-between;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    .equip-label {
      font-weight: bold;
    }

    .equip-value {
      color: rgba(255, 255, 255, 0.7);
    }

    /* çŠ¶æ€é¡µ */
    .status-details-menu {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .status-row-menu {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    /* ç”»å»Šé¡µ */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }

    .gallery-item {
      position: relative;
      cursor: pointer;
      border-radius: 10px;
      overflow: hidden;
      transition: all 0.3s;
    }

    .gallery-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .gallery-thumbnail {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .gallery-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 10px;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }

    .delete-btn {
      padding: 5px 10px;
      background: rgba(255, 0, 0, 0.7);
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
    }

    .delete-btn:hover {
      background: rgba(255, 0, 0, 0.9);
    }

    .close-menu-btn {
      width: 100%;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .close-menu-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* æ¨¡æ€æ¡† */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal-content {
      max-width: 500px;
      width: 100%;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-content h3 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 20px;
    }

    .item-detail {
      text-align: center;
      margin-bottom: 20px;
    }

    .item-icon-large {
      font-size: 80px;
      margin-bottom: 15px;
    }

    .item-name-large {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .item-description {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 15px;
    }

    .item-count-display {
      font-size: 16px;
      color: #ffd43b;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
    }

    .confirm-btn,
    .cancel-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .confirm-btn {
      background: linear-gradient(135deg, #4caf50, #45a049);
      color: #fff;
    }

    .confirm-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
    }

    .confirm-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .cancel-btn {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .cancel-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .error-message {
      margin-top: 15px;
      padding: 10px;
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid rgba(255, 0, 0, 0.5);
      border-radius: 8px;
      color: #ff6b6b;
      font-size: 14px;
      text-align: center;
    }

    /* å›¾ç‰‡æŸ¥çœ‹å™¨ */
    .image-viewer {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 20px;
    }

    .image-viewer-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }

    .viewed-image {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 10px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .image-viewer-info {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      font-size: 14px;
    }

    .image-viewer-info p {
      margin-bottom: 8px;
    }

    .image-viewer-info strong {
      color: #4caf50;
    }

    .close-viewer-btn {
      position: absolute;
      top: -40px;
      right: 0;
      width: 40px;
      height: 40px;
      background: rgba(255, 0, 0, 0.7);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .close-viewer-btn:hover {
      background: rgba(255, 0, 0, 0.9);
      transform: scale(1.1);
    }

    /* å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .status-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .player-stats {
        max-width: 100%;
      }

      .scene-image {
        height: 250px;
      }

      .skills-list {
        grid-template-columns: 1fr;
      }

      .inventory-grid-menu {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* è‡ªå®šä¹‰å†…å®¹ç®¡ç†é¡µ */
    .custom-section {
      margin-bottom: 30px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
    }

    .custom-section h4 {
      margin-bottom: 15px;
      font-size: 16px;
      color: #4caf50;
    }

    .custom-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .custom-item {
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .custom-item-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .custom-icon {
      font-size: 24px;
    }

    .custom-name {
      font-weight: bold;
      font-size: 16px;
    }

    .custom-id {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
    }

    .custom-item-info {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 8px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
    }

    .custom-item-desc {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 10px;
    }

    .delete-custom-btn {
      padding: 6px 12px;
      background: rgba(255, 0, 0, 0.3);
      border: 1px solid rgba(255, 0, 0, 0.5);
      border-radius: 6px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .delete-custom-btn:hover {
      background: rgba(255, 0, 0, 0.5);
    }

    .danger-btn {
      width: 100%;
      padding: 12px;
      background: rgba(255, 0, 0, 0.3);
      border: 2px solid rgba(255, 0, 0, 0.5);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .danger-btn:hover {
      background: rgba(255, 0, 0, 0.5);
      transform: translateY(-2px);
    }
/* ========== å†’é™©è€…å…¬ä¼šUIæ ·å¼ï¼ˆæ–°å¢ï¼‰========== */

/* å…¬ä¼šè¦†ç›–å±‚ */
.guild-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(5px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1500;
  padding: 20px;
  overflow-y: auto;
}

.guild-panel {
  max-width: 900px;
  width: 100%;
  max-height: 90vh;
  background: rgba(0, 0, 0, 0.95);
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  display: flex;
  flex-direction: column;
  gap: 20px;
  overflow-y: auto;
}

.guild-panel h2 {
  text-align: center;
  font-size: 28px;
  margin-bottom: 10px;
  color: #f39c12;
}

/* å†’é™©è€…ç­‰çº§å±•ç¤º */
.adventurer-rank-display {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  border: 2px solid rgba(255, 255, 255, 0.1);
}

.rank-badge {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
  flex-shrink: 0;
}

.rank-letter {
  font-size: 48px;
  font-weight: bold;
  color: #fff;
  text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
}

.rank-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.rank-name {
  font-size: 20px;
  font-weight: bold;
}

.rank-exp-bar {
  display: flex;
  align-items: center;
  gap: 10px;
}

.rank-exp-bar .bar {
  flex: 1;
  height: 20px;
}

.rank-exp-text {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.7);
  min-width: 100px;
  text-align: right;
}

/* å½“å‰ä»»åŠ¡åŒºåŸŸ */
.current-quest-section {
  animation: fadeIn 0.3s;
}

.current-quest-section h3 {
  margin-bottom: 15px;
  font-size: 20px;
  color: #4caf50;
}

/* ä»»åŠ¡å¡ç‰‡ */
.quest-card {
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s;
}

.quest-card:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: #f39c12;
  transform: translateY(-2px);
}

.quest-card.active {
  border-color: #4caf50;
  cursor: default;
}

.quest-card.active:hover {
  transform: none;
}

.quest-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}

.quest-type-icon {
  font-size: 24px;
}

.quest-title {
  flex: 1;
  font-size: 18px;
  font-weight: bold;
}

.quest-rank-badge {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: bold;
  color: #fff;
}

.quest-description {
  font-size: 14px;
  line-height: 1.6;
  color: rgba(255, 255, 255, 0.8);
  margin-bottom: 12px;
}

.quest-brief {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.7);
  margin-bottom: 10px;
}

.quest-guide {
  padding: 10px;
  background: rgba(255, 255, 255, 0.03);
  border-left: 3px solid #4caf50;
  border-radius: 4px;
  font-size: 13px;
  margin-bottom: 12px;
}

.quest-rewards {
  display: flex;
  gap: 20px;
  font-size: 14px;
  color: #ffd43b;
}

/* ä»»åŠ¡çŠ¶æ€æŒ‰é’® */
.quest-status-buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.status-btn {
  flex: 1;
  padding: 10px;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  color: #fff;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 14px;
}

.status-btn:hover {
  background: rgba(255, 255, 255, 0.1);
}

.status-btn.active {
  background: rgba(76, 175, 80, 0.3);
  border-color: #4caf50;
}

.status-btn.abandon {
  background: rgba(255, 0, 0, 0.1);
  border-color: rgba(255, 0, 0, 0.3);
}

.status-btn.abandon:hover {
  background: rgba(255, 0, 0, 0.2);
}

.submit-quest-btn {
  width: 100%;
  padding: 12px;
  margin-top: 15px;
  background: linear-gradient(135deg, #4caf50, #45a049);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.submit-quest-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
}

.submit-quest-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* å¯æ¥å–ä»»åŠ¡åŒºåŸŸ */
.available-quests-section {
  animation: fadeIn 0.3s;
}

.quest-list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.quest-list-header h3 {
  font-size: 20px;
  color: #4caf50;
}

.quest-actions {
  display: flex;
  gap: 10px;
}

.action-btn-small {
  padding: 8px 16px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
}

.action-btn-small:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.action-btn-small:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.quest-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 400px;
  overflow-y: auto;
}

.close-guild-btn {
  width: 100%;
  padding: 15px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s;
}

.close-guild-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* ä»»åŠ¡è®°å½•æ ·å¼ */
.quest-record-section {
  margin-bottom: 20px;
}

.quest-record-section h4 {
  margin-bottom: 10px;
  font-size: 16px;
  color: #4caf50;
}

.quest-record-card {
  padding: 15px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  margin-bottom: 10px;
}

.quest-record-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
  font-size: 16px;
  font-weight: bold;
}

.quest-record-status {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.7);
}

.quest-record-rewards {
  font-size: 13px;
  color: #ffd43b;
}

.quest-history-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 300px;
  overflow-y: auto;
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
  .guild-panel {
    padding: 20px;
  }

  .adventurer-rank-display {
    flex-direction: column;
    text-align: center;
  }

  .rank-badge {
    width: 60px;
    height: 60px;
  }

  .rank-letter {
    font-size: 36px;
  }

  .quest-status-buttons {
    flex-direction: column;
  }

  .quest-actions {
    flex-direction: column;
    width: 100%;
  }

  .action-btn-small {
    width: 100%;
  }
}

  </style>

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>

</html>